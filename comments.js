// comments.js
import { collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
export function initComments(db){const modal=document.getElementById('comment-modal');const openBtn=document.getElementById('open-comment-modal');const closeBtn=document.getElementById('close-comment-modal');const submitBtn=document.getElementById('submit-comment-btn');const listContainer=document.getElementById('comments-list-container');const nameInput=document.getElementById('comment-username');const msgInput=document.getElementById('comment-message');const toggle=(show)=>{if(!modal)return;if(show){modal.classList.remove('hidden');setTimeout(()=>{modal.classList.remove('opacity-0','pointer-events-none');modal.querySelector('div').classList.remove('scale-90');},10);}else{modal.querySelector('div').classList.add('scale-90');modal.classList.add('opacity-0');setTimeout(()=>{modal.classList.add('pointer-events-none');modal.classList.add('hidden');},300);}};if(openBtn)openBtn.onclick=()=>toggle(true);if(closeBtn)closeBtn.onclick=()=>toggle(false);if(submitBtn){submitBtn.onclick=async()=>{const username=nameInput.value.trim();const message=msgInput.value.trim();if(!username||!message){alert("Please enter name and message.");return;}submitBtn.disabled=true;submitBtn.innerText="Sending...";try{await addDoc(collection(db,"comments"),{username,message,timestamp:serverTimestamp()});msgInput.value="";submitBtn.innerText="Sent!";setTimeout(()=>{submitBtn.disabled=false;submitBtn.innerText="Send";},2000);}catch(e){console.error("Error sending comment",e);submitBtn.innerText="Error";submitBtn.disabled=false;}};}const q=query(collection(db,"comments"),orderBy("timestamp","desc"),limit(50));onSnapshot(q,(snapshot)=>{if(!listContainer)return;if(snapshot.empty){listContainer.innerHTML='<p class="text-center text-gray-500 text-xs">No comments yet.</p>';return;}listContainer.innerHTML="";snapshot.forEach(doc=>{const data=doc.data();const el=document.createElement('div');el.className="p-3 mb-2 rounded-lg bg-black bg-opacity-20 border border-gray-700";el.innerHTML=`<p class="font-bold text-primary-app text-xs">${escapeHtml(data.username)}</p><p class="text-gray-300 text-sm">${escapeHtml(data.message)}</p>`;listContainer.appendChild(el);});});}
function escapeHtml(text){if(!text)return"";return text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");}
