<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Follow Me (Rewritten v7 - Full Shortcuts)</title>
    
    <meta name="theme-color" content="#4f46e5">
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/4f46e5/ffffff?text=F&font=inter">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class', // Enable class-based dark mode
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-app': '#4f46e5', // Indigo
                        'secondary-app': '#6366f1',
                        'accent-app': '#a5b4fc',
                        'btn-control-red': '#dc2626', 
                        'btn-control-red-active': '#b91c1c',
                        'btn-control-blue': '#2563eb', 
                        'btn-control-blue-active': '#1e40af',
                        'btn-control-green': '#10b981', 
                    }
                }
            }
        }
    </script>
    
    <link rel="stylesheet" href="styles.css">
    
</head>
<body class="dark min-h-screen flex flex-col font-sans p-4">

    <div id="game-setup-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[60] transition-opacity duration-300 opacity-0 pointer-events-none">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-lg w-full transform scale-90 transition-transform duration-300 text-gray-900 dark:text-white max-h-[90vh] flex flex-col relative">
            
            <h3 class="text-2xl font-bold mb-4 text-center border-b dark:border-gray-700 pb-3">üëã Quick Start</h3>
            
            <div class="overflow-y-auto py-4 px-1">
                <p class="text-gray-700 dark:text-gray-300 mb-6 text-center">Select a configuration to get started.</p>

                <div class="mb-6">
                    <label for="config-select" class="block text-gray-700 dark:text-gray-300 text-lg font-semibold mb-2">1. Setting Configuration</label>
                    <select id="config-select" class="select-input w-full h-12 px-4 py-2 text-lg font-semibold">
                        </select>
                </div>
                
                <div class="flex justify-center space-x-3 mb-8">
                    <button id="config-add" class="px-4 py-2 text-sm text-white bg-btn-control-blue rounded-lg hover:bg-btn-control-blue-active transition-colors font-semibold">New</button>
                    <button id="config-rename" class="px-4 py-2 text-sm text-gray-700 dark:text-gray-200 bg-gray-200 dark:bg-gray-600 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors font-semibold">Rename</button>
                    <button id="config-delete" class="px-4 py-2 text-sm text-white bg-btn-control-red rounded-lg hover:bg-btn-control-red-active transition-colors font-semibold">Delete</button>
                </div>

                <div class="mb-8 grid grid-cols-2 gap-6">
                    <div class="flex items-center justify-between">
                        <label for="quick-autoplay-toggle" class="text-gray-700 dark:text-gray-300 text-lg font-semibold">
                            Autoplay
                        </label>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="quick-autoplay-toggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-app/50 dark:peer-focus:ring-primary-app rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary-app"></div>
                        </label>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <label for="quick-audio-toggle" class="text-gray-700 dark:text-gray-300 text-lg font-semibold">
                            Audio
                        </label>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="quick-audio-toggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-app/50 dark:peer-focus:ring-primary-app rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary-app"></div>
                        </label>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-6">
                     <button id="quick-open-help" class="w-full px-6 py-3 text-white bg-gray-500 rounded-lg hover:bg-gray-600 transition-colors font-semibold text-lg flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path></svg>
                        Help
                    </button>
                     <button id="quick-open-settings" class="w-full px-6 py-3 text-white bg-gray-500 rounded-lg hover:bg-gray-600 transition-colors font-semibold text-lg flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01-.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" /></svg>
                        Settings
                    </button>
                </div>
                
                <div class="absolute top-6 left-6 z-10">
                    <label class="block text-center text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Resize</label>
                    <div class="flex space-x-2">
                        <button id="global-resize-down" class="px-3 py-1 bg-gray-200 dark:bg-gray-600 rounded-md text-lg font-bold hover:bg-gray-300 dark:hover:bg-gray-500">-</button>
                        <button id="global-resize-up" class="px-3 py-1 bg-gray-200 dark:bg-gray-600 rounded-md text-lg font-bold hover:bg-gray-300 dark:hover:bg-gray-500">+</button>
                    </div>
                </div>
            </div>

            <div class="flex justify-between items-center pt-4 border-t dark:border-gray-700">
                <label for="dont-show-welcome-toggle" class="flex items-center text-sm text-gray-600 dark:text-gray-400 cursor-pointer">
                    <input type="checkbox" id="dont-show-welcome-toggle" class="mr-2 h-4 w-4 rounded text-primary-app focus:ring-primary-app">
                    Don't show this again
                </label>
                <button id="close-game-setup-modal" class="px-6 py-2 text-white bg-primary-app rounded-lg hover:bg-secondary-app transition-colors font-semibold">Get Started!</button>
            </div>
        </div>
    </div>

    <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full transform scale-90 transition-transform duration-300">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-gray-900 dark:text-white"></h3>
            <p id="modal-message" class="text-gray-700 dark:text-gray-300 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel" class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors"></button>
                <button id="modal-confirm" class="px-4 py-2 text-white bg-primary-app rounded-lg hover:bg-secondary-app transition-colors"></button>
            </div>
        </div>
    </div>
    
    <div id="share-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full transform scale-90 transition-transform duration-300 text-center">
            <h3 class="text-xl font-bold mb-4 text-gray-900 dark:text-white">Share This App</h3>
            <p class="text-gray-700 dark:text-gray-300 mb-4">Scan the code to open this app on another device.</p>
            <img src="https://placehold.co/256x256/ffffff/1f2937?text=QR+Code&font=inter" alt="Share QR Code" class="w-64 h-64 mx-auto rounded-lg mb-6 border-4 border-white dark:border-gray-700">
            
            <div class="flex flex-col space-y-3 mb-6">
                <button id="native-share-button" data-action="native-share" class="hidden w-full px-6 py-3 text-white bg-primary-app rounded-lg hover:bg-secondary-app transition-colors font-semibold text-lg flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z"></path></svg>
                    Share...
                </button>
                <button id="copy-link-button" data-action="copy-link" class="w-full px-6 py-3 text-white bg-btn-control-blue rounded-lg hover:bg-btn-control-blue-active transition-colors font-semibold text-lg flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 011-1z"></path><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"></path></svg>
                    Copy Link
                </button>
            </div>
            <button id="close-share" class="w-full px-6 py-2 text-gray-700 dark:text-gray-200 bg-gray-200 dark:bg-gray-600 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors font-semibold">Close</button>
        </div>
    </div>
    
    <div id="settings-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full m-4 transform scale-90 transition-transform duration-300 flex flex-col max-h-[90vh] overflow-hidden">
            
            <div class="p-6 pb-0 relative">
                <h3 class="text-2xl font-bold text-gray-900 dark:text-white pb-3">App Preferences ‚öôÔ∏è</h3>
                <button id="open-share-button" data-action="open-share" class="absolute top-4 right-16 text-gray-700 dark:text-gray-300 hover:text-primary-app dark:hover:text-primary-app transition-colors text-2xl font-bold focus:outline-none" title="Share App">
                    üì§
                </button>
                <button id="open-help-button" data-action="open-help" class="absolute top-4 right-4 text-gray-700 dark:text-gray-300 hover:text-primary-app dark:hover:text-primary-app transition-colors text-2xl font-bold focus:outline-none" title="View Help & Instructions">
                    ‚ùì
                </button>
                
                <div class="border-b border-gray-200 dark:border-gray-700">
                    <nav id="settings-tab-nav" class="flex space-x-2">
                        <button data-tab="profile" class="tab-button active-tab">Profile</button>
                        <button data-tab="global" class="tab-button">Global</button>
                        <button data-tab="shortcuts" class="tab-button">Shortcuts</button>
                        <button data-tab="stealth" class="tab-button">Stealth</button>
                    </nav>
                </div>
            </div>

            <div class="overflow-y-auto flex-grow content-container">
                
                <div id="settings-tab-profile" class="settings-tab-content p-6">
                    <button id="open-game-setup-from-settings" class="w-full px-6 py-3 text-white bg-primary-app rounded-lg hover:bg-secondary-app transition-colors font-semibold text-lg mb-6">
                        Manage Configurations
                    </button>
                
                    <h4 class="text-xl font-bold mb-4 text-gray-900 dark:text-white">Active Profile Settings</h4>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-6 -mt-4">These settings are saved to your active profile (<span id="active-profile-name" class="font-bold"></span>).</p>
                    
                    <div class="mb-6 grid grid-cols-1 gap-6">
                        <div>
                            <label for="input-select" class="block text-gray-700 dark:text-gray-300 text-lg font-semibold mb-2">1. Input Type</label>
                            <select id="input-select" class="select-input w-full h-12 px-4 py-2 text-lg font-semibold">
                                <option value="key9">9-Key</option>
                                <option value="key12">12-Key</option>
                                <option value="piano">Piano</option>
                            </select>
                        </div>
                        
                        <div class="flex items-center justify-between mb-0">
                            <label for="mode-toggle" class="text-gray-700 dark:text-gray-300 text-lg font-semibold">
                                2. Game Mode
                                <span id="mode-toggle-label" class="block text-sm font-normal text-gray-500 dark:text-gray-400">Off: Simon Says</span>
                            </label>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="mode-toggle" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-app/50 dark:peer-focus:ring-primary-app rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary-app"></div>
                            </label>
                        </div>
                    </div>

                    <div class="mb-6">
                        <label for="machines-slider" class="block text-gray-700 dark:text-gray-300 text-lg font-semibold mb-2">3. Machines</label>
                        <div class="flex items-center space-x-2">
                            <input type="range" id="machines-slider" min="1" max="4" value="1" step="1" class="w-full">
                            <span id="machines-display" class="text-sm text-gray-500 dark:text-gray-400 w-32 text-center">1 Machine</span>
                        </div>
                    </div>

                    <div class="mb-6">
                        <label id="sequence-length-label" for="sequence-length-slider" class="block text-gray-700 dark:text-gray-300 text-lg font-semibold mb-2">4. Sequence Length</label>
                         <div class="flex items-center space-x-2">
                            <input type="range" id="sequence-length-slider" min="15" max="25" value="20" step="5" class="w-full">
                            <span id="sequence-length-display" class="text-sm text-gray-500 dark:text-gray-400 w-32 text-center">20</span>
                        </div>
                    </div>
                    
                    <div id="setting-multi-sequence-group" class="mb-6 pt-4 border-t border-gray-200 dark:border-gray-700" style="display: none;">
                        <p class="block text-gray-700 dark:text-gray-300 text-xl font-bold mb-4">Multi-Sequence Options</p>
                        <div class="mb-6">
                            <label for="chunk-slider" class="block text-gray-700 dark:text-gray-300 text-lg font-semibold mb-2">Numbers per Sequence</label>
                            <div class="flex items-center space-x-2">
                                <input type="range" id="chunk-slider" min="2" max="5" value="3" step="1" class="w-full">
                                <span id="chunk-display" class="text-sm text-gray-500 dark:text-gray-400 w-32 text-center">3</span>
                            </div>
                        </div>
                        <div class="mb-6">
                            <label for="delay-slider" class="block text-gray-700 dark:text-gray-300 text-lg font-semibold mb-2">Delay Between Sequences</label>
                            <div class="flex items-center space-x-2">
                                <input type="range" id="delay-slider" min="0" max="1000" value="500" step="100" class="w-full">
                                <span id="delay-display" class="text-sm text-gray-500 dark:text-gray-400 w-32 text-center">0.5s</span>
                            </div>
                        </div>
                    </div>

                    <div id="setting-autoclear" class="flex items-center justify-between mb-6" style="display: none;">
                        <label for="autoclear-toggle" class="text-gray-700 dark:text-gray-300 text-lg font-semibold">Auto Clear/Advance</label>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="autoclear-toggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-app/50 dark:peer-focus:ring-primary-app rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary-app"></div>
                        </label>
                    </div>
                </div>
                
                <div id="settings-tab-global" class="settings-tab-content p-6 hidden">
                    <h4 class="text-xl font-bold mb-4 text-gray-900 dark:text-white">Global App Settings</h4>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-6 -mt-4">These settings affect the entire app, regardless of profile.</p>

                    <div class="mb-6">
                        <label for="ui-scale-slider" class="block text-gray-700 dark:text-gray-300 text-lg font-semibold mb-2">Sequence Size (Profile)</label>
                        <div class="flex items-center space-x-2">
                             <input type="range" id="ui-scale-slider" min="50" max="200" value="100" class="w-full">
                             <span id="ui-scale-display" class="text-sm text-gray-500 dark:text-gray-400 w-32 text-center">100%</span>
                        </div>
                    </div>

                    <label for="playback-speed-slider" class="block text-gray-700 dark:text-gray-300 text-lg font-semibold mb-2">Playback Speed (Global)</label>
                     <div class="flex items-center space-x-2">
                        <input type="range" id="playback-speed-slider" min="50" max="150" value="100" step="10" class="w-full">
                        <span id="playback-speed-display" class="text-sm text-gray-500 dark:text-gray-400 w-32 text-center">100%</span>
                    </div>
                    
                    <div class="mb-6 pt-4 border-t border-gray-200 dark:border-gray-700 mt-6">
                        <div class="flex items-center justify-between mb-6">
                            <label for="show-welcome-toggle" class="text-gray-700 dark:text-gray-300 text-lg font-semibold">Show Setup on Start</label>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="show-welcome-toggle" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-app/50 dark:peer-focus:ring-primary-app rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary-app"></div>
                            </label>
                        </div>
                        
                        <div class="flex items-center justify-between mb-6">
                            <label for="dark-mode-toggle" class="text-gray-700 dark:text-gray-300 text-lg font-semibold">Dark Mode</label>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="dark-mode-toggle" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-app/50 dark:peer-focus:ring-primary-app rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary-app"></div>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div id="settings-tab-shortcuts" class="settings-tab-content p-6 hidden">
                    <h4 class="text-xl font-bold mb-4 text-gray-900 dark:text-white">Shortcut Command Center</h4>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-6 -mt-4">Map triggers to actions. Saved per-profile.</p>

                    <div class="mb-6">
                        <label for="shake-sensitivity-slider" class="block text-gray-700 dark:text-gray-300 text-lg font-semibold mb-2">Shake Sensitivity</label>
                        <div class="flex items-center space-x-2">
                             <input type="range" id="shake-sensitivity-slider" min="1" max="20" value="10" class="w-full">
                             <span id="shake-sensitivity-display" class="text-sm text-gray-500 dark:text-gray-400 w-32 text-center">10</span>
                        </div>
                    </div>
                    
                    <div id="shortcut-list-container" class="mb-4">
                        </div>
                    
                    <button id="add-shortcut-btn" class="w-full px-6 py-2 text-white bg-btn-control-blue rounded-lg hover:bg-btn-control-blue-active transition-colors font-semibold">
                        Add Shortcut
                    </button>
                </div>

                <div id="settings-tab-stealth" class="settings-tab-content p-6 hidden">
                    <h4 class="text-xl font-bold mb-4 text-gray-900 dark:text-white">Stealth Features</h4>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-6 -mt-4">Configure discreet inputs and outputs.</p>
                    
                    <div class="mb-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                        <h4 class="text-xl font-bold mb-4 text-gray-900 dark:text-white">Profile Toggles</h4>
                        <div class="flex items-center justify-between mb-6">
                            <label for="autoplay-toggle" class="text-gray-700 dark:text-gray-300 text-lg font-semibold">Autoplay</label>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="autoplay-toggle" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-app/50 dark:peer-focus:ring-primary-app rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary-app"></div>
                            </label>
                        </div>
                        <div class="flex items-center justify-between mb-6">
                            <label for="speed-delete-toggle" class="text-gray-700 dark:text-gray-300 text-lg font-semibold">Speed Deleting</label>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="speed-delete-toggle" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-app/50 dark:peer-focus:ring-primary-app rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary-app"></div>
                            </label>
                        </div>
                        <div class="flex items-center justify-between mb-6">
                            <label for="audio-toggle" class="text-gray-700 dark:text-gray-300 text-lg font-semibold">Audio (Speak)</label>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="audio-toggle" class="sr-only peer"> 
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-app/50 dark:peer-focus:ring-primary-app rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary-app"></div>
                            </label>
                        </div>
                        <div class="flex items-center justify-between mb-6">
                            <label for="voice-input-toggle" class="text-gray-700 dark:text-gray-300 text-lg font-semibold">Voice Input (Keyboard)</label>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="voice-input-toggle" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-app/50 dark:peer-focus:ring-primary-app rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary-app"></div>
                            </label>
                        </div>
                        <div class="flex items-center justify-between mb-6">
                            <label for="haptics-toggle" class="text-gray-700 dark:text-gray-300 text-lg font-semibold">Vibration (Haptics)</label>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="haptics-toggle" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-app/50 dark:peer-focus:ring-primary-app rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary-app"></div>
                            </label>
                        </div>
                    </div>

                    <div class="flex items-center justify-between mb-6 opacity-50 pt-4 border-t border-gray-200 dark:border-gray-700">
                        <label for="haptic-playback-toggle" class="text-gray-700 dark:text-gray-300 text-lg font-semibold">Haptic Playback
                           <span class="block text-sm font-normal text-gray-500 dark:text-gray-400"> (Coming Soon)</span>
                        </label>
                        <label class="relative inline-flex items-center cursor-not-allowed">
                            <input type="checkbox" id="haptic-playback-toggle" class="sr-only peer" disabled>
                            <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600"></div>
                        </label>
                    </div>
                    
                    <div class="mb-6 opacity-50">
                        <label class="block text-gray-700 dark:text-gray-300 text-lg font-semibold mb-2">"Boss Screen" Mode
                           <span class="text-sm font-normal text-gray-500 dark:text-gray-400"> (Coming Soon)</span>
                        </label>
                        <select class="select-input w-full" disabled>
                            <option>Disabled</option>
                            <option>Show Lock Screen</option>
                            <option>Show Blank Screen</option>
                        </select>
                    </div>
                    
                    <h4 class="text-xl font-bold mb-4 text-gray-900 dark:text-white opacity-50">Automatic Inputs (Planned)</h4>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-4 opacity-50">These will require browser permissions and training.</p>
                    
                    <button class="w-full px-6 py-2 text-white bg-gray-500 rounded-lg transition-colors font-semibold mb-3 opacity-50 cursor-not-allowed" disabled>
                        Configure Mic (Tone Input)
                    </button>
                    <button class="w-full px-6 py-2 text-white bg-gray-500 rounded-lg transition-colors font-semibold opacity-50 cursor-not-allowed" disabled>
                        Configure Camera (Pattern Input)
                    </button>
                </div>
            </div>
            
            <div class="p-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                <div class="flex justify-between">
                    <button data-action="restore-defaults" class="px-6 py-2 text-white bg-btn-control-red rounded-lg hover:bg-btn-control-red-active transition-colors font-semibold">Restore Defaults</button>
                    <button id="close-settings" class="px-6 py-2 text-white bg-gray-500 rounded-lg hover:bg-gray-600 transition-colors font-semibold">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="help-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-lg w-full m-4 transform scale-90 transition-transform duration-300 flex flex-col max-h-[90vh] overflow-hidden">
            <div class="p-6 pb-0">
                <h3 class="text-2xl font-bold text-gray-900 dark:text-white pb-3">Application Instructions & Help üìö</h3>
            </div>
            <div class="px-6 border-b border-gray-200 dark:border-gray-700">
                <nav id="help-tab-nav" class="flex space-x-2 overflow-x-auto">
                    <button data-tab="general" class="tab-button active-tab">General</button>
                    <button data-tab="modes" class="tab-button">Modes</button>
                    <button data-tab="prompts" class="tab-button">Prompts</button>
                    <button data-tab="shortcuts" class="tab-button">Shortcuts</button>
                </nav>
            </div>
            <div class="p-6 pt-4 overflow-y-auto flex-grow content-container" id="help-content-container">
                <div id="help-tab-general" class="help-tab-content"></div>
                <div id="help-tab-modes" class="help-tab-content hidden"></div>
                
                <div id="help-tab-prompts" class="help-tab-content hidden">
                    <div id="virtual-assistant-prompts" class="hidden">
                        <h4 class="text-primary-app">Virtual Assistant Prompts</h4>
                        <p>Use these prompts with a voice assistant. They are generated based on your active configuration. **Closing this window while on this tab will automatically copy the active prompt.**</p>
                        
                        <div id="prompt-simon-group">
                            <label for="prompt-simon" class="font-bold text-gray-900 dark:text-white">Simon Says Prompt</label>
                            <textarea id="prompt-simon" class="prompt-box" readonly></textarea>
                            <button class="copy-button" data-copy-target="prompt-simon">üìã <span class="ml-2">Copy</span></button>
                        </div>
                        
                        <div id="prompt-unique-rounds-group">
                            <label for="prompt-unique-rounds" class="font-bold text-gray-900 dark:text-white">Unique Rounds Mode Prompt</label>
                            <textarea id="prompt-unique-rounds" class="prompt-box" readonly></textarea>
                            <button class="copy-button" data-copy-target="prompt-unique-rounds">üìã <span class="ml-2">Copy</span></button>
                        </div>
                    </div>
                </div>
                
                <div id="help-tab-shortcuts" class="help-tab-content hidden">
                    <h4 class="text-primary-app">Shortcut Command Center</h4>
                    <p>The "Shortcuts" tab in the main **Settings (‚öôÔ∏è)** menu allows you to map **Triggers** (like "Shake") to **Actions** (like "Reset Rounds").</p>
                    <p>These shortcuts are saved **per-profile**, so you can have different shortcuts for different setups.</p>
                    
                    <h4>Available Triggers</h4>
                    <ul>
                        <li>**Shake:** (Experimental) Uses your phone's accelerometer. You can adjust the sensitivity in the Shortcuts tab.</li>
                        <li>**Long Press Backspace:** Replaces the old hard-coded behavior.</li>
                        <li>...and many more (swipes, tilts, etc.).</li>
                    </ul>
                    
                    <h4>Available Actions</h4>
                    <ul>
                        <li>Play Demo</li>
                        <li>Reset Rounds</li>
                        <li>Clear All</li>
                        <li>Clear Last</li>
                        <li>Toggle Autoplay / Audio / Haptics / Dark Mode</li>
                        <li>Open/Close Settings or Help</li>
                        <li>Switch to Next/Previous Profile</li>
                    </ul>
                </div>

            </div>
            <div class="p-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                <div class="flex justify-end">
                    <button id="close-help" class="px-6 py-2 text-white bg-primary-app rounded-lg hover:bg-secondary-app transition-colors font-semibold">Got it!</button>
                </div>
            </div>
        </div>
    </div>

    <div id="app" class="max-w-7xl w-full mx-auto flex flex-col flex-grow">
        
        <main id="sequence-container" class="flex-grow mb-6 transition-all duration-300 pt-1">
            </main>

        <footer id="input-footer" class="sticky bottom-0 left-0 right-0 p-4 rounded-xl shadow-2xl border-t-4 border-primary-app">
                               
            <div id="pad-key9" class="max-w-xs mx-auto">
                <div class="grid grid-cols-3 gap-3 mb-3">
                    <button data-value="1" data-input="key9" class="btn-input btn-pad-number">1</button>
                    <button data-value="2" data-input="key9" class="btn-input btn-pad-number">2</button>
                    <button data-value="3" data-input="key9" class="btn-input btn-pad-number">3</button>
                    <button data-value="4" data-input="key9" class="btn-input btn-pad-number">4</button>
                    <button data-value="5" data-input="key9" class="btn-input btn-pad-number">5</button>
                    <button data-value="6" data-input="key9" class="btn-input btn-pad-number">6</button>
                    <button data-value="7" data-input="key9" class="btn-input btn-pad-number">7</button>
                    <button data-value="8" data-input="key9" class="btn-input btn-pad-number">8</button>
                    <button data-value="9" data-input="key9" class="btn-input btn-pad-number">9</button>
                </div>
                <div class="grid grid-cols-5 gap-3">
                    <button data-action="play-demo" data-input="key9" class="btn-input btn-control !bg-primary-app hover:!bg-secondary-app text-2xl">‚ñ∂</button> 
                    <button data-action="reset-unique-rounds" data-input="key9" class="reset-button btn-input btn-control !bg-btn-control-red hover:!bg-btn-control-red-active text-white font-bold rounded-xl text-xl" style="display: none;">
                        RESET
                    </button> 
                    <input type="text" data-input="key9" class="voice-text-input btn-input !bg-primary-app !text-white !text-center !text-2xl !px-0 hidden" placeholder="üé§" title="Keyboard Voice Input">
                    <button data-action="backspace" data-input="key9" class="btn-input btn-control text-2xl">&larr;</button>
                    <button data-action="open-settings" data-input="key9" class="btn-input btn-control !bg-primary-app hover:!bg-secondary-app text-2xl">‚öôÔ∏è</button>
                </div>
            </div>

            <div id="pad-key12" class="max-w-md mx-auto" style="display: none;">
                <div class="grid grid-cols-4 gap-3 mb-3">
                    <button data-value="1" data-input="key12" class="btn-input btn-pad-number">1</button>
                    <button data-value="2" data-input="key12" class="btn-input btn-pad-number">2</button>
                    <button data-value="3" data-input="key12" class="btn-input btn-pad-number">3</button>
                    <button data-value="4" data-input="key12" class="btn-input btn-pad-number">4</button>
                    <button data-value="5" data-input="key12" class="btn-input btn-pad-number">5</button>
                    <button data-value="6" data-input="key12" class="btn-input btn-pad-number">6</button>
                    <button data-value="7" data-input="key12" class="btn-input btn-pad-number">7</button>
                    <button data-value="8" data-input="key12" class="btn-input btn-pad-number">8</button>
                    <button data-value="9" data-input="key12" class="btn-input btn-pad-number">9</button>
                    <button data-value="10" data-input="key12" class="btn-input btn-pad-number">10</button>
                    <button data-value="11" data-input="key12" class="btn-input btn-pad-number">11</button>
                    <button data-value="12" data-input="key12" class="btn-input btn-pad-number">12</button>
                </div>
                <div class="grid grid-cols-5 gap-3">
                    <button data-action="play-demo" data-input="key12" class="btn-input btn-control !bg-primary-app hover:!bg-secondary-app text-white font-bold rounded-xl text-2xl">‚ñ∂</button>
                    <button data-action="reset-unique-rounds" data-input="key12" class="reset-button btn-input btn-control !bg-btn-control-red hover:!bg-btn-control-red-active text-white font-bold rounded-xl text-xl" style="display: none;">
                        RESET
                    </button> 
                    <input type="text" data-input="key12" class="voice-text-input btn-input !bg-primary-app !text-white !text-center !text-2xl !px-0 hidden" placeholder="üé§" title="Keyboard Voice Input">
                    <button data-action="backspace" data-input="key12" class="btn-input btn-control text-2xl">&larr;</button>
                    <button data-action="open-settings" data-input="key12" class="btn-input btn-control !bg-primary-app hover:!bg-secondary-app text-2xl">‚öôÔ∏è</button>
                </div>
            </div>

            <div id="pad-piano" class="max-w-xl mx-auto pt-0 pb-4" style="display: none;">
                <div id="piano-keys" class="relative h-48 w-full bg-gray-200 rounded-md shadow-inner overflow-hidden mb-4">
                    <div class="flex h-full w-full">
                        <div class="key-container"><button data-value="C" data-input="piano" class="piano-key-white btn-input">C</button></div>
                        <div class="key-container"><button data-value="D" data-input="piano" class="piano-key-white btn-input">D</button></div>
                        <div class="key-container"><button data-value="E" data-input="piano" class="piano-key-white btn-input">E</button></div>
                        <div class="key-container"><button data-value="F" data-input="piano" class="piano-key-white btn-input">F</button></div>
                        <div class="key-container"><button data-value="G" data-input="piano" class="piano-key-white btn-input">G</button></div>
                        <div class="key-container"><button data-value="A" data-input="piano" class="piano-key-white btn-input">A</button></div>
                        <div class="key-container"><button data-value="B" data-input="piano" class="piano-key-white btn-input">B</button></div>
                    </div>
                    <button data-value="1" data-input="piano" class="piano-key-black btn-input black-1">1</button>
                    <button data-value="2" data-input="piano" class="piano-key-black btn-input black-2">2</button>
                    <button data-value="3" data-input="piano" class="piano-key-black btn-input black-3">3</button>
                    <button data-value="4" data-input="piano" class="piano-key-black btn-input black-4">4</button>
                    <button data-value="5" data-input="piano" class="piano-key-black btn-input black-5">5</button>
                </div>
                <div class="grid grid-cols-5 gap-3 max-w-sm mx-auto">
                    <button data-action="play-demo" data-input="piano" class="btn-input btn-control !bg-primary-app hover:!bg-secondary-app text-2xl">‚ñ∂</button>
                    <button data-action="reset-unique-rounds" data-input="piano" class="reset-button btn-input btn-control !bg-btn-control-red hover:!bg-btn-control-red-active text-white font-bold rounded-xl text-xl" style="display: none;">
                        RESET
                    </button> 
                    <input type="text" data-input="piano" class="voice-text-input btn-input !bg-primary-app !text-white !text-center !text-2xl !px-0 hidden" placeholder="üé§" title="Keyboard Voice Input">
                    <button data-action="backspace" data-input="piano" class="btn-input btn-control text-2xl">&larr;</button>
                    <button data-action="open-settings" data-input="piano" class="btn-input btn-control !bg-primary-app hover:!bg-secondary-app text-2xl">‚öôÔ∏è</button>
                </div>
            </div>
            
        </footer>
    </div>
    
    <div id="toast-notification" class="fixed top-20 left-1/2 -translate-x-1/2 bg-primary-app text-white px-6 py-3 rounded-xl shadow-lg z-[99] transition-all duration-300 opacity-0 transform -translate-y-10">
        <span id="toast-message"></span>
    </div>

    <script src="app.js"></script>

</body>
</html>
flow-hidden">
            <div class="p-6 pb-0">
                <h3 class="text-2xl font-bold text-gray-900 dark:text-white pb-3">Application Instructions & Help üìö</h3>
            </div>
            <div class="px-6 border-b border-gray-200 dark:border-gray-700">
                <nav id="help-tab-nav" class="flex space-x-2">
                    <button data-tab="general" class="tab-button active-tab">General</button>
                    <button data-tab="modes" class="tab-button">Modes</button>
                    <button data-tab="prompts" class="tab-button">Prompts</button>
                    <button data-tab="shortcuts" class="tab-button">Shortcuts</button>
                </nav>
            </div>
            <div class="p-6 pt-4 overflow-y-auto flex-grow content-container" id="help-content-container">
                <div id="help-tab-general" class="help-tab-content"></div>
                <div id="help-tab-modes" class="help-tab-content hidden"></div>
                
                <div id="help-tab-prompts" class="help-tab-content hidden">
                    <div id="virtual-assistant-prompts" class="hidden">
                        <h4 class="text-primary-app">Virtual Assistant Prompts</h4>
                        <p>Use these prompts with a voice assistant. They are generated based on your active configuration. **Closing this window while on this tab will automatically copy the active prompt.**</p>
                        
                        <div id="prompt-simon-group">
                            <label for="prompt-simon" class="font-bold text-gray-900 dark:text-white">Simon Says Prompt</label>
                            <textarea id="prompt-simon" class="prompt-box" readonly></textarea>
                            <button class="copy-button" data-copy-target="prompt-simon">üìã <span class="ml-2">Copy</span></button>
                        </div>
                        
                        <div id="prompt-unique-rounds-group">
                            <label for="prompt-unique-rounds" class="font-bold text-gray-900 dark:text-white">Unique Rounds Mode Prompt</label>
                            <textarea id="prompt-unique-rounds" class="prompt-box" readonly></textarea>
                            <button class="copy-button" data-copy-target="prompt-unique-rounds">üìã <span class="ml-2">Copy</span></button>
                        </div>
                    </div>
                </div>
                
                <div id="help-tab-shortcuts" class="help-tab-content hidden">
                    <h4 class="text-primary-app">Shortcut Command Center</h4>
                    <p>The "Shortcuts" tab in the main **Settings (‚öôÔ∏è)** menu allows you to map **Triggers** (like "Shake") to **Actions** (like "Reset Rounds").</p>
                    <p>These shortcuts are saved **per-profile**, so you can have different shortcuts for different setups.</p>
                    
                    <h4>Available Triggers</h4>
                    <ul>
                        <li>**Shake:** (Experimental) Uses your phone's accelerometer. You can adjust the sensitivity in the Shortcuts tab.</li>
                        <li>**Long Press Backspace:** Replaces the old hard-coded behavior.</li>
                    </ul>
                    
                    <h4>Available Actions</h4>
                    <ul>
                        <li>Play Demo</li>
                        <li>Reset Rounds</li>
                        <li>Clear All</li>
                        <li>Toggle Autoplay</li>
                        <li>Toggle Audio</li>
                    </ul>
                </div>

            </div>
            <div class="p-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                <div class="flex justify-end">
                    <button id="close-help" class="px-6 py-2 text-white bg-primary-app rounded-lg hover:bg-secondary-app transition-colors font-semibold">Got it!</button>
                </div>
            </div>
        </div>
    </div>

    <div id="app" class="max-w-7xl w-full mx-auto flex flex-col flex-grow">
        
        <main id="sequence-container" class="flex-grow mb-6 transition-all duration-300 pt-1">
            </main>

        <footer id="input-footer" class="sticky bottom-0 left-0 right-0 p-4 rounded-xl shadow-2xl border-t-4 border-primary-app">
                               
            <div id="pad-key9" class="max-w-xs mx-auto">
                <div class="grid grid-cols-3 gap-3 mb-3">
                    <button data-value="1" data-input="key9" class="btn-input btn-pad-number">1</button>
                    <button data-value="2" data-input="key9" class="btn-input btn-pad-number">2</button>
                    <button data-value="3" data-input="key9" class="btn-input btn-pad-number">3</button>
                    <button data-value="4" data-input="key9" class="btn-input btn-pad-number">4</button>
                    <button data-value="5" data-input="key9" class="btn-input btn-pad-number">5</button>
                    <button data-value="6" data-input="key9" class="btn-input btn-pad-number">6</button>
                    <button data-value="7" data-input="key9" class="btn-input btn-pad-number">7</button>
                    <button data-value="8" data-input="key9" class="btn-input btn-pad-number">8</button>
                    <button data-value="9" data-input="key9" class="btn-input btn-pad-number">9</button>
                </div>
                <div class="grid grid-cols-5 gap-3">
                    <button data-action="play-demo" data-input="key9" class="btn-input btn-control !bg-primary-app hover:!bg-secondary-app text-2xl">‚ñ∂</button> 
                    <button data-action="reset-unique-rounds" data-input="key9" class="reset-button btn-input btn-control !bg-btn-control-red hover:!bg-btn-control-red-active text-white font-bold rounded-xl text-xl" style="display: none;">
                        RESET
                    </button> 
                    <input type="text" data-input="key9" class="voice-text-input btn-input !bg-primary-app !text-white !text-center !text-2xl !px-0 hidden" placeholder="üé§" title="Keyboard Voice Input">
                    <button data-action="backspace" data-input="key9" class="btn-input btn-control text-2xl">&larr;</button>
                    <button data-action="open-settings" data-input="key9" class="btn-input btn-control !bg-primary-app hover:!bg-secondary-app text-2xl">‚öôÔ∏è</button>
                </div>
            </div>

            <div id="pad-key12" class="max-w-md mx-auto" style="display: none;">
                <div class="grid grid-cols-4 gap-3 mb-3">
                    <button data-value="1" data-input="key12" class="btn-input btn-pad-number">1</button>
                    <button data-value="2" data-input="key12" class="btn-input btn-pad-number">2</button>
                    <button data-value="3" data-input="key12" class="btn-input btn-pad-number">3</button>
                    <button data-value="4" data-input="key12" class="btn-input btn-pad-number">4</button>
                    <button data-value="5" data-input="key12" class="btn-input btn-pad-number">5</button>
                    <button data-value="6" data-input="key12" class="btn-input btn-pad-number">6</button>
                    <button data-value="7" data-input="key12" class="btn-input btn-pad-number">7</button>
                    <button data-value="8" data-input="key12" class="btn-input btn-pad-number">8</button>
                    <button data-value="9" data-input="key12" class="btn-input btn-pad-number">9</button>
                    <button data-value="10" data-input="key12" class="btn-input btn-pad-number">10</button>
                    <button data-value="11" data-input="key12" class="btn-input btn-pad-number">11</button>
                    <button data-value="12" data-input="key12" class="btn-input btn-pad-number">12</button>
                </div>
                <div class="grid grid-cols-5 gap-3">
                    <button data-action="play-demo" data-input="key12" class="btn-input btn-control !bg-primary-app hover:!bg-secondary-app text-white font-bold rounded-xl text-2xl">‚ñ∂</button>
                    <button data-action="reset-unique-rounds" data-input="key12" class="reset-button btn-input btn-control !bg-btn-control-red hover:!bg-btn-control-red-active text-white font-bold rounded-xl text-xl" style="display: none;">
                        RESET
                    </button> 
                    <input type="text" data-input="key12" class="voice-text-input btn-input !bg-primary-app !text-white !text-center !text-2xl !px-0 hidden" placeholder="üé§" title="Keyboard Voice Input">
                    <button data-action="backspace" data-input="key12" class="btn-input btn-control text-2xl">&larr;</button>
                    <button data-action="open-settings" data-input="key12" class="btn-input btn-control !bg-primary-app hover:!bg-secondary-app text-2xl">‚öôÔ∏è</button>
                </div>
            </div>

            <div id="pad-piano" class="max-w-xl mx-auto pt-0 pb-4" style="display: none;">
                <div id="piano-keys" class="relative h-48 w-full bg-gray-200 rounded-md shadow-inner overflow-hidden mb-4">
                    <div class="flex h-full w-full">
                        <div class="key-container"><button data-value="C" data-input="piano" class="piano-key-white btn-input">C</button></div>
                        <div class="key-container"><button data-value="D" data-input="piano" class="piano-key-white btn-input">D</button></div>
                        <div class="key-container"><button data-value="E" data-input="piano" class="piano-key-white btn-input">E</button></div>
                        <div class="key-container"><button data-value="F" data-input="piano" class="piano-key-white btn-input">F</button></div>
                        <div class="key-container"><button data-value="G" data-input="piano" class="piano-key-white btn-input">G</button></div>
                        <div class="key-container"><button data-value="A" data-input="piano" class="piano-key-white btn-input">A</button></div>
                        <div class="key-container"><button data-value="B" data-input="piano" class="piano-key-white btn-input">B</button></div>
                    </div>
                    <button data-value="1" data-input="piano" class="piano-key-black btn-input black-1">1</button>
                    <button data-value="2" data-input="piano" class="piano-key-black btn-input black-2">2</button>
                    <button data-value="3" data-input="piano" class="piano-key-black btn-input black-3">3</button>
                    <button data-value="4" data-input="piano" class="piano-key-black btn-input black-4">4</button>
                    <button data-value="5" data-input="piano" class="piano-key-black btn-input black-5">5</button>
                </div>
                <div class="grid grid-cols-5 gap-3 max-w-sm mx-auto">
                    <button data-action="play-demo" data-input="piano" class="btn-input btn-control !bg-primary-app hover:!bg-secondary-app text-2xl">‚ñ∂</button>
                    <button data-action="reset-unique-rounds" data-input="piano" class="reset-button btn-input btn-control !bg-btn-control-red hover:!bg-btn-control-red-active text-white font-bold rounded-xl text-xl" style="display: none;">
                        RESET
                    </button> 
                    <input type="text" data-input="piano" class="voice-text-input btn-input !bg-primary-app !text-white !text-center !text-2xl !px-0 hidden" placeholder="üé§" title="Keyboard Voice Input">
                    <button data-action="backspace" data-input="piano" class="btn-input btn-control text-2xl">&larr;</button>
                    <button data-action="open-settings" data-input="piano" class="btn-input btn-control !bg-primary-app hover:!bg-secondary-app text-2xl">‚öôÔ∏è</button>
                </div>
            </div>
            
        </footer>
    </div>

    <script>
    (function() {
        'use strict';

        // --- 1. CONFIG ---
        const MAX_MACHINES = 4;
        const DEMO_DELAY_BASE_MS = 798;
        const SPEED_DELETE_INITIAL_DELAY = 250;
        const SPEED_DELETE_INTERVAL_MS = 10;    
        const SHAKE_BASE_THRESHOLD = 25; // Base force needed to trigger shake
        const SHAKE_TIMEOUT_MS = 500; // Cooldown for shake event

        const SETTINGS_KEY = 'followMeAppSettings_v6';
        const STATE_KEY = 'followMeAppState_v6';

        // Input and Mode Definitions
        const INPUTS = {
            KEY9: 'key9',
            KEY12: 'key12',
            PIANO: 'piano'
        };
        const MODES = {
            SIMON: 'simon',
            UNIQUE_ROUNDS: 'unique_rounds'
        };

        // --- NEW: Shortcut Definitions ---
        const SHORTCUT_TRIGGERS = {
            'none': 'Select Trigger...',
            'shake': 'Shake Device',
            'longpress_backspace': 'Long Press Backspace'
            // 'doubletap_play': 'Double Tap Play' // Example for later
        };
        const SHORTCUT_ACTIONS = {
            'none': 'Select Action...',
            'play_demo': 'Play Demo',
            'reset_rounds': 'Reset Rounds',
            'clear_all': 'Clear All',
            'toggle_autoplay': 'Toggle Autoplay',
            'toggle_audio': 'Toggle Audio'
        };

        const PIANO_SPEAK_MAP = {
            'C': 'C', 'D': 'D', 'E': 'E', 'F': 'F', 'G': 'G', 'A': 'A', 'B': 'B',
            '1': '1', '2': '2', '3': '3', '4': '4', '5': '5'
        };
        const VOICE_VALUE_MAP = {
            'one': '1', 'two': '2', 'to': '2', 'three': '3', 'four': '4', 'for': '4', 'five': '5',
            'six': '6', 'seven': '7', 'eight': '8', 'nine': '9', 'ten': '10',
            'eleven': '11', 'twelve': '12',
            'see': 'C', 'dee': 'D', 'e': 'E', 'eff': 'F', 'gee': 'G', 'eh': 'A', 'be': 'B',
            'c': 'C', 'd': 'D', 'f': 'F', 'g': 'G', 'a': 'A', 'b': 'B'
        };

        // --- Profile-based Settings ---
        const DEFAULT_PROFILE_SETTINGS = {
            currentInput: INPUTS.KEY9,
            currentMode: MODES.SIMON,
            sequenceLength: 20,
            simonChunkSize: 3,
            simonInterSequenceDelay: 500,
            isAutoplayEnabled: true, 
            isUniqueRoundsAutoClearEnabled: true,
            isAudioEnabled: true,
            isVoiceInputEnabled: true,
            isHapticsEnabled: true,
            isSpeedDeletingEnabled: true, 
            uiScaleMultiplier: 1.0, 
            machineCount: 1,
            shortcuts: [], // NEW: Shortcut array
            shakeSensitivity: 10 // NEW: Sensitivity slider
        };
        
        // Global app settings
        const DEFAULT_APP_SETTINGS = {
            globalUiScale: 100,
            isDarkMode: true,
            showWelcomeScreen: true,
            activeProfileId: 'profile_1',
            profiles: {},
            playbackSpeed: 1.0,
        };
        
        const PREMADE_PROFILES = {
            'profile_1': { name: "Follow Me", settings: { ...DEFAULT_PROFILE_SETTINGS } },
            'profile_2': { name: "2 Machines", settings: { 
                ...DEFAULT_PROFILE_SETTINGS,
                machineCount: 2,
                simonChunkSize: 4,
                simonInterSequenceDelay: 200
            }},
            'profile_3': { name: "Bananas", settings: {
                ...DEFAULT_PROFILE_SETTINGS,
                sequenceLength: 25
            }},
            'profile_4': { name: "Piano", settings: {
                ...DEFAULT_PROFILE_SETTINGS,
                currentInput: INPUTS.PIANO
            }},
            'profile_5': { name: "15 Rounds", settings: {
                ...DEFAULT_PROFILE_SETTINGS,
                currentMode: MODES.UNIQUE_ROUNDS,
                sequenceLength: 15
            }}
        };

        // --- 2. STATE ---
        let appSettings = { ...DEFAULT_APP_SETTINGS };
        let appState = {}; 

        let initialDelayTimer = null; 
        let speedDeleteInterval = null; 
        let isHoldingBackspace = false;
        let lastShakeTime = 0; // Cooldown for shake event

        // Global DOM Element Variables
        var sequenceContainer = null;
        var customModal = null, modalTitle = null, modalMessage = null, modalConfirm = null, modalCancel = null;
        var shareModal = null, closeShare = null, copyLinkButton = null, nativeShareButton = null;
        
        // --- MODAL: Game Setup (v5)
        var gameSetupModal = null, closeGameSetupModalBtn = null, dontShowWelcomeToggle = null;
        var configSelect = null, configAddBtn = null, configRenameBtn = null, configDeleteBtn = null;
        var quickAutoplayToggle = null, quickAudioToggle = null;
        var quickOpenHelpBtn = null, quickOpenSettingsBtn = null;
        var globalResizeUpBtn = null, globalResizeDownBtn = null;
        
        // --- MODAL: Settings (v6)
        var settingsModal = null, settingsTabNav = null, openHelpButton = null, openShareButton = null, closeSettings = null, openGameSetupFromSettings = null;
        var activeProfileNameSpan = null;
        
        // --- MODAL: Help (v5)
        var helpModal = null, helpContentContainer = null, helpTabNav = null, closeHelp = null;
        
        // --- CONTROLS: Settings Tab "Profile"
        var inputSelect = null, modeToggle = null, modeToggleLabel = null;
        var machinesSlider = null, machinesDisplay = null;
        var sequenceLengthSlider = null, sequenceLengthDisplay = null, sequenceLengthLabel = null;
        var chunkSlider = null, chunkDisplay = null;
        var delaySlider = null, delayDisplay = null;
        var settingMultiSequenceGroup = null;
        var autoclearToggle = null, settingAutoclear = null;
        var autoplayToggle = null, speedDeleteToggle = null;
        var audioToggle = null, voiceInputToggle = null, hapticsToggle = null;

        // --- CONTROLS: Settings Tab "Global"
        var playbackSpeedSlider = null, playbackSpeedDisplay = null;
        var showWelcomeToggle = null, darkModeToggle = null;
        var uiScaleSlider = null, uiScaleDisplay = null;
        
        // --- CONTROLS: Settings Tab "Shortcuts"
        var shortcutListContainer = null, addShortcutBtn = null;
        var shakeSensitivitySlider = null, shakeSensitivityDisplay = null;

        // Pads
        var padKey9 = null, padKey12 = null, padPiano = null;
        var allVoiceInputs = null;
        var allResetButtons = null;

        /**
         * Gets the settings object for the currently active profile.
         */
        const getCurrentProfileSettings = () => appSettings.profiles[appSettings.activeProfileId]?.settings;

        /**
         * Gets the state object for the currently active profile.
         */
        const getCurrentState = () => appState[appSettings.activeProfileId];

        /**
         * Saves the current app state and settings to localStorage.
         */
        function saveState() {
            try {
                localStorage.setItem(SETTINGS_KEY, JSON.stringify(appSettings));
                localStorage.setItem(STATE_KEY, JSON.stringify(appState));
            } catch (error) {
                console.error("Failed to save state to localStorage:", error);
            }
        }

        /**
         * Loads state and settings from localStorage.
         */
        function loadState() {
            try {
                const storedSettings = localStorage.getItem(SETTINGS_KEY);
                const storedState = localStorage.getItem(STATE_KEY);

                if (storedSettings) {
                    const loadedSettings = JSON.parse(storedSettings);
                    appSettings = { ...DEFAULT_APP_SETTINGS, ...loadedSettings };
                    
                    Object.keys(appSettings.profiles).forEach(profileId => {
                        appSettings.profiles[profileId].settings = {
                            ...DEFAULT_PROFILE_SETTINGS,
                            ...(appSettings.profiles[profileId].settings || {})
                        };
                        
                        // --- MIGRATION ---
                        if (appSettings.profiles[profileId].settings.isAudioPlaybackEnabled !== undefined) {
                            appSettings.profiles[profileId].settings.isAudioEnabled = appSettings.profiles[profileId].settings.isAudioPlaybackEnabled;
                            delete appSettings.profiles[profileId].settings.isAudioPlaybackEnabled;
                        }
                    });
                    
                } else {
                    appSettings.profiles = { ...PREMADE_PROFILES };
                }

                if (storedState) {
                    appState = JSON.parse(storedState);
                }
                
                Object.keys(appSettings.profiles).forEach(profileId => {
                    if (!appState[profileId]) {
                        appState[profileId] = getInitialState();
                    }
                });
                
                if (!appSettings.profiles[appSettings.activeProfileId]) {
                    appSettings.activeProfileId = Object.keys(appSettings.profiles)[0] || 'profile_1';
                }

            } catch (error) {
                console.error("Failed to load state from localStorage:", error);
                localStorage.removeItem(SETTINGS_KEY);
                localStorage.removeItem(STATE_KEY);
                
                appSettings = { ...DEFAULT_APP_SETTINGS };
                appSettings.profiles = { ...PREMADE_PROFILES };
                
                appState = {};
                Object.keys(appSettings.profiles).forEach(profileId => {
                    appState[profileId] = getInitialState();
                });
            }
        }

        /**
         * Generates a fresh state object for a profile.
         */
        function getInitialState() {
            return { 
                sequences: Array.from({ length: MAX_MACHINES }, () => []),
                nextSequenceIndex: 0,
                currentRound: 1
            };
        }

        // --- 3. UI ---

        /**
         * Renders the sequence boxes based on the current profile's state.
         */
        function renderSequences() {
            const state = getCurrentState();
            const profileSettings = getCurrentProfileSettings();
            if (!state || !profileSettings || !sequenceContainer) return; 
            
            const { machineCount, currentMode } = profileSettings;
            const { sequences } = state;
            
            const activeSequences = (currentMode === MODES.UNIQUE_ROUNDS) 
                ? [state.sequences[0]] 
                : sequences.slice(0, machineCount);
            
            sequenceContainer.innerHTML = '';
            
            const currentTurnIndex = state.nextSequenceIndex % machineCount;

            let layoutClasses = 'gap-4 flex-grow mb-6 transition-all duration-300 pt-1 ';
            let numColumns = 5;

            if (currentMode === MODES.SIMON) {
                if (machineCount === 1) {
                    layoutClasses += ' flex flex-col max-w-xl mx-auto';
                    numColumns = 5;
                } else if (machineCount === 2) {
                    layoutClasses += ' grid grid-cols-2 max-w-3xl mx-auto';
                    numColumns = 4;
                } else if (machineCount === 3) {
                    layoutClasses += ' grid grid-cols-3 max-w-4xl mx-auto';
                    numColumns = 4;
                } else if (machineCount === 4) {
                    layoutClasses += ' grid grid-cols-4 max-w-5xl mx-auto';
                    numColumns = 3;
                }
            } else {
                 layoutClasses += ' flex flex-col max-w-2xl mx-auto';
                 numColumns = 5;
            }
            sequenceContainer.className = layoutClasses;

            if (currentMode === MODES.UNIQUE_ROUNDS) {
                const roundDisplay = document.createElement('div');
                roundDisplay.className = 'text-center text-2xl font-bold mb-4 text-gray-900 dark:text-gray-100';
                roundDisplay.id = 'unique-rounds-round-display';
                roundDisplay.textContent = `Round: ${state.currentRound} / ${profileSettings.sequenceLength}`;
                sequenceContainer.appendChild(roundDisplay);
            }
            
            let gridClass = numColumns > 0 ? `grid grid-cols-${numColumns}` : 'flex flex-wrap';
            
            const baseSize = 40;
            const baseFont = 1.1;
            const newSize = baseSize * profileSettings.uiScaleMultiplier;
            const newFont = baseFont * profileSettings.uiScaleMultiplier;
            const sizeStyle = `height: ${newSize}px; line-height: ${newSize}px; font-size: ${newFont}rem;`;

            activeSequences.forEach((set, index) => {
                const isCurrent = (currentTurnIndex === index && machineCount > 1 && currentMode === MODES.SIMON);
                const sequenceDiv = document.createElement('div');
                
                const originalClasses = `p-4 rounded-xl shadow-md transition-all duration-200 ${isCurrent ? 'bg-accent-app scale-[1.02] shadow-lg text-gray-900' : 'bg-white dark:bg-gray-700 shadow-sm text-gray-900 dark:text-gray-100'}`;
                sequenceDiv.className = originalClasses;
                sequenceDiv.dataset.originalClasses = originalClasses;
                
                sequenceDiv.innerHTML = `
                    <div class="${gridClass} gap-2 min-h-[50px]"> 
                        ${set.map(val => `
                            <span class="number-box bg-secondary-app text-white rounded-xl text-center shadow-sm"
                                  style="${sizeStyle}">
                                ${val}
                            </span>
                        `).join('')}
                    </div>
                `;
                sequenceContainer.appendChild(sequenceDiv);
            });
        }
        
        // --- Configuration Profile Management ---
        function populateConfigDropdown() {
            if (!configSelect) return;
            configSelect.innerHTML = '';
            Object.keys(appSettings.profiles).forEach(profileId => {
                const option = document.createElement('option');
                option.value = profileId;
                option.textContent = appSettings.profiles[profileId].name;
                configSelect.appendChild(option);
            });
            configSelect.value = appSettings.activeProfileId;
        }

        function switchActiveProfile(newProfileId) {
            if (!appSettings.profiles[newProfileId]) return;
            appSettings.activeProfileId = newProfileId;
            updateAllChrome();
            saveState();
        }
        
        function handleConfigAdd() {
            const newName = prompt("Enter new configuration name:", "My New Setup");
            if (!newName) return;
            
            const newId = `profile_${Date.now()}`;
            appSettings.profiles[newId] = {
                name: newName,
                settings: { ...DEFAULT_PROFILE_SETTINGS, shortcuts: [] } // Start with defaults
            };
            appState[newId] = getInitialState();
            
            appSettings.activeProfileId = newId;
            populateConfigDropdown();
            updateAllChrome();
            saveState();
        }
        
        function handleConfigRename() {
            const currentProfile = appSettings.profiles[appSettings.activeProfileId];
            if (!currentProfile) return;
            
            const newName = prompt("Enter new name:", currentProfile.name);
            if (!newName) return;
            
            currentProfile.name = newName;
            populateConfigDropdown();
            saveState();
        }
        
        function handleConfigDelete() {
            const profileCount = Object.keys(appSettings.profiles).length;
            if (profileCount <= 1) {
                showModal("Cannot Delete", "You must have at least one configuration.", () => closeModal(), "OK", "");
                return;
            }
            
            const currentProfile = appSettings.profiles[appSettings.activeProfileId];
            
            showModal(
                `Delete "${currentProfile.name}"?`,
                "This will permanently delete this configuration and its saved sequences. This cannot be undone.",
                () => {
                    const profileIdToDelete = appSettings.activeProfileId;
                    delete appSettings.profiles[profileIdToDelete];
                    delete appState[profileIdToDelete];
                    
                    appSettings.activeProfileId = Object.keys(appSettings.profiles)[0];
                    populateConfigDropdown();
                    updateAllChrome();
                    saveState();
                },
                "Delete",
                "Cancel"
            );
        }

        // --- Game Setup Modal (v5) ---
        function openGameSetupModal() {
            if (!gameSetupModal) return;
            populateConfigDropdown();
            const profileSettings = getCurrentProfileSettings();
            quickAutoplayToggle.checked = profileSettings.isAutoplayEnabled;
            quickAudioToggle.checked = profileSettings.isAudioEnabled;
            dontShowWelcomeToggle.checked = !appSettings.showWelcomeScreen;
            gameSetupModal.classList.remove('opacity-0', 'pointer-events-none');
            gameSetupModal.querySelector('div').classList.remove('scale-90');
        }

        function closeGameSetupModal() {
            if (!gameSetupModal) return;
            const profileSettings = getCurrentProfileSettings();
            profileSettings.isAutoplayEnabled = quickAutoplayToggle.checked;
            profileSettings.isAudioEnabled = quickAudioToggle.checked;
            appSettings.showWelcomeScreen = !dontShowWelcomeToggle.checked;
            if (showWelcomeToggle) showWelcomeToggle.checked = appSettings.showWelcomeScreen;
            saveState(); 
            if (autoplayToggle) autoplayToggle.checked = profileSettings.isAutoplayEnabled;
            if (audioToggle) audioToggle.checked = profileSettings.isAudioEnabled;
            gameSetupModal.querySelector('div').classList.add('scale-90');
            gameSetupModal.classList.add('opacity-0');
            setTimeout(() => gameSetupModal.classList.add('pointer-events-none'), 300);
        }

        /**
         * Updates visibility of controls *within the Settings "Profile" tab*.
         */
        function updateSettingsModalVisibility() {
            if (!settingsModal) return;
            const profileSettings = getCurrentProfileSettings();
            const mode = profileSettings.currentMode;
            const machineCount = profileSettings.machineCount;

            if (mode === MODES.SIMON) {
                sequenceLengthLabel.textContent = '4. Sequence Length';
                modeToggleLabel.textContent = 'Off: Simon Says';
            } else {
                sequenceLengthLabel.textContent = '4. Unique Rounds';
                modeToggleLabel.textContent = 'On: Unique Rounds';
            }
            machinesSlider.disabled = (mode === MODES.UNIQUE_ROUNDS);
            if (mode === MODES.UNIQUE_ROUNDS) {
                 machinesSlider.value = 1;
                 updateMachinesDisplay(1, machinesDisplay);
            }
            settingAutoclear.style.display = (mode === MODES.UNIQUE_ROUNDS) ? 'flex' : 'none';
            const showSimonSettings = (mode === MODES.SIMON && machineCount > 1);
            settingMultiSequenceGroup.style.display = showSimonSettings ? 'block' : 'none';
        }

        /**
         * Updates visibility of controls on the *main UI* (pads, reset buttons).
         */
        function updateMainUIControlsVisibility() {
            const profileSettings = getCurrentProfileSettings();
            allResetButtons.forEach(btn => {
                btn.style.display = (profileSettings.currentMode === MODES.UNIQUE_ROUNDS) ? 'block' : 'none';
            });
        }


        // --- App Preferences Modal (v6) ---
        function openSettingsModal() {
            const profileSettings = getCurrentProfileSettings();
            if (activeProfileNameSpan) activeProfileNameSpan.textContent = appSettings.profiles[appSettings.activeProfileId].name;
            
            // --- Tab 1: Profile ---
            inputSelect.value = profileSettings.currentInput;
            modeToggle.checked = (profileSettings.currentMode === MODES.UNIQUE_ROUNDS);
            machinesSlider.value = profileSettings.machineCount;
            updateMachinesDisplay(profileSettings.machineCount, machinesDisplay);
            sequenceLengthSlider.value = profileSettings.sequenceLength;
            updateSequenceLengthDisplay(profileSettings.sequenceLength, sequenceLengthDisplay);
            chunkSlider.value = profileSettings.simonChunkSize;
            updateChunkDisplay(profileSettings.simonChunkSize, chunkDisplay);
            delaySlider.value = profileSettings.simonInterSequenceDelay;
            updateDelayDisplay(profileSettings.simonInterSequenceDelay, delayDisplay);
            autoclearToggle.checked = profileSettings.isUniqueRoundsAutoClearEnabled;
            speedDeleteToggle.checked = profileSettings.isSpeedDeletingEnabled; 
            autoplayToggle.checked = profileSettings.isAutoplayEnabled;
            audioToggle.checked = profileSettings.isAudioEnabled; 
            voiceInputToggle.checked = profileSettings.isVoiceInputEnabled;
            hapticsToggle.checked = profileSettings.isHapticsEnabled;
            
            // --- Tab 2: Global ---
            playbackSpeedSlider.value = appSettings.playbackSpeed * 100;
            updatePlaybackSpeedDisplay(appSettings.playbackSpeed * 100, playbackSpeedDisplay);
            showWelcomeToggle.checked = appSettings.showWelcomeScreen;
            darkModeToggle.checked = appSettings.isDarkMode;
            uiScaleSlider.value = profileSettings.uiScaleMultiplier * 100; // This is per-profile, but grouped with global UI
            updateScaleDisplay(profileSettings.uiScaleMultiplier, uiScaleDisplay);
            
            // --- Tab 3: Shortcuts ---
            shakeSensitivitySlider.value = profileSettings.shakeSensitivity;
            updateShakeSensitivityDisplay(profileSettings.shakeSensitivity);
            renderShortcutList();

            // --- Tab 4: Stealth ---
            // (No data to load yet)
            
            updateSettingsModalVisibility();
            switchSettingsTab('profile'); // Default to profile tab
            
            settingsModal.classList.remove('opacity-0', 'pointer-events-none');
            settingsModal.querySelector('div').classList.remove('scale-90');
        }
        
        function saveSettingsModal() {
            // All controls save directly via their event listeners.
            // We just need to save the state.
            saveState();
            
            // Update quick toggles to match
            if (quickAutoplayToggle) quickAutoplayToggle.checked = getCurrentProfileSettings().isAutoplayEnabled;
            if (quickAudioToggle) quickAudioToggle.checked = getCurrentProfileSettings().isAudioEnabled;
            
            updateAllChrome();
        }

        function closeSettingsModal() {
            saveSettingsModal(); // Save on close
            settingsModal.querySelector('div').classList.add('scale-90');
            settingsModal.classList.add('opacity-0');
            setTimeout(() => settingsModal.classList.add('pointer-events-none'), 300);
        }
        
        function switchSettingsTab(tabId) {
            if (settingsModal) {
                settingsModal.querySelectorAll('.settings-tab-content').forEach(tab => tab.classList.add('hidden'));
            }
            if (settingsTabNav) {
                settingsTabNav.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active-tab'));
            }
            const content = document.getElementById(`settings-tab-${tabId}`);
            if (content) content.classList.remove('hidden');
            if (settingsTabNav) {
                const button = settingsTabNav.querySelector(`button[data-tab="${tabId}"]`);
                if (button) button.classList.add('active-tab');
            }
        }

        // --- Help Modal Logic ---
        function openHelpModal() {
            generateGeneralHelp();
            generateModesHelp();
            generatePromptsHelp();
            if (helpTabNav) {
                helpTabNav.addEventListener('click', handleHelpTabClick);
            }
            switchHelpTab('general');
            helpModal.classList.remove('opacity-0', 'pointer-events-none');
            helpModal.querySelector('div').classList.remove('scale-90');
        }

        function closeHelpModal() {
            if (helpTabNav) {
                helpTabNav.removeEventListener('click', handleHelpTabClick);
            }
            const promptTab = helpTabNav.querySelector('button[data-tab="prompts"]');
            if (promptTab && promptTab.classList.contains('active-tab')) {
                const profileSettings = getCurrentProfileSettings();
                const mode = profileSettings.currentMode;
                const targetId = (mode === MODES.SIMON) ? 'prompt-simon' : 'prompt-unique-rounds';
                const promptText = document.getElementById(targetId);
                if (promptText && navigator.clipboard) {
                    navigator.clipboard.writeText(promptText.value).catch(err => console.warn('Auto-copy failed', err));
                }
            }
            helpModal.querySelector('div').classList.add('scale-90');
            helpModal.classList.add('opacity-0');
            setTimeout(() => helpModal.classList.add('pointer-events-none'), 300);
        }

        function handleHelpTabClick(event) {
            const button = event.target.closest('button[data-tab]');
            if (button) {
                switchHelpTab(button.dataset.tab);
            }
        }
        function handleSettingsTabClick(event) {
            const button = event.target.closest('button[data-tab]');
            if (button) {
                switchSettingsTab(button.dataset.tab);
            }
        }

        function switchHelpTab(tabId) {
            if (helpContentContainer) {
                helpContentContainer.querySelectorAll('.help-tab-content').forEach(tab => tab.classList.add('hidden'));
            }
            if (helpTabNav) {
                helpTabNav.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active-tab'));
            }
            const content = document.getElementById(`help-tab-${tabId}`);
            if (content) content.classList.remove('hidden');
            if (helpTabNav) {
                const button = helpTabNav.querySelector(`button[data-tab="${tabId}"]`);
                if (button) button.classList.add('active-tab');
            }
        }

        function generateGeneralHelp() {
            const container = document.getElementById('help-tab-general');
            if (!container) return;
            container.innerHTML = `
                <h4 class="text-primary-app">App Overview</h4>
                <p>This is a multi-mode sequence tracker with customizable profiles.</p>
                <p>Use the **Quick Start** modal (on launch) to select your saved **Configuration Profile**. You can add, rename, or delete profiles from there.</p>
                <p>All detailed settings are in the **Settings (‚öôÔ∏è)** menu, organized into tabs: "Profile", "Global", "Shortcuts", and "Stealth".</p>
                
                <h4 class="text-primary-app">Basic Controls</h4>
                <ul>
                    <li><span class="font-bold">Keypad:</span> Tap the numbers or keys to add to the sequence.</li>
                    <li><span class="font-bold">Play (‚ñ∂):</span> Plays back the current sequence(s).</li>
                    <li><span class="font-bold">Backspace (‚Üê):</span> Removes the last value.</li>
                    <li><span class="font-bold">Settings (‚öôÔ∏è):</span> Opens app preferences.</li>
                    <li><span class="font-bold">RESET:</span> (Unique Rounds Mode Only) Resets the game to Round 1.</li>
                </ul>
            `;
        }
        function generateModesHelp() {
            const container = document.getElementById('help-tab-modes');
            if (!container) return;
            container.innerHTML = `
                <h4 class="text-primary-app">Inputs (The Keypads)</h4>
                <p>Set in Settings ‚ûî Profile Tab</p>
                <ul>
                    <li><span class="font-bold">9-Key:</span> A 3x3 grid (1-9).</li>
                    <li><span class="font-bold">12-Key:</span> A 4x3 grid (1-12).</li>
                    <li><span class="font-bold">Piano:</span> A 7-key piano with 5 sharps.</li>
                </ul>
                
                <h4 class="text-primary-app">Modes (The Logic)</h4>
                <p>Set in Settings ‚ûî Profile Tab</p>
                <ul>
                    <li><span class="font-bold">Simon Says (Default):</span> Standard mode. Enter values up to the Sequence Length. Supports 1-4 machines.</li>
                    <li><span class="font-bold">Unique Rounds:</span> A round-based game. The sequence length increases by one each round, up to the Sequence Length (15, 20, or 25). This mode is always single-machine.</li>
                </ul>
            `;
        }
        function generatePromptsHelp() {
            const container = document.getElementById('help-tab-prompts');
            if (!container) return;
            const profileSettings = getCurrentProfileSettings();
            if (!profileSettings) return;
            const { currentMode, machineCount, sequenceLength, isUniqueRoundsAutoClearEnabled, isAutoplayEnabled } = profileSettings;
            let simonPrompt = "";
            let roundsPrompt = "";
            if (machineCount === 1) {
                simonPrompt = `Let's play 'Simon Says' (1 Machine).
1. I will give you values one at a time.
2. ${isAutoplayEnabled ? "The game is **automatic**. After I give you a value, you will **immediately** read the **entire** sequence back to me." : "After I give you values, I will say 'read back'. You will then read the entire sequence back to me."}
3. 'Clear': Delete the last value I gave you.
4. 'Clear all': Delete the entire sequence.
Let's start.`;
            } else {
                simonPrompt = `Let's play 'Simon Says' (${machineCount} Machines).
1. I will give you one value at a time. Assign each value to a machine in a cycle (Machine 1, Machine 2,${machineCount > 2 ? ' Machine 3,' : ''}${machineCount > 3 ? ' Machine 4,' : ''} then back to Machine 1).
2. ${isAutoplayEnabled ? `The game is **automatic**. After I give you the value for the *last* machine (Machine ${machineCount}), you will **immediately** read all sequences back to me, in order.` : "After I give you the value for the *last* machine, I will say 'read back'. You will then read all sequences back to me, in order."}
3. After you finish reading, I will give you the next value for Machine 1.
4. 'Clear': Delete the last value I gave you.
5. 'Clear all': Delete all sequences.
Let's start with Machine 1.`;
            }
            roundsPrompt = `Let's play 'Unique Rounds Mode'.
1. We will play from Round 1 up to Round ${sequenceLength}.
2. The sequence length matches the round number (e.g., Round 3 has 3 values).
3. I will give you the values for the current round, one at a time.
4. ${isAutoplayEnabled ? `The game is **automatic**. As soon as I give you the **last value for the current round**, you will **immediately** read the full sequence for that round back to me.` : "After I give you the last value for the current round, I will say 'read back'. You will then read the full sequence for that round back to me."}
5. ${isAutoplayEnabled && isUniqueRoundsAutoClearEnabled ? "After you finish reading, you will **automatically** clear the sequence, advance to the next round, and say 'Next Round'." : (isAutoplayEnabled && !isUniqueRoundsAutoClearEnabled ? "After you finish reading, wait for me to say 'next' to clear and advance." : "After you finish reading, wait for me to say 'next' to clear and advance.")}
6. 'Repeat': Read the current round's sequence again.
7. 'Reset': Go back to Round 1.
Let's start with Round 1.`;
            const simonTextarea = document.getElementById('prompt-simon');
            const roundsTextarea = document.getElementById('prompt-unique-rounds');
            if (simonTextarea) simonTextarea.value = simonPrompt.trim();
            if (roundsTextarea) roundsTextarea.value = roundsPrompt.trim();
            const simonGroup = document.getElementById('prompt-simon-group');
            const roundsGroup = document.getElementById('prompt-unique-rounds-group');
            if (simonGroup) simonGroup.style.display = (currentMode === MODES.SIMON) ? 'block' : 'none';
            if (roundsGroup) roundsGroup.style.display = (currentMode === MODES.UNIQUE_ROUNDS) ? 'block' : 'none';
            const promptSection = document.getElementById('virtual-assistant-prompts');
            if (promptSection) {
                promptSection.classList.remove('hidden');
                if (container.querySelector('#virtual-assistant-prompts') == null) {
                    container.appendChild(promptSection);
                }
            }
        }
    
        // --- Share Modal Functions ---
        function openShareModal() {
            closeSettingsModal();
            if (navigator.share) {
                if (nativeShareButton) nativeShareButton.classList.remove('hidden');
            } else {
                if (nativeShareButton) nativeShareButton.classList.add('hidden');
            }
            if (copyLinkButton) {
                copyLinkButton.disabled = false;
                copyLinkButton.classList.remove('!bg-btn-control-green');
                copyLinkButton.innerHTML = `<svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 011-1z"></path><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"></path></svg> Copy Link`;
            }
            shareModal.classList.remove('opacity-0', 'pointer-events-none');
            shareModal.querySelector('div').classList.remove('scale-90');
        }

        function closeShareModal() {
            shareModal.querySelector('div').classList.add('scale-90');
            shareModal.classList.add('opacity-0');
            setTimeout(() => shareModal.classList.add('pointer-events-none'), 300);
        }
    
        // --- UI Update Helpers ---
        function updateTheme(isDark) {
            appSettings.isDarkMode = isDark;
            document.body.classList.toggle('dark', isDark);
            document.body.classList.toggle('light', !isDark);
            renderSequences();
            saveState();
        }
        function applyGlobalUiScale(scalePercent) {
            if (scalePercent < 50) scalePercent = 50;
            if (scalePercent > 150) scalePercent = 150;
            appSettings.globalUiScale = scalePercent;
            document.documentElement.style.fontSize = `${scalePercent}%`;
        }
        function updateScaleDisplay(multiplier, displayElement) {
            const percent = Math.round(multiplier * 100);
            if (displayElement) displayElement.textContent = `${percent}%`;
        }
        function updateMachinesDisplay(count, el) {
            if(el) el.textContent = count + (count > 1 ? ' Machines' : ' Machine');
        }
        function updateSequenceLengthDisplay(val, el) {
            if(el) el.textContent = val;
        }
        function updatePlaybackSpeedDisplay(val, el) {
            if(el) el.textContent = val + '%';
        }
        function updateChunkDisplay(val, el) {
            if(el) el.textContent = val;
        }
        function updateDelayDisplay(val, el) {
            if(el) el.textContent = (val / 1000).toFixed(1) + 's';
        }
        function updateShakeSensitivityDisplay(val) {
            if(shakeSensitivityDisplay) shakeSensitivityDisplay.textContent = val;
        }
        
        function updateAllChrome() {
            const profileSettings = getCurrentProfileSettings();
            if (!profileSettings) return;
            const newInput = profileSettings.currentInput;
            padKey9.style.display = (newInput === INPUTS.KEY9) ? 'block' : 'none';
            padKey12.style.display = (newInput === INPUTS.KEY12) ? 'block' : 'none';
            padPiano.style.display = (newInput === INPUTS.PIANO) ? 'block' : 'none';
            updateMainUIControlsVisibility();
            updateVoiceInputVisibility();
            renderSequences();
        }

        function updateVoiceInputVisibility() {
            const profileSettings = getCurrentProfileSettings();
            const isEnabled = profileSettings.isVoiceInputEnabled;
            if (allVoiceInputs) {
                allVoiceInputs.forEach(input => input.classList.toggle('hidden', !isEnabled));
            }
        }

        // --- Generic Modal/Message Box ---
        function showModal(title, message, onConfirm, confirmText = 'OK', cancelText = 'Cancel') {
            if (!customModal) return;
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            const newConfirmBtn = modalConfirm.cloneNode(true); 
            newConfirmBtn.textContent = confirmText;
            modalConfirm.parentNode.replaceChild(newConfirmBtn, modalConfirm); 
            modalConfirm = newConfirmBtn; 
            const newCancelBtn = modalCancel.cloneNode(true);
            newCancelBtn.textContent = cancelText;
            modalCancel.parentNode.replaceChild(newCancelBtn, modalCancel);
            modalCancel = newCancelBtn; 
            modalConfirm.addEventListener('click', () => { onConfirm(); closeModal(); }); 
            modalCancel.addEventListener('click', closeModal); 
            modalCancel.style.display = cancelText ? 'inline-block' : 'none';
            modalConfirm.className = 'px-4 py-2 text-white rounded-lg transition-colors font-semibold bg-primary-app hover:bg-secondary-app';
            if (confirmText === 'Restore' || confirmText === 'Reset' || confirmText === 'Delete') {
                 modalConfirm.className = 'px-4 py-2 text-white rounded-lg transition-colors font-semibold bg-btn-control-red hover:bg-btn-control-red-active';
            }
            customModal.classList.remove('opacity-0', 'pointer-events-none');
            customModal.querySelector('div').classList.remove('scale-90');
        }

        function closeModal() {
            if (customModal) {
                customModal.querySelector('div').classList.add('scale-90');
                customModal.classList.add('opacity-0');
                setTimeout(() => customModal.classList.add('pointer-events-none'), 300);
            }
        }

        // --- 4. CORE ---

        function vibrate(duration = 10) {
            const profileSettings = getCurrentProfileSettings();
            if (profileSettings.isHapticsEnabled && 'vibrate' in navigator) {
                try {
                    navigator.vibrate(duration);
                } catch (e) {
                    console.warn("Haptic feedback failed.", e);
                }
            }
        }

        function addValue(value) {
            vibrate();
            const state = getCurrentState();
            const profileSettings = getCurrentProfileSettings();
            const mode = profileSettings.currentMode;
            let targetIndex;

            if (mode === MODES.UNIQUE_ROUNDS) {
                if (state.sequences[0].length >= state.currentRound) return; 
                targetIndex = 0;
            } else {
                targetIndex = state.nextSequenceIndex % profileSettings.machineCount;
                if (state.sequences[targetIndex] && state.sequences[targetIndex].length >= profileSettings.sequenceLength) return;
            }

            state.sequences[targetIndex].push(value);
            state.nextSequenceIndex++;
            renderSequences();
            
            if (profileSettings.isAutoplayEnabled) {
                if (mode === MODES.UNIQUE_ROUNDS) {
                    const sequence = state.sequences[0];
                    if (sequence.length === state.currentRound) {
                        const allKeys = document.querySelectorAll(`#pad-${profileSettings.currentInput} button[data-value]`);
                        allKeys.forEach(key => key.disabled = true);
                        setTimeout(handleUniqueRoundsDemo, 100); 
                    }
                }
                else if (mode === MODES.SIMON) {
                    const justFilledIndex = (state.nextSequenceIndex - 1) % profileSettings.machineCount;
                     if (justFilledIndex === profileSettings.machineCount - 1) {
                         setTimeout(handleSimonDemo, 100);
                    }
                }
            }
            saveState();
        }

        function handleBackspace() {
            vibrate(20);
            const state = getCurrentState();
            const profileSettings = getCurrentProfileSettings();
            const mode = profileSettings.currentMode;
            const demoButton = document.querySelector(`#pad-${profileSettings.currentInput} button[data-action="play-demo"]`);
            if (demoButton && demoButton.disabled) return;
            if (state.nextSequenceIndex === 0) return; 
            
            let lastClickTargetIndex;
            if (mode === MODES.UNIQUE_ROUNDS) {
                lastClickTargetIndex = 0;
            } else {
                lastClickTargetIndex = (state.nextSequenceIndex - 1) % profileSettings.machineCount;
            }
            
            const targetSet = state.sequences[lastClickTargetIndex];
            
            if (targetSet.length > 0) {
                targetSet.pop();
                state.nextSequenceIndex--; 
                if (mode === MODES.UNIQUE_ROUNDS) {
                     const allKeys = document.querySelectorAll(`#pad-${profileSettings.currentInput} button[data-value]`);
                     allKeys.forEach(key => key.disabled = false);
                }
                renderSequences();
                saveState();
            }
        }

        // --- Backspace Speed Deleting Logic ---
        function stopSpeedDeleting() {
            if (initialDelayTimer) clearTimeout(initialDelayTimer);
            if (speedDeleteInterval) clearInterval(speedDeleteInterval);
            initialDelayTimer = null;
            speedDeleteInterval = null;
            isHoldingBackspace = false;
        }

        function handleBackspaceStart(event) {
            event.preventDefault(); 
            stopSpeedDeleting(); 
            isHoldingBackspace = false; 

            const profileSettings = getCurrentProfileSettings();
            const demoButton = document.querySelector(`#pad-${profileSettings.currentInput} button[data-action="play-demo"]`);
            if (demoButton && demoButton.disabled) return;

            initialDelayTimer = setTimeout(() => {
                isHoldingBackspace = true;
                
                // Check if a shortcut is mapped
                if (executeShortcut('longpress_backspace')) {
                    // Shortcut was found and executed
                    stopSpeedDeleting();
                    return;
                }
                
                // Fallback to default behavior if no shortcut
                if (profileSettings.isSpeedDeletingEnabled && profileSettings.currentMode !== MODES.UNIQUE_ROUNDS) {
                    handleBackspace();
                    speedDeleteInterval = setInterval(handleBackspace, SPEED_DELETE_INTERVAL_MS);
                }
                initialDelayTimer = null; 
            }, SPEED_DELETE_INITIAL_DELAY);
        }

        function handleBackspaceEnd() {
            const wasHolding = isHoldingBackspace;
            const profileSettings = getCurrentProfileSettings();
            
            if (initialDelayTimer !== null) {
                // Short tap
                stopSpeedDeleting();
                handleBackspace(); 
                return;
            }
            
            stopSpeedDeleting();

            if (wasHolding && profileSettings.currentMode === MODES.UNIQUE_ROUNDS) {
                showModal('Reset Rounds?', 'Are you sure you want to reset to Round 1?', resetUniqueRoundsMode, 'Reset', 'Cancel');
            }
        }

        function resetUniqueRoundsMode() {
            const state = getCurrentState();
            const profileSettings = getCurrentProfileSettings();
            state.currentRound = 1;
            state.sequences = Array.from({ length: MAX_MACHINES }, () => []);
            state.nextSequenceIndex = 0;
            const allKeys = document.querySelectorAll(`#pad-${profileSettings.currentInput} button[data-value]`);
            if (allKeys) allKeys.forEach(key => key.disabled = false);
            renderSequences();
            saveState();
        }

        function processVoiceTranscript(transcript) {
            if (!transcript) return;
            const cleanTranscript = transcript.toLowerCase().replace(/[\.,]/g, '').trim();
            const words = cleanTranscript.split(' ');
            const profileSettings = getCurrentProfileSettings();
            const currentInput = profileSettings.currentInput;
            for (const word of words) {
                let value = VOICE_VALUE_MAP[word];
                if (!value) {
                     const upperWord = word.toUpperCase();
                     if (/^[1-9]$/.test(word) || /^(1[0-2])$/.test(word)) { value = word; } 
                     else if (/^[A-G]$/.test(upperWord) || /^[1-5]$/.test(word)) { value = upperWord; }
                }
                if (value) {
                    if (currentInput === INPUTS.KEY9 && /^[1-9]$/.test(value)) {
                        addValue(value);
                    } else if (currentInput === INPUTS.KEY12 && /^(?:[1-9]|1[0-2])$/.test(value)) {
                        addValue(value);
                    } else if (currentInput === INPUTS.PIANO && (/^[1-5]$/.test(value) || /^[A-G]$/.test(value))) {
                        addValue(value);
                    }
                }
            }
        }

        function handleRestoreDefaults() {
            appSettings = { ...DEFAULT_APP_SETTINGS };
            appSettings.profiles = {}; // Clear profiles
            Object.keys(PREMADE_PROFILES).forEach(id => { // Deep copy premade
                appSettings.profiles[id] = { 
                    name: PREMADE_PROFILES[id].name, 
                    settings: { ...PREMADE_PROFILES[id].settings, shortcuts: [] }
                };
            });
            
            appState = {};
            Object.keys(appSettings.profiles).forEach(profileId => {
                appState[profileId] = getInitialState();
            });
            
            saveState();
            applyGlobalUiScale(appSettings.globalUiScale);
            updateTheme(appSettings.isDarkMode);
            updateAllChrome();
            closeSettingsModal(); 
            setTimeout(openGameSetupModal, 10);
        }

        // --- 5. DEMO ---

        function speak(text) {
            const profileSettings = getCurrentProfileSettings();
            if (!profileSettings.isAudioEnabled || !('speechSynthesis'in window)) return;
            try {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US'; 
                utterance.rate = 1.2; 
                utterance.pitch = 1.0;
                window.speechSynthesis.speak(utterance);
            } catch (error) {
                console.error("Speech synthesis failed:", error);
            }
        }

        const getSpeedMultiplier = () => appSettings.playbackSpeed;

        function handleSimonDemo() {
            const state = getCurrentState();
            const profileSettings = getCurrentProfileSettings();
            const input = profileSettings.currentInput;
            const padSelector = `#pad-${input}`;
            const flashClass = input === 'piano' ? 'flash' : (input === 'key9' ? 'key9-flash' : 'key12-flash');
            const demoButton = document.querySelector(`${padSelector} button[data-action="play-demo"]`);
            const inputKeys = document.querySelectorAll(`${padSelector} button[data-value]`);
            const speedMultiplier = getSpeedMultiplier();
            const currentDelayMs = DEMO_DELAY_BASE_MS / speedMultiplier;
            const numMachines = profileSettings.machineCount;
            const activeSequences = state.sequences.slice(0, numMachines);
            const maxLength = Math.max(...activeSequences.map(s => s.length));
            
            if (maxLength === 0 || (demoButton && demoButton.disabled)) {
                 if (demoButton && demoButton.disabled) return;
                if (!profileSettings.isAutoplayEnabled) {
                    showModal('No Sequence', 'The sequences are empty. Enter some values first!', () => closeModal(), 'OK', '');
                }
                return;
            }
            
            const playlist = [];
            const chunkSize = (numMachines > 1) ? profileSettings.simonChunkSize : maxLength;
            const numChunks = Math.ceil(maxLength / chunkSize);
            for (let chunkNum = 0; chunkNum < numChunks; chunkNum++) {
                for (let seqIndex = 0; seqIndex < numMachines; seqIndex++) {
                    for (let k = 0; k < chunkSize; k++) {
                        const valueIndex = (chunkNum * chunkSize) + k;
                        if (valueIndex < activeSequences[seqIndex].length) {
                            const value = activeSequences[seqIndex][valueIndex];
                            playlist.push({ seqIndex: seqIndex, value: value });
                        }
                    }
                }
            }
            if (playlist.length === 0) return;
            if (demoButton) demoButton.disabled = true;
            if (inputKeys) inputKeys.forEach(key => key.disabled = true);
            let i = 0;
            const flashDuration = 250 * (speedMultiplier > 1 ? (1/speedMultiplier) : 1); 
            const pauseDuration = currentDelayMs;

            function playNextItem() {
                if (i < playlist.length) {
                    const item = playlist[i];
                    const { seqIndex, value } = item;
                    let key = document.querySelector(`${padSelector} button[data-value="${value}"]`);
                    const seqBox = sequenceContainer.children[seqIndex];
                    const originalClasses = seqBox ? seqBox.dataset.originalClasses : '';
                    if (demoButton) demoButton.innerHTML = String(i + 1);
                    speak(input === 'piano' ? PIANO_SPEAK_MAP[value] || value : value);
                    if (key) {
                        if(input === 'piano') key.classList.add('flash');
                        else key.classList.add(flashClass);
                    }
                    if (seqBox && numMachines > 1) seqBox.className = 'p-4 rounded-xl shadow-md transition-all duration-200 bg-accent-app scale-[1.02] shadow-lg text-gray-900';
                    const nextSeqIndex = (i + 1 < playlist.length) ? playlist[i + 1].seqIndex : -1;
                    let timeBetweenItems = pauseDuration - flashDuration;
                    if (numMachines > 1 && nextSeqIndex !== -1 && seqIndex !== nextSeqIndex) {
                        timeBetweenItems += profileSettings.simonInterSequenceDelay;
                    }
                    setTimeout(() => {
                        if (key) {
                            if(input === 'piano') key.classList.remove('flash');
                            else key.classList.remove(flashClass);
                        }
                        if (seqBox && numMachines > 1) seqBox.className = originalClasses;
                        setTimeout(playNextItem, timeBetweenItems); 
                    }, flashDuration);
                    i++;
                } else {
                    if (demoButton) {
                        demoButton.disabled = false;
                        demoButton.innerHTML = '‚ñ∂'; 
                    }
                    if (inputKeys) inputKeys.forEach(key => key.disabled = false);
                    renderSequences();
                }
            }
            playNextItem();
        }

        function advanceToUniqueRound() {
            const state = getCurrentState();
            const profileSettings = getCurrentProfileSettings();
            state.currentRound++;
            if (state.currentRound > profileSettings.sequenceLength) {
                state.currentRound = 1;
                showModal('Complete!', `You finished all ${profileSettings.sequenceLength} rounds. Resetting to Round 1.`, () => closeModal(), 'OK', '');
            }
            renderSequences();
            saveState();
            const allKeys = document.querySelectorAll(`#pad-${profileSettings.currentInput} button[data-value]`);
            if (allKeys) allKeys.forEach(key => key.disabled = false);
        }

        function clearUniqueRoundsSequence() {
            const state = getCurrentState();
            const sequence = state.sequences[0];
            if (sequence.length === 0) {
                advanceToUniqueRound();
                return;
            }
            if (speedDeleteInterval) clearInterval(speedDeleteInterval);
            speedDeleteInterval = null;
            function rapidDelete() {
                if (sequence.length > 0) {
                    sequence.pop();
                    state.nextSequenceIndex--;
                    renderSequences();
                } else {
                    clearInterval(speedDeleteInterval);
                    speedDeleteInterval = null;
                    saveState(); 
                    advanceToUniqueRound(); 
                }
            }
            setTimeout(() => {
                speedDeleteInterval = setInterval(rapidDelete, SPEED_DELETE_INTERVAL_MS);
            }, 10);
        }

        function handleUniqueRoundsDemo() {
            const state = getCurrentState();
            const profileSettings = getCurrentProfileSettings();
            const input = profileSettings.currentInput;
            const padSelector = `#pad-${input}`;
            const flashClass = input === 'piano' ? 'flash' : (input === 'key9' ? 'key9-flash' : 'key12-flash');
            const sequenceToPlay = state.sequences[0]; 
            const demoButton = document.querySelector(`${padSelector} button[data-action="play-demo"]`);
            const allKeys = document.querySelectorAll(`${padSelector} button[data-value]`);
            const speedMultiplier = getSpeedMultiplier();
            const currentDelayMs = DEMO_DELAY_BASE_MS / speedMultiplier;
            if (!demoButton) return;
            if (sequenceToPlay.length === 0 || (demoButton.disabled && !profileSettings.isUniqueRoundsAutoClearEnabled) ) {
                if (demoButton.disabled && !profileSettings.isUniqueRoundsAutoClearEnabled) return;
                showModal('No Sequence', 'The sequence is empty. Enter some values first!', () => closeModal(), 'OK', '');
                if (allKeys) allKeys.forEach(key => key.disabled = false);
                return;
            }
            demoButton.disabled = true;
            if (allKeys) allKeys.forEach(key => key.disabled = true);
            let i = 0;
            const flashDuration = 250 * (speedMultiplier > 1 ? (1/speedMultiplier) : 1);
            const pauseDuration = currentDelayMs; 
            function playNextNumber() {
                if (i < sequenceToPlay.length) {
                    const value = sequenceToPlay[i]; 
                    let key = document.querySelector(`${padSelector} button[data-value="${value}"]`);
                    demoButton.innerHTML = String(i + 1); 
                    speak(input === 'piano' ? PIANO_SPEAK_MAP[value] || value : value); 
                    if (key) {
                        if(input === 'piano') key.classList.add('flash');
                        else key.classList.add(flashClass);
                        setTimeout(() => {
                            if(input === 'piano') key.classList.remove('flash');
                            else key.classList.remove(flashClass);
                            setTimeout(playNextNumber, pauseDuration - flashDuration);
                        }, flashDuration); 
                    } else {
                        setTimeout(playNextNumber, pauseDuration);
                    }
                    i++;
                } else {
                    demoButton.disabled = false;
                    demoButton.innerHTML = '‚ñ∂'; 
                    if (profileSettings.currentMode === MODES.UNIQUE_ROUNDS && profileSettings.isUniqueRoundsAutoClearEnabled) {
                        setTimeout(clearUniqueRoundsSequence, 300); 
                    } else {
                        if (allKeys) allKeys.forEach(key => key.disabled = false);
                    }
                }
            }
            playNextNumber();
        }

        function handleCurrentDemo() {
            const profileSettings = getCurrentProfileSettings();
            if (profileSettings.currentMode === MODES.SIMON) {
                handleSimonDemo();
            } else {
                handleUniqueRoundsDemo();
            }
        }
        
        // --- 6. SHORTCUT COMMAND CENTER ---
        
        function renderShortcutList() {
            if (!shortcutListContainer) return;
            const profileSettings = getCurrentProfileSettings();
            shortcutListContainer.innerHTML = ''; // Clear list
            
            profileSettings.shortcuts.forEach(shortcut => {
                const row = document.createElement('div');
                row.className = 'shortcut-row';
                row.dataset.id = shortcut.id;
                
                const triggerSelect = document.createElement('select');
                triggerSelect.className = 'select-input shortcut-trigger';
                for (const key in SHORTCUT_TRIGGERS) {
                    triggerSelect.options.add(new Option(SHORTCUT_TRIGGERS[key], key));
                }
                triggerSelect.value = shortcut.trigger;
                
                const actionSelect = document.createElement('select');
                actionSelect.className = 'select-input shortcut-action';
                for (const key in SHORTCUT_ACTIONS) {
                    actionSelect.options.add(new Option(SHORTCUT_ACTIONS[key], key));
                }
                actionSelect.value = shortcut.action;
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'shortcut-delete-btn';
                deleteBtn.innerHTML = '&times;';
                deleteBtn.title = 'Delete Shortcut';
                
                row.appendChild(triggerSelect);
                row.appendChild(actionSelect);
                row.appendChild(deleteBtn);
                shortcutListContainer.appendChild(row);
            });
        }
        
        function handleAddShortcut() {
            const profileSettings = getCurrentProfileSettings();
            const newShortcut = {
                id: `sc_${Date.now()}`,
                trigger: 'none',
                action: 'none'
            };
            profileSettings.shortcuts.push(newShortcut);
            renderShortcutList(); // Re-render
        }
        
        function handleShortcutListClick(event) {
            const profileSettings = getCurrentProfileSettings();
            const target = event.target;
            
            if (target.closest('.shortcut-delete-btn')) {
                const row = target.closest('.shortcut-row');
                const shortcutId = row.dataset.id;
                profileSettings.shortcuts = profileSettings.shortcuts.filter(sc => sc.id !== shortcutId);
                renderShortcutList();
            }
            else if (target.matches('.shortcut-trigger')) {
                const row = target.closest('.shortcut-row');
                const shortcutId = row.dataset.id;
                const shortcut = profileSettings.shortcuts.find(sc => sc.id === shortcutId);
                shortcut.trigger = target.value;
            }
            else if (target.matches('.shortcut-action')) {
                const row = target.closest('.shortcut-row');
                const shortcutId = row.dataset.id;
                const shortcut = profileSettings.shortcuts.find(sc => sc.id === shortcutId);
                shortcut.action = target.value;
            }
        }
        
        /**
         * Finds and executes a shortcut for a given trigger.
         * @param {string} triggerKey - The key of the trigger (e.g., 'shake', 'longpress_backspace')
         * @returns {boolean} - True if a shortcut was found and executed, false otherwise.
         */
        function executeShortcut(triggerKey) {
            const profileSettings = getCurrentProfileSettings();
            const shortcut = profileSettings.shortcuts.find(sc => sc.trigger === triggerKey);
            
            if (!shortcut || shortcut.action === 'none') {
                return false; // No shortcut found
            }

            vibrate(50); // Haptic feedback for shortcut
            
            // Execute the action
            switch (shortcut.action) {
                case 'play_demo':
                    handleCurrentDemo();
                    break;
                case 'reset_rounds':
                    if (profileSettings.currentMode === MODES.UNIQUE_ROUNDS) {
                        showModal('Reset Rounds?', 'Shortcut: Are you sure you want to reset to Round 1?', resetUniqueRoundsMode, 'Reset', 'Cancel');
                    }
                    break;
                case 'clear_all':
                     showModal('Clear All?', 'Shortcut: Are you sure you want to clear all sequences?', () => {
                         const state = getCurrentState();
                         state.sequences = Array.from({ length: MAX_MACHINES }, () => []);
                         state.nextSequenceIndex = 0;
                         state.currentRound = 1;
                         renderSequences();
                     }, 'Clear All', 'Cancel');
                    break;
                case 'toggle_autoplay':
                    profileSettings.isAutoplayEnabled = !profileSettings.isAutoplayEnabled;
                    if (autoplayToggle) autoplayToggle.checked = profileSettings.isAutoplayEnabled;
                    if (quickAutoplayToggle) quickAutoplayToggle.checked = profileSettings.isAutoplayEnabled;
                    break;
                case 'toggle_audio':
                    profileSettings.isAudioEnabled = !profileSettings.isAudioEnabled;
                    if (audioToggle) audioToggle.checked = profileSettings.isAudioEnabled;
                    if (quickAudioToggle) quickAudioToggle.checked = profileSettings.isAudioEnabled;
                    break;
                default:
                    console.warn(`Unknown shortcut action: ${shortcut.action}`);
                    return false;
            }
            
            return true; // Shortcut executed
        }

        // --- 7. SENSOR LISTENERS (Shake) ---
        
        function handleShake(event) {
            const now = Date.now();
            if (now - lastShakeTime < SHAKE_TIMEOUT_MS) return; // Cooldown
            
            const profileSettings = getCurrentProfileSettings();
            const sensitivity = profileSettings.shakeSensitivity;
            // Calculate threshold: Higher sensitivity = lower threshold
            const threshold = SHAKE_BASE_THRESHOLD - (sensitivity * 1.2); 
            
            const accel = event.accelerationIncludingGravity;
            
            if (accel && (Math.abs(accel.x) > threshold || Math.abs(accel.y) > threshold)) {
                lastShakeTime = now;
                
                // Check if a shortcut is mapped to 'shake'
                if (executeShortcut('shake')) {
                    // Shortcut was executed
                }
            }
        }
        
        function initShakeListener() {
            if ('DeviceMotionEvent' in window) {
                // Check for permission (required on iOS 13+)
                if (typeof DeviceMotionEvent.requestPermission === 'function') {
                    // This should be triggered by a user action, e.g., a button
                    // For now, we'll just try to add it.
                    DeviceMotionEvent.requestPermission()
                        .then(permissionState => {
                            if (permissionState === 'granted') {
                                window.addEventListener('devicemotion', handleShake);
                            }
                        })
                        .catch(console.error);
                } else {
                    // No permission needed
                    window.addEventListener('devicemotion', handleShake);
                }
            } else {
                console.warn('Device Motion not supported.');
            }
        }


        // --- 8. MAIN ---

        function assignDomElements() {
            // Main UI
            sequenceContainer = document.getElementById('sequence-container');
            
            // Modals
            customModal = document.getElementById('custom-modal');
            modalTitle = document.getElementById('modal-title');
            modalMessage = document.getElementById('modal-message');
            modalConfirm = document.getElementById('modal-confirm');
            modalCancel = document.getElementById('modal-cancel');
            
            shareModal = document.getElementById('share-modal');
            closeShare = document.getElementById('close-share');
            copyLinkButton = document.getElementById('copy-link-button'); 
            nativeShareButton = document.getElementById('native-share-button'); 
            
            // --- MODAL: Game Setup (v5) ---
            gameSetupModal = document.getElementById('game-setup-modal');
            closeGameSetupModalBtn = document.getElementById('close-game-setup-modal');
            dontShowWelcomeToggle = document.getElementById('dont-show-welcome-toggle');
            globalResizeUpBtn = document.getElementById('global-resize-up');
            globalResizeDownBtn = document.getElementById('global-resize-down');
            configSelect = document.getElementById('config-select');
            configAddBtn = document.getElementById('config-add');
            configRenameBtn = document.getElementById('config-rename');
            configDeleteBtn = document.getElementById('config-delete');
            quickAutoplayToggle = document.getElementById('quick-autoplay-toggle');
            quickAudioToggle = document.getElementById('quick-audio-toggle');
            quickOpenHelpBtn = document.getElementById('quick-open-help');
            quickOpenSettingsBtn = document.getElementById('quick-open-settings');

            // --- MODAL: Settings (v6) ---
            settingsModal = document.getElementById('settings-modal');
            settingsTabNav = document.getElementById('settings-tab-nav');
            openGameSetupFromSettings = document.getElementById('open-game-setup-from-settings');
            openShareButton = document.getElementById('open-share-button');
            openHelpButton = document.getElementById('open-help-button');
            closeSettings = document.getElementById('close-settings');
            activeProfileNameSpan = document.getElementById('active-profile-name');
            
            // --- MODAL: Help (v5) ---
            helpModal = document.getElementById('help-modal');
            helpContentContainer = document.getElementById('help-content-container');
            helpTabNav = document.getElementById('help-tab-nav');
            closeHelp = document.getElementById('close-help');

            // --- CONTROLS: Settings Tab "Profile" ---
            inputSelect = document.getElementById('input-select');
            modeToggle = document.getElementById('mode-toggle');
            modeToggleLabel = document.getElementById('mode-toggle-label');
            machinesSlider = document.getElementById('machines-slider');
            machinesDisplay = document.getElementById('machines-display');
            sequenceLengthSlider = document.getElementById('sequence-length-slider');
            sequenceLengthDisplay = document.getElementById('sequence-length-display');
            sequenceLengthLabel = document.getElementById('sequence-length-label');
            chunkSlider = document.getElementById('chunk-slider');
            chunkDisplay = document.getElementById('chunk-display');
            delaySlider = document.getElementById('delay-slider');
            delayDisplay = document.getElementById('delay-display');
            settingMultiSequenceGroup = document.getElementById('setting-multi-sequence-group');
            autoclearToggle = document.getElementById('autoclear-toggle');
            settingAutoclear = document.getElementById('setting-autoclear');
            autoplayToggle = document.getElementById('autoplay-toggle');
            speedDeleteToggle = document.getElementById('speed-delete-toggle');
            audioToggle = document.getElementById('audio-toggle');
            voiceInputToggle = document.getElementById('voice-input-toggle');
            hapticsToggle = document.getElementById('haptics-toggle');

            // --- CONTROLS: Settings Tab "Global" ---
            playbackSpeedSlider = document.getElementById('playback-speed-slider');
            playbackSpeedDisplay = document.getElementById('playback-speed-display');
            showWelcomeToggle = document.getElementById('show-welcome-toggle');
            darkModeToggle = document.getElementById('dark-mode-toggle');
            uiScaleSlider = document.getElementById('ui-scale-slider');
            uiScaleDisplay = document.getElementById('ui-scale-display');
            
            // --- CONTROLS: Settings Tab "Shortcuts" ---
            shortcutListContainer = document.getElementById('shortcut-list-container');
            addShortcutBtn = document.getElementById('add-shortcut-btn');
            shakeSensitivitySlider = document.getElementById('shake-sensitivity-slider');
            shakeSensitivityDisplay = document.getElementById('shake-sensitivity-display');

            // Pads
            padKey9 = document.getElementById('pad-key9');
            padKey12 = document.getElementById('pad-key12');
            padPiano = document.getElementById('pad-piano');
            allResetButtons = document.querySelectorAll('.reset-button');
            allVoiceInputs = document.querySelectorAll('.voice-text-input');
        }

        function initializeListeners() {
            
            document.addEventListener('click', (event) => {
                const button = event.target.closest('button');
                if (!button) return;
                const { value, action, input, copyTarget } = button.dataset;
                if (copyTarget) {
                    const targetElement = document.getElementById(copyTarget);
                    if (targetElement) {
                        targetElement.select();
                        if (navigator.clipboard && navigator.clipboard.writeText) {
                            navigator.clipboard.writeText(targetElement.value).then(() => {
                                const originalText = button.innerHTML;
                                button.innerHTML = "Copied!";
                                button.classList.add('!bg-btn-control-green');
                                setTimeout(() => {
                                    button.innerHTML = originalText;
                                    button.classList.remove('!bg-btn-control-green');
                                }, 2000);
                            });
                        }
                    }
                    return;
                }
                
                if (action === 'open-settings') { openSettingsModal(); return; }
                if (action === 'open-help') { closeSettingsModal(); openHelpModal(); return; }
                if (action === 'open-share') { openShareModal(); return; }
                if (action === 'copy-link') {
                    navigator.clipboard.writeText(window.location.href).then(() => {
                        button.disabled = true;
                        button.classList.add('!bg-btn-control-green');
                        button.innerHTML = `Copied!`;
                    });
                    return;
                }
                if (action === 'native-share') {
                    if (navigator.share) {
                        navigator.share({ title: 'Follow Me App', text: 'Check out this sequence app!', url: window.location.href, });
                    }
                    return;
                }
                if (action === 'restore-defaults') {
                    showModal('Restore Defaults?', 
                              'This will reset all settings and clear all saved sequences. Are you sure?', 
                              handleRestoreDefaults, 
                              'Restore', 
                              'Cancel');
                    return;
                }
                if (action === 'reset-unique-rounds') {
                    showModal('Reset Rounds?', 'Are you sure you want to reset to Round 1?', resetUniqueRoundsMode, 'Reset', 'Cancel');
                    return;
                }
                
                const currentInput = getCurrentProfileSettings().currentInput;
                if (action === 'play-demo' && input === currentInput) {
                    handleCurrentDemo();
                    return;
                }
                if (value && input === currentInput) {
                    addValue(value);
                }
            });
            
            // Voice (Text) Input Listeners
            allVoiceInputs.forEach(input => {
                input.addEventListener('input', (event) => {
                    const transcript = event.target.value;
                    if (transcript && transcript.length > 0) {
                        if (event.target.dataset.input === getCurrentProfileSettings().currentInput) {
                            processVoiceTranscript(transcript);
                        }
                        event.target.value = '';
                    }
                });
            });
            
            // Backspace Listeners
            document.querySelectorAll('button[data-action="backspace"]').forEach(btn => {
                btn.addEventListener('mousedown', handleBackspaceStart);
                btn.addEventListener('mouseup', handleBackspaceEnd);
                btn.addEventListener('mouseleave', stopSpeedDeleting);
                btn.addEventListener('touchstart', handleBackspaceStart, { passive: false });
                btn.addEventListener('touchend', handleBackspaceEnd);
            });
            
            // --- Modal: Game Setup Listeners (v5) ---
            if (closeGameSetupModalBtn) closeGameSetupModalBtn.addEventListener('click', closeGameSetupModal);
            if (dontShowWelcomeToggle) dontShowWelcomeToggle.addEventListener('change', (e) => {
                appSettings.showWelcomeScreen = !e.target.checked;
                if(showWelcomeToggle) showWelcomeToggle.checked = appSettings.showWelcomeScreen;
                saveState();
            });
            if (configSelect) configSelect.addEventListener('change', (e) => switchActiveProfile(e.target.value));
            if (configAddBtn) configAddBtn.addEventListener('click', handleConfigAdd);
            if (configRenameBtn) configRenameBtn.addEventListener('click', handleConfigRename);
            if (configDeleteBtn) configDeleteBtn.addEventListener('click', handleConfigDelete);
            if (quickOpenHelpBtn) quickOpenHelpBtn.addEventListener('click', () => {
                closeGameSetupModal();
                openHelpModal();
            });
            if (quickOpenSettingsBtn) quickOpenSettingsBtn.addEventListener('click', () => {
                closeGameSetupModal();
                openSettingsModal();
            });
            if (globalResizeUpBtn) globalResizeUpBtn.addEventListener('click', () => {
                applyGlobalUiScale(appSettings.globalUiScale + 10);
                saveState();
            });
            if (globalResizeDownBtn) globalResizeDownBtn.addEventListener('click', () => {
                applyGlobalUiScale(appSettings.globalUiScale - 10);
                saveState();
            });

            // --- Modal: App Preferences Listeners (v6) ---
            if (closeSettings) closeSettings.addEventListener('click', closeSettingsModal);
            if (settingsTabNav) settingsTabNav.addEventListener('click', handleSettingsTabClick);
            if (openGameSetupFromSettings) openGameSetupFromSettings.addEventListener('click', () => {
                closeSettingsModal();
                openGameSetupModal();
            });
            
            // Helper for adding profile setting listeners
            const addProfileSettingListener = (element, eventType, settingKey, valueType = 'value') => {
                if (element) {
                    element.addEventListener(eventType, (e) => {
                        const profileSettings = getCurrentProfileSettings();
                        if (!profileSettings) return;
                        let value = e.target[valueType];
                        if (valueType === 'checked') value = e.target.checked;
                        if (element.type === 'range') value = parseInt(value);
                        
                        profileSettings[settingKey] = value;
                        
                        if (element === machinesSlider) updateMachinesDisplay(value, machinesDisplay);
                        if (element === sequenceLengthSlider) updateSequenceLengthDisplay(value, sequenceLengthDisplay);
                        if (element === chunkSlider) updateChunkDisplay(value, chunkDisplay);
                        if (element === delaySlider) updateDelayDisplay(value, delayDisplay);
                        if (element === modeToggle) profileSettings.currentMode = value ? MODES.UNIQUE_ROUNDS : MODES.SIMON;
                        if (element === uiScaleSlider) { // This is in Global tab but saves to profile
                            value = value / 100.0;
                            profileSettings[settingKey] = value;
                            updateScaleDisplay(value, uiScaleDisplay);
                            renderSequences();
                        }
                        if (element === shakeSensitivitySlider) updateShakeSensitivityDisplay(value);
                        
                        updateSettingsModalVisibility();
                    });
                }
            };
            
            // Tab 1: Profile Settings
            addProfileSettingListener(inputSelect, 'change', 'currentInput');
            addProfileSettingListener(modeToggle, 'change', 'currentMode', 'checked');
            addProfileSettingListener(machinesSlider, 'input', 'machineCount');
            addProfileSettingListener(sequenceLengthSlider, 'input', 'sequenceLength');
            addProfileSettingListener(chunkSlider, 'input', 'simonChunkSize');
            addProfileSettingListener(delaySlider, 'input', 'simonInterSequenceDelay');
            addProfileSettingListener(autoclearToggle, 'change', 'isUniqueRoundsAutoClearEnabled', 'checked');
            addProfileSettingListener(autoplayToggle, 'change', 'isAutoplayEnabled', 'checked');
            addProfileSettingListener(speedDeleteToggle, 'change', 'isSpeedDeletingEnabled', 'checked');
            addProfileSettingListener(audioToggle, 'change', 'isAudioEnabled', 'checked');
            addProfileSettingListener(voiceInputToggle, 'change', 'isVoiceInputEnabled', 'checked');
            addProfileSettingListener(hapticsToggle, 'change', 'isHapticsEnabled', 'checked');

            // Tab 2: Global Settings
            if (playbackSpeedSlider) playbackSpeedSlider.addEventListener('input', (e) => {
                const val = parseInt(e.target.value);
                appSettings.playbackSpeed = val / 100.0;
                updatePlaybackSpeedDisplay(val, playbackSpeedDisplay);
            });
            if (showWelcomeToggle) showWelcomeToggle.addEventListener('change', (e) => {
                appSettings.showWelcomeScreen = e.target.checked;
                if(dontShowWelcomeToggle) dontShowWelcomeToggle.checked = !appSettings.showWelcomeScreen;
            });
            if (darkModeToggle) darkModeToggle.addEventListener('change', (e) => updateTheme(e.target.checked));
            addProfileSettingListener(uiScaleSlider, 'input', 'uiScaleMultiplier'); // Belongs here, saves to profile
            
            // Tab 3: Shortcuts
            if (addShortcutBtn) addShortcutBtn.addEventListener('click', handleAddShortcut);
            if (shortcutListContainer) shortcutListContainer.addEventListener('change', handleShortcutListClick);
            if (shortcutListContainer) shortcutListContainer.addEventListener('click', handleShortcutListClick); // For delete button
            addProfileSettingListener(shakeSensitivitySlider, 'input', 'shakeSensitivity');


            // --- Other Modals ---
            if (closeHelp) closeHelp.addEventListener('click', closeHelpModal);
            if (closeShare) closeShare.addEventListener('click', closeShareModal); 
        }

        // --- Initialization ---
        window.onload = function() {
            loadState(); 
            assignDomElements();
            applyGlobalUiScale(appSettings.globalUiScale);
            updateTheme(appSettings.isDarkMode);
            initializeListeners();
            updateAllChrome();
            if (appSettings.showWelcomeScreen) {
                setTimeout(openGameSetupModal, 500); 
            } else {
                // Attempt to init shake listener on first interaction
                // This is needed for iOS permission
                document.body.addEventListener('click', initShakeListener, { once: true });
            }
            if (getCurrentProfileSettings().isAudioEnabled) speak(" "); 
        };

    })(); // IIFE wrapper
    </script>

</body>
</html>
