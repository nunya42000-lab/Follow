import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCsXv-YfziJVtZ8sSraitLevSde51gEUN4",
  authDomain: "follow-me-app-de3e9.firebaseapp.com",
  projectId: "follow-me-app-de3e9",
  storageBucket: "follow-me-app-de3e9.firebasestorage.app",
  messagingSenderId: "957006680126",
  appId: "1:957006680126:web:6d679717d9277fd9ae816f"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

(function() {
    'use strict';

    // --- CONSTANTS ---
    const MAX_MACHINES = 4;
    const DEMO_DELAY_BASE_MS = 798;
    const SPEED_DELETE_INITIAL_DELAY = 250;
    const SPEED_DELETE_INTERVAL_MS = 10;    
    const FLASH_COOLDOWN_MS = 250;
    const SETTINGS_KEY = 'followMeAppSettings_v8';
    const STATE_KEY = 'followMeAppState_v8';
    const INPUTS = { KEY9: 'key9', KEY12: 'key12', PIANO: 'piano' };
    const MODES = { SIMON: 'simon', UNIQUE_ROUNDS: 'unique_rounds' };
    // UPDATED: Added BOTH
    const AUTO_INPUT_MODES = { OFF: '0', TONE: '1', PATTERN: '2', BOTH: '3' }; 

    const PIANO_SPEAK_MAP = { 'C':'C','D':'D','E':'E','F':'F','G':'G','A':'A','B':'B','1':'1','2':'2','3':'3','4':'4','5':'5' };
    const DEFAULT_PROFILE_SETTINGS = {
        currentInput: INPUTS.KEY9, currentMode: MODES.SIMON, sequenceLength: 20, simonChunkSize: 3, simonInterSequenceDelay: 500,
        isAutoplayEnabled: true, isUniqueRoundsAutoClearEnabled: true, isAudioEnabled: true, isVoiceInputEnabled: true,
        isHapticsEnabled: true, isSpeedDeletingEnabled: true, uiScaleMultiplier: 1.0, machineCount: 1, shortcuts: [], 
        shakeSensitivity: 10, autoInputMode: AUTO_INPUT_MODES.OFF, flashSensitivity: 50,
        cameraGridConfig9: { top: '25%', left: '25%', width: '50%', height: '50%' },
        cameraGridConfig12: { top: '25%', left: '20%', width: '60%', height: '40%' }
    };
    const DEFAULT_APP_SETTINGS = { globalUiScale: 100, isDarkMode: true, showWelcomeScreen: true, activeProfileId: 'profile_1', profiles: {}, playbackSpeed: 1.0 };
    const PREMADE_PROFILES = {
        'profile_1': { name: "Follow Me", settings: { ...DEFAULT_PROFILE_SETTINGS } },
        'profile_2': { name: "2 Machines", settings: { ...DEFAULT_PROFILE_SETTINGS, machineCount: 2, simonChunkSize: 4, simonInterSequenceDelay: 200 }},
        'profile_3': { name: "Bananas", settings: { ...DEFAULT_PROFILE_SETTINGS, sequenceLength: 25 }},
        'profile_4': { name: "Piano", settings: { ...DEFAULT_PROFILE_SETTINGS, currentInput: INPUTS.PIANO }},
        'profile_5': { name: "15 Rounds", settings: { ...DEFAULT_PROFILE_SETTINGS, currentMode: MODES.UNIQUE_ROUNDS, sequenceLength: 15 }}
    };

    // --- STATE ---
    let appSettings = { ...DEFAULT_APP_SETTINGS };
    let appState = {};
    let initialDelayTimer = null, speedDeleteInterval = null, isHoldingBackspace = false;
    let cameraStream = null, isDetecting = false, detectionLoopId = null;
    let lastFlashTime = Array(12).fill(0), lastBrightness = Array(12).fill(0);
    let isCameraMasterOn = false, isMicMasterOn = false;
    let toastTimer = null;
    let activeCalibrationGrid = null;

    // --- HELPERS ---
    const getCurrentProfileSettings = () => appSettings.profiles[appSettings.activeProfileId]?.settings;
    const getCurrentState = () => appState[appSettings.activeProfileId];
    const vibrate = (d=10) => { if (getCurrentProfileSettings().isHapticsEnabled && navigator.vibrate) navigator.vibrate(d); };
    
    function saveState() {
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(appSettings));
        localStorage.setItem(STATE_KEY, JSON.stringify(appState));
    }

    function loadState() {
        try {
            const s = localStorage.getItem(SETTINGS_KEY);
            if(s) appSettings = { ...DEFAULT_APP_SETTINGS, ...JSON.parse(s) };
            else resetToDefaults();
            
            const st = localStorage.getItem(STATE_KEY);
            if(st) appState = JSON.parse(st);
            
            // Ensure profiles exist
            Object.keys(appSettings.profiles).forEach(pid => {
                appSettings.profiles[pid].settings = { ...DEFAULT_PROFILE_SETTINGS, ...appSettings.profiles[pid].settings };
                if(!appState[pid]) appState[pid] = { sequences: Array.from({length:MAX_MACHINES},()=>[]), nextSequenceIndex:0, currentRound:1 };
            });
        } catch(e) { resetToDefaults(); }
    }

    function resetToDefaults() {
        appSettings = { ...DEFAULT_APP_SETTINGS };
        Object.keys(PREMADE_PROFILES).forEach(id => {
            appSettings.profiles[id] = { name: PREMADE_PROFILES[id].name, settings: { ...PREMADE_PROFILES[id].settings, shortcuts: [] }};
        });
        appState = {};
    }

    // --- MODAL HANDLING (UNIFIED) ---
    function toggleModal(modalId, show) {
        const modal = document.getElementById(modalId);
        if(!modal) return;
        const content = modal.querySelector('div');
        if(show) {
            modal.classList.remove('opacity-0', 'pointer-events-none');
            content.classList.remove('scale-90');
        } else {
            content.classList.add('scale-90');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('pointer-events-none'), 300);
        }
    }

    // --- UI UPDATE ---
    function updateAllChrome() {
        const settings = getCurrentProfileSettings();
        if(!settings) return;
        
        // Update Input Pads
        ['key9','key12','piano'].forEach(k => {
            document.getElementById(`pad-${k}`).style.display = (settings.currentInput === k) ? 'block' : 'none';
        });

        // Update Master Buttons (Camera/Mic) logic
        const mode = String(settings.autoInputMode);
        const showCam = (mode === AUTO_INPUT_MODES.PATTERN || mode === AUTO_INPUT_MODES.BOTH);
        const showMic = (mode === AUTO_INPUT_MODES.TONE || mode === AUTO_INPUT_MODES.BOTH);
        
        document.querySelectorAll('#camera-master-btn').forEach(b => b.classList.toggle('hidden', !showCam));
        document.querySelectorAll('#mic-master-btn').forEach(b => b.classList.toggle('hidden', !showMic));
        document.querySelectorAll('#camera-master-btn').forEach(b => b.classList.toggle('master-active', isCameraMasterOn));
        document.querySelectorAll('#mic-master-btn').forEach(b => b.classList.toggle('master-active', isMicMasterOn));

        // Update Reset Buttons
        document.querySelectorAll('.reset-button').forEach(b => b.style.display = (settings.currentMode === MODES.UNIQUE_ROUNDS) ? 'block' : 'none');
        
        // Update Voice Inputs
        document.querySelectorAll('.voice-text-input').forEach(i => i.classList.toggle('hidden', !settings.isVoiceInputEnabled));
        
        // Global Theme/Scale
        document.body.classList.toggle('dark', appSettings.isDarkMode);
        document.documentElement.style.fontSize = `${appSettings.globalUiScale}%`;
        
        // Render Numbers
        renderSequences();
    }

    function renderSequences() {
        const state = getCurrentState();
        const settings = getCurrentProfileSettings();
        const container = document.getElementById('sequence-container');
        container.innerHTML = '';
        
        if(!state || !settings) return;
        
        const { machineCount, currentMode } = settings;
        const activeSequences = (currentMode === MODES.UNIQUE_ROUNDS) ? [state.sequences[0]] : state.sequences.slice(0, machineCount);
        
        // Layout Logic
        let cols = 5;
        let classes = 'gap-4 flex-grow mb-6 transition-all duration-300 pt-1 ';
        if (currentMode === MODES.SIMON && machineCount > 1) {
            classes += `grid grid-cols-${Math.max(2, machineCount)} max-w-5xl mx-auto`;
            cols = (machineCount === 4) ? 3 : 4;
        } else {
            classes += 'flex flex-col max-w-xl mx-auto';
        }
        container.className = classes;

        if (currentMode === MODES.UNIQUE_ROUNDS) {
            container.innerHTML += `<div class="text-center text-2xl font-bold mb-4 text-gray-900 dark:text-gray-100">Round: ${state.currentRound} / ${settings.sequenceLength}</div>`;
        }

        const size = 40 * settings.uiScaleMultiplier;
        const font = 1.1 * settings.uiScaleMultiplier;
        
        activeSequences.forEach((seq, idx) => {
            const isCurrent = (state.nextSequenceIndex % machineCount === idx && machineCount > 1);
            const div = document.createElement('div');
            div.className = `p-4 rounded-xl shadow-md transition-all ${isCurrent ? 'bg-accent-app scale-[1.02] shadow-lg text-gray-900' : 'bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100'}`;
            div.innerHTML = `<div class="grid grid-cols-${cols} gap-2 min-h-[50px]">${seq.map(val => 
                `<span class="number-box bg-secondary-app text-white rounded-xl text-center shadow-sm" style="height:${size}px;line-height:${size}px;font-size:${font}rem;">${val}</span>`
            ).join('')}</div>`;
            container.appendChild(div);
        });
    }

    // --- INITIALIZATION & LISTENER "ZIPPER" ---
    function initializeListeners() {
        
        // 1. THE ZIPPER: Unified Settings Handler
        function handleSettingChange(e) {
            const el = e.target;
            const key = el.dataset.setting;
            const scope = el.dataset.scope || 'profile'; // 'global' or 'profile'
            let val = (el.type === 'checkbox') ? el.checked : el.value;
            
            // Logic conversion
            if (el.type === 'range') val = parseInt(val);
            if (key === 'currentMode') val = val ? MODES.UNIQUE_ROUNDS : MODES.SIMON;

            // Apply
            if (scope === 'global') {
                appSettings[key] = val;
            } else {
                getCurrentProfileSettings()[key] = val;
            }

            // Visual Feedback updates
            if(document.getElementById(`display-${key}`)) {
                let displayVal = val;
                if(key.includes('Speed') || key.includes('Scale')) displayVal += '%';
                else if(key.includes('Delay')) displayVal = (val/1000).toFixed(1)+'s';
                else if(key === 'machineCount') displayVal += (val>1 ? ' Machines' : ' Machine');
                document.getElementById(`display-${key}`).textContent = displayVal;
            }

            // Special Triggers
            if(key === 'uiScaleMultiplier') renderSequences();
            if(key === 'autoInputMode') updateAllChrome();
            
            saveState();
            updateAllChrome();
        }

        // Attach Zipper to all inputs with data-setting
        document.querySelectorAll('[data-setting]').forEach(el => {
            el.addEventListener('change', handleSettingChange);
            el.addEventListener('input', handleSettingChange);
        });

        // 2. Global Button Actions (data-action)
        document.body.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if(!btn) return;
            const act = btn.dataset.action;
            const val = btn.dataset.value;
            
            if(val) addValue(val);
            else if(act === 'backspace') handleBackspace();
            else if(act === 'play-demo') handleCurrentDemo();
            else if(act === 'open-settings') { populateSettingsUI(); toggleModal('settings-modal', true); }
            else if(act === 'open-help') { toggleModal('settings-modal', false); toggleModal('game-setup-modal', false); toggleModal('help-modal', true); }
            else if(act === 'open-share') toggleModal('share-modal', true);
            else if(act === 'open-comments') { toggleModal('settings-modal', false); toggleModal('comment-modal', true); }
            else if(act === 'open-camera') { toggleModal('settings-modal', false); openCameraModal(); }
            else if(act === 'restore-defaults') { if(confirm('Reset everything?')) { resetToDefaults(); saveState(); location.reload(); }}
            else if(act === 'reset-unique-rounds') { if(confirm('Reset to Round 1?')) { getCurrentState().currentRound = 1; getCurrentState().sequences[0]=[]; getCurrentState().nextSequenceIndex=0; renderSequences(); saveState(); }}
            else if(act === 'manage-configs') { toggleModal('settings-modal', false); toggleModal('game-setup-modal', true); populateConfigDropdown(); }
        });
        
        // 3. Modal Closers
        document.getElementById('close-settings').onclick = () => toggleModal('settings-modal', false);
        document.getElementById('close-help').onclick = () => toggleModal('help-modal', false);
        document.getElementById('close-share').onclick = () => toggleModal('share-modal', false);
        document.getElementById('close-comment-modal').onclick = () => toggleModal('comment-modal', false);
        document.getElementById('close-camera-modal').onclick = () => { stopDetection(); stopCameraStream(); toggleModal('camera-modal', false); };
        document.getElementById('close-game-setup-modal').onclick = () => {
            // Save Quick Settings from Startup Modal
            const settings = getCurrentProfileSettings();
            settings.isAutoplayEnabled = document.getElementById('quick-autoplay-toggle').checked;
            settings.isAudioEnabled = document.getElementById('quick-audio-toggle').checked;
            appSettings.showWelcomeScreen = !document.getElementById('dont-show-welcome-toggle').checked;
            saveState();
            toggleModal('game-setup-modal', false);
            updateAllChrome();
        };

        // 4. Tabs
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const target = e.target.dataset.tab;
                const parent = e.target.closest('nav').id === 'settings-tab-nav' ? 'settings-modal' : 'help-modal';
                document.getElementById(parent).querySelectorAll('.tab-button').forEach(b => b.classList.remove('active-tab'));
                e.target.classList.add('active-tab');
                document.getElementById(parent).querySelectorAll(`.${e.target.closest('nav').id === 'settings-tab-nav' ? 'settings' : 'help'}-tab-content`).forEach(c => c.classList.add('hidden'));
                document.getElementById(`${e.target.closest('nav').id === 'settings-tab-nav' ? 'settings' : 'help'}-tab-${target}`).classList.remove('hidden');
            });
        });

        // 5. Config Selector
        const configSel = document.getElementById('config-select');
        configSel.addEventListener('change', (e) => {
            appSettings.activeProfileId = e.target.value;
            saveState();
            updateAllChrome();
        });

        // 6. Master Switches
        document.body.addEventListener('click', (e) => {
            if(e.target.closest('#camera-master-btn')) { isCameraMasterOn = !isCameraMasterOn; updateAllChrome(); }
            if(e.target.closest('#mic-master-btn')) { isMicMasterOn = !isMicMasterOn; updateAllChrome(); }
        });
    }

    function populateConfigDropdown() {
        const sel = document.getElementById('config-select');
        sel.innerHTML = '';
        Object.keys(appSettings.profiles).forEach(pid => {
            sel.add(new Option(appSettings.profiles[pid].name, pid));
        });
        sel.value = appSettings.activeProfileId;
    }

    function populateSettingsUI() {
        const s = getCurrentProfileSettings();
        const activeId = appSettings.activeProfileId;
        document.getElementById('active-profile-name').textContent = appSettings.profiles[activeId].name;
        
        // Helper to set value safely
        const setVal = (key, val, scope) => {
            const inputs = document.querySelectorAll(`[data-setting="${key}"]`);
            inputs.forEach(i => {
                if(scope && i.dataset.scope !== scope) return;
                if(i.type === 'checkbox') i.checked = val;
                else i.value = val;
                // Trigger change event manually to update displays
                i.dispatchEvent(new Event('input')); 
            });
        };

        // Profile Settings
        Object.keys(s).forEach(k => {
             let val = s[k];
             if(k === 'currentMode') val = (val === MODES.UNIQUE_ROUNDS);
             setVal(k, val);
        });

        // Global Settings
        setVal('playbackSpeed', appSettings.playbackSpeed, 'global');
        setVal('isDarkMode', appSettings.isDarkMode, 'global');
        setVal('showWelcomeScreen', appSettings.showWelcomeScreen, 'global');

        renderShortcutList();
    }
// --- LOGIC CORE ---
function addValue(val) {
    vibrate();
    const state = getCurrentState();
    const settings = getCurrentProfileSettings();
    
    let targetIdx = (settings.currentMode === MODES.UNIQUE_ROUNDS) ? 0 : state.nextSequenceIndex % settings.machineCount;
    state.sequences[targetIdx].push(val);
    state.nextSequenceIndex++;
    renderSequences();
    
    // Autoplay Logic
    if(settings.isAutoplayEnabled) {
         if (settings.currentMode === MODES.SIMON && (state.nextSequenceIndex - 1) % settings.machineCount === settings.machineCount - 1) {
             setTimeout(handleCurrentDemo, 100);
         } else if (settings.currentMode === MODES.UNIQUE_ROUNDS && state.sequences[0].length === state.currentRound) {
             setTimeout(handleCurrentDemo, 100);
         }
    }
    saveState();
}

function handleBackspace() {
    vibrate(20);
    const state = getCurrentState();
    const settings = getCurrentProfileSettings();
    if(state.nextSequenceIndex === 0) return;
    
    let targetIdx = (settings.currentMode === MODES.UNIQUE_ROUNDS) ? 0 : (state.nextSequenceIndex - 1) % settings.machineCount;
    state.sequences[targetIdx].pop();
    state.nextSequenceIndex--;
    renderSequences();
    saveState();
}

function handleCurrentDemo() {
    const settings = getCurrentProfileSettings();
    const state = getCurrentState();
    const isSimon = settings.currentMode === MODES.SIMON;
    
    const playlist = [];
    const activeSeqs = isSimon ? state.sequences.slice(0, settings.machineCount) : [state.sequences[0]];
    const len = Math.max(...activeSeqs.map(s => s.length));
    if(len === 0) return;

    // Build Playlist
    for(let i=0; i<len; i++) { // Simple sequential for demo
        activeSeqs.forEach((seq, mIdx) => {
            if(i < seq.length) playlist.push({ mIdx, val: seq[i] });
        });
    }

    // Disable inputs
    const padId = `pad-${settings.currentInput}`;
    document.querySelectorAll(`#${padId} button`).forEach(b => b.disabled = true);
    
    let idx = 0;
    const playNext = () => {
        if(idx >= playlist.length) {
            document.querySelectorAll(`#${padId} button`).forEach(b => b.disabled = false);
            if(!isSimon && settings.isUniqueRoundsAutoClearEnabled) {
                state.sequences[0] = []; state.nextSequenceIndex = 0; state.currentRound++;
                saveState(); renderSequences();
            }
            return;
        }
        const { mIdx, val } = playlist[idx];
        speak(settings.currentInput === 'piano' ? PIANO_SPEAK_MAP[val] || val : val);
        
        // Visual Flash
        const btn = document.querySelector(`#${padId} button[data-value="${val}"]`);
        if(btn) {
            btn.classList.add('bg-white', '!text-black'); // Generic flash
            setTimeout(() => btn.classList.remove('bg-white', '!text-black'), 200);
        }
        
        idx++;
        setTimeout(playNext, DEMO_DELAY_BASE_MS / appSettings.playbackSpeed);
    };
    playNext();
}

function speak(txt) {
    if(!getCurrentProfileSettings().isAudioEnabled || !window.speechSynthesis) return;
    const u = new SpeechSynthesisUtterance(txt);
    u.rate = 1.2; 
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
}

// --- CAMERA & SENSOR LOGIC ---
async function openCameraModal() {
    toggleModal('camera-modal', true);
    const s = getCurrentProfileSettings();
    
    // Setup Grids
    const is12 = s.currentInput === INPUTS.KEY12;
    document.getElementById('grid-9key').style.display = is12 ? 'none' : 'grid';
    document.getElementById('grid-12key').style.display = is12 ? 'grid' : 'none';
    activeCalibrationGrid = document.getElementById(is12 ? 'grid-12key' : 'grid-9key');
    
    // Populate grid numbers if empty
    if(activeCalibrationGrid.children.length === 0) {
        for(let i=1; i<=(is12?12:9); i++) {
            const d = document.createElement('div'); d.className = 'calibration-box'; d.textContent = i;
            activeCalibrationGrid.appendChild(d);
        }
    }

    // Apply saved positions
    const cfg = is12 ? s.cameraGridConfig12 : s.cameraGridConfig9;
    Object.assign(activeCalibrationGrid.style, cfg);

    // Buttons
    document.getElementById('start-camera-btn').style.display = 'block';
    document.getElementById('start-detection-btn').style.display = 'none';
    document.getElementById('stop-detection-btn').style.display = 'none';

    // Drag Logic (simplified)
    makeDraggable(activeCalibrationGrid);
}

function makeDraggable(el) {
    let isDrag = false, startX, startY, startL, startT;
    el.onmousedown = el.ontouchstart = (e) => {
        isDrag = true;
        const evt = e.touches ? e.touches[0] : e;
        startX = evt.clientX; startY = evt.clientY;
        startL = el.offsetLeft; startT = el.offsetTop;
        e.preventDefault();
    };
    window.onmousemove = window.ontouchmove = (e) => {
        if(!isDrag) return;
        const evt = e.touches ? e.touches[0] : e;
        const p = el.parentElement.getBoundingClientRect();
        const l = ((startL + evt.clientX - startX) / p.width) * 100;
        const t = ((startT + evt.clientY - startY) / p.height) * 100;
        el.style.left = `${l}%`; el.style.top = `${t}%`;
    };
    window.onmouseup = window.ontouchend = () => {
        if(isDrag) {
            isDrag = false;
            const s = getCurrentProfileSettings();
            const cfg = { top: el.style.top, left: el.style.left, width: el.style.width, height: el.style.height };
            if(s.currentInput === INPUTS.KEY12) s.cameraGridConfig12 = cfg; else s.cameraGridConfig9 = cfg;
            saveState();
        }
    };
}

async function startCameraStream() {
    try {
        cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: {ideal:640} } });
        const feed = document.getElementById('camera-feed');
        feed.srcObject = cameraStream;
        document.getElementById('start-camera-btn').style.display = 'none';
        document.getElementById('start-detection-btn').style.display = 'block';
    } catch(e) { alert('Camera error: ' + e.message); }
}

function stopCameraStream() {
    if(cameraStream) cameraStream.getTracks().forEach(t => t.stop());
    cameraStream = null;
}

function startDetection() {
    if(isDetecting) return;
    isDetecting = true;
    document.getElementById('start-detection-btn').style.display = 'none';
    document.getElementById('stop-detection-btn').style.display = 'block';
    runDetectionLoop();
}

function stopDetection() {
    isDetecting = false;
    if(detectionLoopId) cancelAnimationFrame(detectionLoopId);
    document.getElementById('start-detection-btn').style.display = 'block';
    document.getElementById('stop-detection-btn').style.display = 'none';
}

function runDetectionLoop() {
    if(!isDetecting) return;
    const feed = document.getElementById('camera-feed');
    const cvs = document.getElementById('detection-canvas');
    const ctx = cvs.getContext('2d', { willReadFrequently: true });
    const grid = activeCalibrationGrid;
    
    if(feed.videoWidth === 0) { detectionLoopId = requestAnimationFrame(runDetectionLoop); return; }
    
    cvs.width = feed.videoWidth; cvs.height = feed.videoHeight;
    ctx.drawImage(feed, 0, 0);
    const imgData = ctx.getImageData(0,0,cvs.width,cvs.height);
    
    // Map grid coordinates to canvas
    const fRect = feed.getBoundingClientRect();
    const gRect = grid.getBoundingClientRect();
    const sx = cvs.width / fRect.width;
    const sy = cvs.height / fRect.height;
    
    const boxes = grid.children;
    const rows = (boxes.length === 12) ? 3 : 3;
    const cols = (boxes.length === 12) ? 4 : 3;
    const boxW = (gRect.width * sx) / cols;
    const boxH = (gRect.height * sy) / rows;
    const startX = (gRect.left - fRect.left) * sx;
    const startY = (gRect.top - fRect.top) * sy;

    const now = Date.now();
    const sensitivity = getCurrentProfileSettings().flashSensitivity;

    for(let i=0; i<boxes.length; i++) {
        const r = Math.floor(i/cols); const c = i%cols;
        const x = Math.floor(startX + c*boxW + boxW*0.25);
        const y = Math.floor(startY + r*boxH + boxH*0.25);
        
        // Simple brightness
        let bSum = 0;
        const idx = (y * cvs.width + x) * 4;
        if(idx < imgData.data.length) bSum = (imgData.data[idx]+imgData.data[idx+1]+imgData.data[idx+2])/3;

        const delta = bSum - lastBrightness[i];
        if(delta > sensitivity && (now - lastFlashTime[i] > FLASH_COOLDOWN_MS)) {
            lastFlashTime[i] = now;
            boxes[i].style.backgroundColor = 'rgba(0,255,0,0.5)';
            setTimeout(() => boxes[i].style.backgroundColor = '', 200);
            
            // ONLY ADD IF MASTER SWITCH IS ON
            if(isCameraMasterOn) addValue(String(i+1));
        }
        lastBrightness[i] = bSum;
    }

    detectionLoopId = requestAnimationFrame(runDetectionLoop);
}

// --- VOICE LOGIC ---
// Basic tone mapping simulated by text input for now (or Web Audio API later)
// Using the text inputs as "simulated voice" per your code structure
document.querySelectorAll('.voice-text-input').forEach(inp => {
    inp.addEventListener('input', (e) => {
        if(!e.target.value) return;
        // ONLY PROCESS IF MASTER SWITCH IS ON
        if(isMicMasterOn) {
            // Simple mapping
            const val = e.target.value.toUpperCase();
            if(/[0-9A-G]/.test(val)) addValue(val);
        }
        e.target.value = '';
    });
});

// --- SHORTCUTS UI ---
function renderShortcutList() {
    const div = document.getElementById('shortcut-list-container');
    div.innerHTML = '';
    getCurrentProfileSettings().shortcuts.forEach((sc, i) => {
        const r = document.createElement('div');
        r.className = 'flex gap-2 mb-2';
        r.innerHTML = `<div class="flex-grow bg-gray-100 p-2 rounded text-black">${sc.trigger} -> ${sc.action}</div><button class="bg-red-500 text-white px-3 rounded" onclick="deleteShortcut(${i})">x</button>`;
        div.appendChild(r);
    });
}
window.deleteShortcut = (i) => { getCurrentProfileSettings().shortcuts.splice(i,1); saveState(); populateSettingsUI(); };
document.getElementById('add-shortcut-btn').onclick = () => {
    const trigger = prompt('Trigger (e.g. shake):', 'shake');
    const action = prompt('Action (e.g. play_demo):', 'play_demo');
    if(trigger && action) { getCurrentProfileSettings().shortcuts.push({id:Date.now(), trigger, action}); saveState(); populateSettingsUI(); }
};

// --- BOOT ---
window.onload = () => {
    loadState();
    initializeListeners();
    populateConfigDropdown();
    updateAllChrome();
    if(appSettings.showWelcomeScreen) toggleModal('game-setup-modal', true);
};

})();
