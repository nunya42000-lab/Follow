<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Follow Me (Rewritten v4)</title>
    
    <meta name="theme-color" content="#4f46e5">
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/4f46e5/ffffff?text=F&font=inter">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // --- Tailwind Configuration ---
        tailwind.config = {
            darkMode: 'class', // Enable class-based dark mode
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // Base Colors
                        'primary-app': '#4f46e5', // Indigo
                        'secondary-app': '#6366f1',
                        'accent-app': '#a5b4fc',
                        
                        // Control Button Colors
                        'btn-control-red': '#dc2626', 
                        'btn-control-red-active': '#b91c1c',
                        'btn-control-blue': '#2563eb', 
                        'btn-control-blue-active': '#1e40af',
                        'btn-control-green': '#10b981', 
                    }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        /* ---------------------------------- */
        /* --- THEME COLORS (CSS Variables) --- */
        /* ---------------------------------- */
        :root {
            --bg-main: #1f2937;           
            --bg-footer: #1f2937;         
            --text-color: #ffffff;
            --card-bg: #374151;           
            --card-text: #ffffff;
            --btn-control-gray: #6b7280;  
            --btn-control-gray-active: #4b5563; 
        }
        .light {
            --bg-main: #ffffff;           
            --bg-footer: #ffffff;         
            --text-color: #1f2937;
            --card-bg: #e5e7eb;           
            --card-text: #1f2937;
            --btn-control-gray: #9ca3af; 
            --btn-control-gray-active: #6b7280;
        }

        /* Apply theme variables */
        body {
            background-color: var(--bg-main);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        #input-footer {
            background-color: var(--bg-footer);
        }
        .btn-input {
            color: var(--card-text);
        }
        .number-box {
            height: 40px; 
            line-height: 40px; 
            font-size: 1.1rem; 
            font-weight: 700; 
            transition: height 0.2s, line-height 0.2s, font-size 0.2s; 
        }
        .btn-input {
            transition: all 0.15s ease-in-out;
            position: relative; 
            font-weight: 700;
            border-radius: 9999px; /* Fully rounded/circular look */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -2px rgba(0, 0, 0, 0.1); 
            height: 64px; 
        }
        .btn-pad-number {
            background-color: var(--card-bg);
            font-size: 1.5rem; /* text-2xl */
        }
        .btn-pad-number:active {
            transform: scale(0.95);
            background-color: var(--btn-control-gray-active);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        /* FLASH for Demo Effects */
        .btn-pad-number.key9-flash {
            background-color: #3b82f6; /* blue-500 */
            box-shadow: 0 0 15px 5px rgba(59, 130, 246, 0.7); 
            transform: scale(1.05); 
        }
        .btn-pad-number.key12-flash {
            background-color: #10b981; /* green-500 */
            box-shadow: 0 0 15px 5px rgba(16, 185, 129, 0.7); 
            transform: scale(1.05); 
        }
        .btn-control {
            font-size: 1.8rem; 
            height: 64px; 
            border-radius: 9999px; 
            color: var(--card-text); 
        }
        .btn-control[data-action="backspace"] {
            background-color: var(--btn-control-gray);
            color: white; 
        }
        .btn-control[data-action="backspace"]:active {
            background-color: var(--btn-control-gray-active);
            transform: scale(0.95);
        }

        /* -------------------------- */
        /* --- PIANO KEY STYLES --- */
        /* -------------------------- */
        #piano-keys {
            position: relative; 
            display: flex; 
            width: 100%;
            height: 200px;
            background-color: #333; 
        }
        .key-container {
            width: calc(100% / 7);
            position: relative;
            height: 100%;
        }
        .piano-key-white {
            width: 100%;
            height: 100%;
            border: 1px solid #333;
            border-top: none; 
            border-bottom: 2px solid #555; 
            background-color: #ffffff; 
            background-image: linear-gradient(to bottom, #ffffff, #f0f0f0);
            box-shadow: inset 0 0 10px rgba(0,0,0,0.05); 
            color: #1f2937; 
            font-weight: 700; 
            font-size: 1.6rem; 
            padding-bottom: 15px; 
            border-radius: 0 0 5px 5px;
            position: absolute;
            bottom: 0;
            left: 0;
            z-index: 1; 
            display: flex;
            align-items: flex-end;
            justify-content: center;
            transition: all 0.15s ease-in-out; 
        }
        .piano-key-white:active, .piano-key-white.flash {
            transform: translateY(2px); 
            box-shadow: 0 0 20px 7px rgba(255, 238, 0, 0.9), inset 0 0 10px rgba(0,0,0,0.1); 
            background-image: linear-gradient(to bottom, #ffea00, #ffe066); 
            border-bottom: 2px solid #f0ad4e; 
        }
        .piano-key-black {
            height: 65%; 
            width: 13%; 
            background-color: #000000; 
            background-image: linear-gradient(to top, #111111, #222222);
            box-shadow: 0 6px 10px rgba(0,0,0,0.6); 
            border: 1px solid #333;
            border-top: none;
            border-bottom: 2px solid #000;
            border-radius: 0 0 5px 5px;
            position: absolute; 
            top: 0;
            z-index: 2; 
            color: white; 
            font-weight: 600; 
            font-size: 1rem; 
            display: flex;
            align-items: flex-end; 
            justify-content: center;
            padding-bottom: 5px;
            cursor: pointer;
            transition: all 0.05s ease-in-out;
        }
        .piano-key-black:active, .piano-key-black.flash {
            transform: translateY(3px); 
            height: calc(65% - 3px); 
            box-shadow: 0 0 15px 5px rgba(255, 69, 0, 0.9), 0 2px 3px rgba(0,0,0,0.4); 
            background-image: linear-gradient(to top, #664400, #4c3300); 
            border-bottom: 2px solid #f0adad;
        }
        .black-1 { left: calc((100% / 7) * 1 - (13% / 2)); }
        .black-2 { left: calc((100% / 7) * 2 - (13% / 2)); }
        .black-3 { left: calc((100% / 7) * 4 - (13% / 2)); }
        .black-4 { left: calc((100% / 7) * 5 - (13% / 2)); }
        .black-5 { left: calc((100% / 7) * 6 - (13% / 2)); }

        /* Help content styling */
        #help-content-container h4 {
            font-size: 1.25rem; /* text-xl */
            font-weight: 700; /* font-bold */
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid #e5e7eb; /* gray-200 */
        }
        .dark #help-content-container h4 {
            border-bottom: 1px solid #4b5563; /* gray-600 */
        }
        #help-content-container p, #help-content-container ul {
            margin-bottom: 1rem;
            line-height: 1.5;
        }
        #help-content-container ul {
            list-style: disc;
            margin-left: 1.5rem;
        }
        
        /* Styles for Prompt Box */
        .prompt-box {
            width: 100%;
            height: 150px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            border: 1px solid #9ca3af;
            background-color: #f3f4f6;
            color: #1f2937;
            font-family: monospace;
            font-size: 0.875rem;
            line-height: 1.25rem;
            resize: none;
        }
        .dark .prompt-box {
            background-color: #4b5563;
            color: #ffffff;
            border-color: #6b7280;
        }
        .copy-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100px;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: white;
            background-color: #2563eb; /* btn-control-blue */
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-bottom: 1rem;
        }
        .copy-button:hover {
            background-color: #1e40af; /* btn-control-blue-active */
        }
        .copy-button.copied {
            background-color: #10b981; /* green-500 */
        }
        
        /* Help Tab Styles */
        .help-tab-button {
            padding: 0.5rem 0.75rem;
            font-weight: 600;
            color: #6b7280;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        .dark .help-tab-button {
            color: #9ca3af;
        }
        .help-tab-button:hover {
            color: #374151;
        }
        .dark .help-tab-button:hover {
            color: #e5e7eb;
        }
        .help-tab-button.active-tab {
            color: #4f46e5; /* primary-app */
            border-bottom-color: #4f46e5; /* primary-app */
        }

        /* Generic select dropdown */
        .select-input {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        .dark .select-input {
             background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        }
        .select-input:disabled {
            background-color: #e5e7eb; /* gray-200 */
            cursor: not-allowed;
            opacity: 0.7;
        }
        .dark .select-input:disabled {
             background-color: #4b5563; /* gray-600 */
        }
        
        /* Custom range slider */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 0.5rem; /* 8px */
            background: #e5e7eb; /* gray-200 */
            border-radius: 9999px; /* rounded-full */
            outline: none;
            opacity: 0.9;
            transition: opacity 0.2s;
        }
        .dark input[type="range"] {
            background: #4b5563; /* gray-600 */
        }
        input[type="range"]:hover {
            opacity: 1;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 1.25rem; /* 20px */
            height: 1.25rem; /* 20px */
            background: #4f46e5; /* primary-app */
            border-radius: 9999px;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        input[type="range"]::-moz-range-thumb {
            width: 1.25rem;
            height: 1.25rem;
            background: #4f46e5;
            border-radius: 9999px;
            cursor: pointer;
            border: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        input[type="range"]:disabled {
             background: #e5e7eb; /* gray-200 */
        }
        .dark input[type="range"]:disabled {
             background: #4b5563; /* gray-600 */
        }
        input[type="range"]:disabled::-webkit-slider-thumb {
            background: #9ca3af; /* gray-400 */
            cursor: not-allowed;
        }
        input[type="range"]:disabled::-moz-range-thumb {
            background: #9ca3af;
            cursor: not-allowed;
        }

    </style>
</head>
<body class="dark min-h-screen flex flex-col font-sans p-4">

    <div id="game-setup-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[60] transition-opacity duration-300 opacity-0 pointer-events-none">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-lg w-full transform scale-90 transition-transform duration-300 text-gray-900 dark:text-white max-h-[90vh] flex flex-col relative">
            
            <div class="absolute top-6 left-6 z-10">
                <label class="block text-center text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Resize</label>
                <div class="flex space-x-2">
                    <button id="global-resize-down" class="px-3 py-1 bg-gray-200 dark:bg-gray-600 rounded-md text-lg font-bold hover:bg-gray-300 dark:hover:bg-gray-500">-</button>
                    <button id="global-resize-up" class="px-3 py-1 bg-gray-200 dark:bg-gray-600 rounded-md text-lg font-bold hover:bg-gray-300 dark:hover:bg-gray-500">+</button>
                </div>
            </div>
            
            <h3 class="text-2xl font-bold mb-4 text-center border-b dark:border-gray-700 pb-3">üëã Quick Start Setup</h3>
            
            <div class="overflow-y-auto py-4 px-1">
                <p class="text-gray-700 dark:text-gray-300 mb-6 text-center">Configure your session. You can change this later in Settings.</p>

                <div class="mb-6 grid grid-cols-1 gap-6">
                    <div>
                        <label for="input-select" class="block text-gray-700 dark:text-gray-300 text-lg font-semibold mb-2">1. Input Type</label>
                        <select id="input-select" class="select-input w-full h-12 px-4 py-2 text-lg font-semibold text-gray-900 dark:text-white bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-app">
                            <option value="key9">9-Key</option>
                            <option value="key12">12-Key</option>
                            <option value="piano">Piano</option>
                        </select>
                    </div>
                    
                    <div class="flex items-center justify-between mb-0">
                        <label for="mode-toggle" class="text-gray-700 dark:text-gray-300 text-lg font-semibold">
                            2. Game Mode
                            <span id="mode-toggle-label" class="block text-sm font-normal text-gray-500 dark:text-gray-400">Off: Simon Says</span>
                        </label>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="mode-toggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-app/50 dark:peer-focus:ring-primary-app rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary-app"></div>
                        </label>
                    </div>
                </div>

                <div class="mb-6">
                    <label for="machines-slider" class="block text-gray-700 dark:text-gray-300 text-lg font-semibold mb-2">3. Machines</label>
                    <div class="flex items-center space-x-2">
                        <input type="range" id="machines-slider" min="1" max="4" value="1" step="1" class="w-full">
                        <span id="machines-display" class="text-sm text-gray-500 dark:text-gray-400 w-32 text-center">1 Machine</span>
                    </div>
                </div>

                <div class="mb-6">
                    <label id="sequence-length-label" for="sequence-length-slider" class="block text-gray-700 dark:text-gray-300 text-lg font-semibold mb-2">4. Sequence Length</label>
                     <div class="flex items-center space-x-2">
                        <input type="range" id="sequence-length-slider" min="15" max="25" value="20" step="5" class="w-full">
                        <span id="sequence-length-display" class="text-sm text-gray-500 dark:text-gray-400 w-32 text-center">20</span>
                    </div>
                </div>
                
                <div id="setting-multi-sequence-group" class="mb-6 pt-4 border-t border-gray-200 dark:border-gray-700" style="display: none;">
                    <p class="block text-gray-700 dark:text-gray-300 text-xl font-bold mb-4">Multi-Sequence Options</p>
                    <div class="mb-6">
                        <label for="chunk-slider" class="block text-gray-700 dark:text-gray-300 text-lg font-semibold mb-2">Numbers per Sequence</label>
                        <div class="flex items-center space-x-2">
                            <input type="range" id="chunk-slider" min="2" max="5" value="3" step="1" class="w-full">
                            <span id="chunk-display" class="text-sm text-gray-500 dark:text-gray-400 w-32 text-center">3</span>
                        </div>
                    </div>
                    <div class="mb-6">
                        <label for="delay-slider" class="block text-gray-700 dark:text-gray-300 text-lg font-semibold mb-2">Delay Between Sequences</label>
                        <div class="flex items-center space-x-2">
                            <input type="range" id="delay-slider" min="0" max="1000" value="500" step="100" class="w-full">
                            <span id="delay-display" class="text-sm text-gray-500 dark:text-gray-400 w-32 text-center">0.5s</span>
                        </div>
                    </div>
                </div>

                <div id="setting-autoclear" class="flex items-center justify-between mb-6" style="display: none;">
                    <label for="autoclear-toggle" class="text-gray-700 dark:text-gray-300 text-lg font-semibold">Auto Clear/Advance</label>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="autoclear-toggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-app/50 dark:peer-focus:ring-primary-app rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary-app"></div>
                    </label>
                </div>

            </div>

            <div class="flex justify-between items-center pt-4 border-t dark:border-gray-700">
                <label for="dont-show-welcome-toggle" class="flex items-center text-sm text-gray-600 dark:text-gray-400 cursor-pointer">
                    <input type="checkbox" id="dont-show-welcome-toggle" class="mr-2 h-4 w-4 rounded text-primary-app focus:ring-primary-app">
                    Don't show this again
                </label>
                <button id="close-game-setup-modal" class="px-6 py-2 text-white bg-primary-app rounded-lg hover:bg-secondary-app transition-colors font-semibold">Get Started!</button>
            </div>
        </div>
    </div>

    <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full transform scale-90 transition-transform duration-300">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-gray-900 dark:text-white"></h3>
            <p id="modal-message" class="text-gray-700 dark:text-gray-300 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel" class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors"></button>
                <button id="modal-confirm" class="px-4 py-2 text-white bg-primary-app rounded-lg hover:bg-secondary-app transition-colors"></button>
            </div>
        </div>
    </div>
    
    <div id="share-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full transform scale-90 transition-transform duration-300 text-center">
            <h3 class="text-xl font-bold mb-4 text-gray-900 dark:text-white">Share This App</h3>
            <p class="text-gray-700 dark:text-gray-300 mb-4">Scan the code to open this app on another device.</p>
            <img src="https://placehold.co/256x256/ffffff/1f2937?text=QR+Code&font=inter" alt="Share QR Code" class="w-64 h-64 mx-auto rounded-lg mb-6 border-4 border-white dark:border-gray-700">
            
            <div class="flex flex-col space-y-3 mb-6">
                <button id="native-share-button" data-action="native-share" class="hidden w-full px-6 py-3 text-white bg-primary-app rounded-lg hover:bg-secondary-app transition-colors font-semibold text-lg flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z"></path></svg>
                    Share...
                </button>
                <button id="copy-link-button" data-action="copy-link" class="w-full px-6 py-3 text-white bg-btn-control-blue rounded-lg hover:bg-btn-control-blue-active transition-colors font-semibold text-lg flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 011-1z"></path><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"></path></svg>
                    Copy Link
                </button>
            </div>
            <button id="close-share" class="w-full px-6 py-2 text-gray-700 dark:text-gray-200 bg-gray-200 dark:bg-gray-600 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors font-semibold">Close</button>
        </div>
    </div>
    
    <div id="settings-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full m-4 transform scale-90 transition-transform duration-300 flex flex-col max-h-[90vh] overflow-hidden">
            
            <div class="p-6 pb-4 relative">
                <h3 class="text-2xl font-bold text-gray-900 dark:text-white border-b border-gray-200 dark:border-gray-700 pb-3">App Preferences ‚öôÔ∏è</h3>
                <button id="open-share-button" data-action="open-share" class="absolute top-4 right-16 text-gray-700 dark:text-gray-300 hover:text-primary-app dark:hover:text-primary-app transition-colors text-2xl font-bold focus:outline-none" title="Share App">
                    üì§
                </button>
                <button id="open-help-button" data-action="open-help" class="absolute top-4 right-4 text-gray-700 dark:text-gray-300 hover:text-primary-app dark:hover:text-primary-app transition-colors text-2xl font-bold focus:outline-none" title="View Help & Instructions">
                    ‚ùì
                </button>
            </div>

            <div class="p-6 pt-2 overflow-y-auto flex-grow">
                
                <div class="mb-6">
                    <button id="open-game-setup-from-settings" class="w-full px-6 py-3 text-white bg-primary-app rounded-lg hover:bg-secondary-app transition-colors font-semibold text-lg">
                        Change Game Setup
                    </button>
                </div>

                <div class="mb-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                    
                    <div class="mb-6">
                        <label for="ui-scale-slider" class="block text-gray-700 dark:text-gray-300 text-lg font-semibold mb-2">Sequence Size</label>
                        <div class="flex items-center space-x-2">
                             <input type="range" id="ui-scale-slider" min="50" max="200" value="100" class="w-full">
                             <span id="ui-scale-display" class="text-sm text-gray-500 dark:text-gray-400 w-32 text-center">100%</span>
                        </div>
                    </div>

                    <label for="playback-speed-slider" class="block text-gray-700 dark:text-gray-300 text-lg font-semibold mb-2">Playback Speed</label>
                     <div class="flex items-center space-x-2">
                        <input type="range" id="playback-speed-slider" min="50" max="150" value="100" step="10" class="w-full">
                        <span id="playback-speed-display" class="text-sm text-gray-500 dark:text-gray-400 w-32 text-center">100%</span>
                    </div>
                </div>

                <div class="mb-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                    
                    <div class="flex items-center justify-between mb-6">
                        <label for="show-welcome-toggle" class="text-gray-700 dark:text-gray-300 text-lg font-semibold">Show Setup on Start</label>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="show-welcome-toggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-app/50 dark:peer-focus:ring-primary-app rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary-app"></div>
                        </label>
                    </div>
                    
                    <div class="flex items-center justify-between mb-6">
                        <label for="autoplay-toggle" class="text-gray-700 dark:text-gray-300 text-lg font-semibold">Autoplay</label>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="autoplay-toggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-app/50 dark:peer-focus:ring-primary-app rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary-app"></div>
                        </label>
                    </div>

                    <div class="flex items-center justify-between mb-6">
                        <label for="dark-mode-toggle" class="text-gray-700 dark:text-gray-300 text-lg font-semibold">Dark Mode</label>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="dark-mode-toggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-app/50 dark:peer-focus:ring-primary-app rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary-app"></div>
                        </label>
                    </div>

                    <div class="flex items-center justify-between mb-6">
                        <label for="speed-delete-toggle" class="text-gray-700 dark:text-gray-300 text-lg font-semibold">Speed Deleting</label>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="speed-delete-toggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-app/50 dark:peer-focus:ring-primary-app rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary-app"></div>
                        </label>
                    </div>

                    <div class="flex items-center justify-between mb-6">
                        <label for="audio-playback-toggle" class="text-gray-700 dark:text-gray-300 text-lg font-semibold">Audio Playback (Speak)</label>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="audio-playback-toggle" class="sr-only peer"> 
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-app/50 dark:peer-focus:ring-primary-app rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary-app"></div>
                        </label>
                    </div>

                    <div class="flex items-center justify-between mb-6">
                        <label for="voice-input-toggle" class="text-gray-700 dark:text-gray-300 text-lg font-semibold">Voice Input (Keyboard)</label>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="voice-input-toggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-app/50 dark:peer-focus:ring-primary-app rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary-app"></div>
                        </label>
                    </div>

                    <div class="flex items-center justify-between mb-6">
                        <label for="haptics-toggle" class="text-gray-700 dark:text-gray-300 text-lg font-semibold">Vibration (Haptics)</label>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="haptics-toggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-app/50 dark:peer-focus:ring-primary-app rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary-app"></div>
                        </label>
                    </div>
                </div>

                <div class="mb-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                    
                    

                </div>
            </div>
            
            <div class="p-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                <div class="flex justify-between">
                    <button data-action="restore-defaults" class="px-6 py-2 text-white bg-btn-control-red rounded-lg hover:bg-btn-control-red-active transition-colors font-semibold">Restore Defaults</button>
                    <button id="close-settings" class="px-6 py-2 text-white bg-gray-500 rounded-lg hover:bg-gray-600 transition-colors font-semibold">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="help-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-lg w-full m-4 transform scale-90 transition-transform duration-300 flex flex-col max-h-[90vh] overflow-hidden">
            <div class="p-6 pb-4">
                <h3 class="text-2xl font-bold text-gray-900 dark:text-white pb-3">Application Instructions & Help üìö</h3>
            </div>
            <div class="px-6 border-b border-gray-200 dark:border-gray-700">
                <nav id="help-tab-nav" class="flex space-x-2">
                    <button data-tab="general" class="help-tab-button active-tab">General</button>
                    <button data-tab="modes" class="help-tab-button">Modes</button>
                    <button data-tab="settings" class="help-tab-button">Settings</button>
                    <button data-tab="prompts" class="help-tab-button">Prompts</button>
                </nav>
            </div>
            <div class="p-6 pt-4 overflow-y-auto flex-grow text-gray-700 dark:text-gray-300" id="help-content-container">
                <div id="help-tab-general" class="help-tab-content"></div>
                <div id="help-tab-modes" class="help-tab-content hidden"></div>
                <div id="help-tab-settings" class="help-tab-content hidden"></div>
                <div id="help-tab-prompts" class="help-tab-content hidden">
                    <div id="virtual-assistant-prompts" class="hidden">
                        <h4 class="text-primary-app">Virtual Assistant Prompts</h4>
                        <p>Use these prompts with a voice assistant. They are generated based on your current settings. Click the üìã button to copy.</p>
                        
                        <div id="prompt-simon-group">
                            <label for="prompt-simon" class="font-bold text-gray-900 dark:text-white">Simon Says Prompt</label>
                            <textarea id="prompt-simon" class="prompt-box" readonly></textarea>
                            <button class="copy-button" data-copy-target="prompt-simon">üìã <span class="ml-2">Copy</span></button>
                        </div>
                        
                        <div id="prompt-unique-rounds-group">
                            <label for="prompt-unique-rounds" class="font-bold text-gray-900 dark:text-white">Unique Rounds Mode Prompt</label>
                            <textarea id="prompt-unique-rounds" class="prompt-box" readonly></textarea>
                            <button class="copy-button" data-copy-target="prompt-unique-rounds">üìã <span class="ml-2">Copy</span></button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                <div class="flex justify-end">
                    <button id="close-help" class="px-6 py-2 text-white bg-primary-app rounded-lg hover:bg-secondary-app transition-colors font-semibold">Got it!</button>
                </div>
            </div>
        </div>
    </div>

    <div id="app" class="max-w-7xl w-full mx-auto flex flex-col flex-grow">
        
        <main id="sequence-container" class="flex-grow mb-6 transition-all duration-300 pt-1">
            </main>

        <footer id="input-footer" class="sticky bottom-0 left-0 right-0 p-4 rounded-xl shadow-2xl border-t-4 border-primary-app">
                               
            <div id="pad-key9" class="max-w-xs mx-auto">
                <div class="grid grid-cols-3 gap-3 mb-3">
                    <button data-value="1" data-input="key9" class="btn-input btn-pad-number">1</button>
                    <button data-value="2" data-input="key9" class="btn-input btn-pad-number">2</button>
                    <button data-value="3" data-input="key9" class="btn-input btn-pad-number">3</button>
                    <button data-value="4" data-input="key9" class="btn-input btn-pad-number">4</button>
                    <button data-value="5" data-input="key9" class="btn-input btn-pad-number">5</button>
                    <button data-value="6" data-input="key9" class="btn-input btn-pad-number">6</button>
                    <button data-value="7" data-input="key9" class="btn-input btn-pad-number">7</button>
                    <button data-value="8" data-input="key9" class="btn-input btn-pad-number">8</button>
                    <button data-value="9" data-input="key9" class="btn-input btn-pad-number">9</button>
                </div>
                <div class="grid grid-cols-5 gap-3">
                    <button data-action="play-demo" data-input="key9" class="btn-input btn-control !bg-primary-app hover:!bg-secondary-app text-2xl">‚ñ∂</button> 
                    <button data-action="reset-unique-rounds" data-input="key9" class="reset-button btn-input btn-control !bg-btn-control-red hover:!bg-btn-control-red-active text-white font-bold rounded-xl text-xl" style="display: none;">
                        RESET
                    </button> 
                    <input type="text" data-input="key9" class="voice-text-input btn-input !bg-primary-app !text-white !text-center !text-2xl !px-0 hidden" placeholder="üé§" title="Keyboard Voice Input">
                    <button data-action="backspace" data-input="key9" class="btn-input btn-control text-2xl">&larr;</button>
                    <button data-action="open-settings" data-input="key9" class="btn-input btn-control !bg-primary-app hover:!bg-secondary-app text-2xl">‚öôÔ∏è</button>
                </div>
            </div>

            <div id="pad-key12" class="max-w-md mx-auto" style="display: none;">
                <div class="grid grid-cols-4 gap-3 mb-3">
                    <button data-value="1" data-input="key12" class="btn-input btn-pad-number">1</button>
                    <button data-value="2" data-input="key12" class="btn-input btn-pad-number">2</button>
                    <button data-value="3" data-input="key12" class="btn-input btn-pad-number">3</button>
                    <button data-value="4" data-input="key12" class="btn-input btn-pad-number">4</button>
                    <button data-value="5" data-input="key12" class="btn-input btn-pad-number">5</button>
                    <button data-value="6" data-input="key12" class="btn-input btn-pad-number">6</button>
                    <button data-value="7" data-input="key12" class="btn-input btn-pad-number">7</button>
                    <button data-value="8" data-input="key12" class="btn-input btn-pad-number">8</button>
                    <button data-value="9" data-input="key12" class="btn-input btn-pad-number">9</button>
                    <button data-value="10" data-input="key12" class="btn-input btn-pad-number">10</button>
                    <button data-value="11" data-input="key12" class="btn-input btn-pad-number">11</button>
                    <button data-value="12" data-input="key12" class="btn-input btn-pad-number">12</button>
                </div>
                <div class="grid grid-cols-5 gap-3">
                    <button data-action="play-demo" data-input="key12" class="btn-input btn-control !bg-primary-app hover:!bg-secondary-app text-white font-bold rounded-xl text-2xl">‚ñ∂</button>
                    <button data-action="reset-unique-rounds" data-input="key12" class="reset-button btn-input btn-control !bg-btn-control-red hover:!bg-btn-control-red-active text-white font-bold rounded-xl text-xl" style="display: none;">
                        RESET
                    </button> 
                    <input type="text" data-input="key12" class="voice-text-input btn-input !bg-primary-app !text-white !text-center !text-2xl !px-0 hidden" placeholder="üé§" title="Keyboard Voice Input">
                    <button data-action="backspace" data-input="key12" class="btn-input btn-control text-2xl">&larr;</button>
                    <button data-action="open-settings" data-input="key12" class="btn-input btn-control !bg-primary-app hover:!bg-secondary-app text-2xl">‚öôÔ∏è</button>
                </div>
            </div>

            <div id="pad-piano" class="max-w-xl mx-auto pt-0 pb-4" style="display: none;">
                <div id="piano-keys" class="relative h-48 w-full bg-gray-200 rounded-md shadow-inner overflow-hidden mb-4">
                    <div class="flex h-full w-full">
                        <div class="key-container"><button data-value="C" data-input="piano" class="piano-key-white btn-input">C</button></div>
                        <div class="key-container"><button data-value="D" data-input="piano" class="piano-key-white btn-input">D</button></div>
                        <div class="key-container"><button data-value="E" data-input="piano" class="piano-key-white btn-input">E</button></div>
                        <div class="key-container"><button data-value="F" data-input="piano" class="piano-key-white btn-input">F</button></div>
                        <div class="key-container"><button data-value="G" data-input="piano" class="piano-key-white btn-input">G</button></div>
                        <div class="key-container"><button data-value="A" data-input="piano" class="piano-key-white btn-input">A</button></div>
                        <div class="key-container"><button data-value="B" data-input="piano" class="piano-key-white btn-input">B</button></div>
                    </div>
                    <button data-value="1" data-input="piano" class="piano-key-black btn-input black-1">1</button>
                    <button data-value="2" data-input="piano" class="piano-key-black btn-input black-2">2</button>
                    <button data-value="3" data-input="piano" class="piano-key-black btn-input black-3">3</button>
                    <button data-value="4" data-input="piano" class="piano-key-black btn-input black-4">4</button>
                    <button data-value="5" data-input="piano" class="piano-key-black btn-input black-5">5</button>
                </div>
                <div class="grid grid-cols-5 gap-3 max-w-sm mx-auto">
                    <button data-action="play-demo" data-input="piano" class="btn-input btn-control !bg-primary-app hover:!bg-secondary-app text-2xl">‚ñ∂</button>
                    <button data-action="reset-unique-rounds" data-input="piano" class="reset-button btn-input btn-control !bg-btn-control-red hover:!bg-btn-control-red-active text-white font-bold rounded-xl text-xl" style="display: none;">
                        RESET
                    </button> 
                    <input type="text" data-input="piano" class="voice-text-input btn-input !bg-primary-app !text-white !text-center !text-2xl !px-0 hidden" placeholder="üé§" title="Keyboard Voice Input">
                    <button data-action="backspace" data-input="piano" class="btn-input btn-control text-2xl">&larr;</button>
                    <button data-action="open-settings" data-input="piano" class="btn-input btn-control !bg-primary-app hover:!bg-secondary-app text-2xl">‚öôÔ∏è</button>
                </div>
            </div>
            
        </footer>
    </div>

    <script>
    (function() {
        'use strict';

        // --- 1. CONFIG ---
        const MAX_MACHINES = 4;
        const DEMO_DELAY_BASE_MS = 798;
        const SPEED_DELETE_INITIAL_DELAY = 250;
        const SPEED_DELETE_INTERVAL_MS = 10;    

        const SETTINGS_KEY = 'followMeAppSettings_v4';
        const STATE_KEY = 'followMeAppState_v4';

        // Input and Mode Definitions
        const INPUTS = {
            KEY9: 'key9',
            KEY12: 'key12',
            PIANO: 'piano'
        };
        const MODES = {
            SIMON: 'simon',
            UNIQUE_ROUNDS: 'unique_rounds' // Renamed
        };
        const MODE_LABELS = {
            [MODES.SIMON]: 'Simon Says',
            [MODES.UNIQUE_ROUNDS]: 'Unique Rounds' // Renamed
        };

        const PIANO_SPEAK_MAP = {
            'C': 'C', 'D': 'D', 'E': 'E', 'F': 'F', 'G': 'G', 'A': 'A', 'B': 'B',
            '1': '1', '2': '2', '3': '3', '4': '4', '5': '5'
        };

        const VOICE_VALUE_MAP = {
            'one': '1', 'two': '2', 'to': '2', 'three': '3', 'four': '4', 'for': '4', 'five': '5',
            'six': '6', 'seven': '7', 'eight': '8', 'nine': '9', 'ten': '10',
            'eleven': '11', 'twelve': '12',
            'see': 'C', 'dee': 'D', 'e': 'E', 'eff': 'F', 'gee': 'G', 'eh': 'A', 'be': 'B',
            'c': 'C', 'd': 'D', 'f': 'F', 'g': 'G', 'a': 'A', 'b': 'B'
        };

        const DEFAULT_SETTINGS = {
            isDarkMode: true,
            playbackSpeed: 1.0,
            uiScaleMultiplier: 1.0, 
            globalUiScale: 100, // New: Global UI scale percentage
            isSpeedDeletingEnabled: true, 
            isAutoplayEnabled: true, 
            isUniqueRoundsAutoClearEnabled: true, // Renamed
            isAudioPlaybackEnabled: true,
            isVoiceInputEnabled: true,
            isHapticsEnabled: true,
            showWelcomeScreen: true,
            currentInput: INPUTS.KEY9,
            currentMode: MODES.SIMON, // Default mode is OFF (Simon Says)
            sequenceLength: 20,
            simonChunkSize: 3,
            simonInterSequenceDelay: 500
        };

        // --- 2. STATE ---
        let settings = { ...DEFAULT_SETTINGS };
        let appState = {}; // Will be populated by loadState

        let initialDelayTimer = null; 
        let speedDeleteInterval = null; 
        let isHoldingBackspace = false;

        // Global DOM Element Variables
        var sequenceContainer = null;
        var customModal = null, modalTitle = null, modalMessage = null, modalConfirm = null, modalCancel = null;
        var shareModal = null, closeShare = null, copyLinkButton = null, nativeShareButton = null;
        
        // --- MODAL: Game Setup (formerly Welcome)
        var gameSetupModal = null, closeGameSetupModalBtn = null, dontShowWelcomeToggle = null;
        var globalResizeUpBtn = null, globalResizeDownBtn = null; // New resize buttons
        // --- MODAL: Settings
        var settingsModal = null, openHelpButton = null, openShareButton = null, closeSettings = null, openGameSetupFromSettings = null;
        // --- MODAL: Help
        var helpModal = null, helpContentContainer = null, helpTabNav = null, closeHelp = null;
        
        // --- CONTROLS: Game Setup (in game-setup-modal)
        var inputSelect = null, modeToggle = null, modeToggleLabel = null;
        var machinesSlider = null, machinesDisplay = null;
        var sequenceLengthSlider = null, sequenceLengthDisplay = null, sequenceLengthLabel = null;
        var chunkSlider = null, chunkDisplay = null;
        var delaySlider = null, delayDisplay = null;
        var settingMultiSequenceGroup = null;
        var autoclearToggle = null, settingAutoclear = null;

        // --- CONTROLS: App Preferences (in settings-modal)
        var playbackSpeedSlider = null, playbackSpeedDisplay = null;
        var autoplayToggle = null; 
        var showWelcomeToggle = null, darkModeToggle = null, speedDeleteToggle = null;
        var audioPlaybackToggle = null, voiceInputToggle = null, hapticsToggle = null;
        var uiScaleSlider = null, uiScaleDisplay = null;

        // Pads
        var padKey9 = null, padKey12 = null, padPiano = null;
        var allVoiceInputs = null;
        var allResetButtons = null;

        /**
         * Gets the state object for the currently active input.
         */
        const getCurrentState = () => appState[settings.currentInput];

        /**
         * Saves the current app state and settings to localStorage.
         */
        function saveState() {
            try {
                localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
                localStorage.setItem(STATE_KEY, JSON.stringify(appState));
            } catch (error) {
                console.error("Failed to save state to localStorage:", error);
            }
        }

        /**
         * Loads state and settings from localStorage.
         */
        function loadState() {
            try {
                const storedSettings = localStorage.getItem(SETTINGS_KEY);
                const storedState = localStorage.getItem(STATE_KEY);

                if (storedSettings) {
                    const loadedSettings = JSON.parse(storedSettings);
                    // Remove obsolete settings
                    delete loadedSettings.areSlidersLocked; 
                    settings = { ...DEFAULT_SETTINGS, ...loadedSettings };
                } else {
                    settings = { ...DEFAULT_SETTINGS };
                }

                // Migrate old 'changing' mode to 'unique_rounds'
                if (settings.currentMode === 'changing') {
                    settings.currentMode = MODES.UNIQUE_ROUNDS;
                }
                if (settings.isChangingAutoClearEnabled !== undefined) {
                    settings.isUniqueRoundsAutoClearEnabled = settings.isChangingAutoClearEnabled;
                    delete settings.isChangingAutoClearEnabled;
                }

                const defaultStates = {
                    [INPUTS.KEY9]: getInitialState(),
                    [INPUTS.KEY12]: getInitialState(),
                    [INPUTS.PIANO]: getInitialState(),
                };

                if (storedState) {
                    const loadedState = JSON.parse(storedState);
                    appState[INPUTS.KEY9] = { ...defaultStates[INPUTS.KEY9], ...(loadedState[INPUTS.KEY9] || {}) };
                    appState[INPUTS.KEY12] = { ...defaultStates[INPUTS.KEY12], ...(loadedState[INPUTS.KEY12] || {}) };
                    appState[INPUTS.PIANO] = { ...defaultStates[INPUTS.PIANO], ...(loadedState[INPUTS.PIANO] || {}) };
                    
                    // Migrate old 'sequenceCount' to 'machineCount'
                    Object.values(appState).forEach(state => {
                        if (state.sequenceCount !== undefined) {
                            state.machineCount = state.sequenceCount;
                            delete state.sequenceCount;
                        }
                    });

                } else {
                    appState = defaultStates;
                }

                // Ensure maxRound is synced with settings
                Object.values(appState).forEach(state => {
                    state.maxRound = settings.sequenceLength;
                });

            } catch (error) {
                console.error("Failed to load state from localStorage:", error);
                localStorage.removeItem(SETTINGS_KEY);
                localStorage.removeItem(STATE_KEY);
                settings = { ...DEFAULT_SETTINGS };
                appState = {
                    [INPUTS.KEY9]: getInitialState(),
                    [INPUTS.KEY12]: getInitialState(),
                    [INPUTS.PIANO]: getInitialState(),
                };
            }
        }

        /**
         * Generates a fresh state object.
         */
        function getInitialState() {
            return { 
                sequences: Array.from({ length: MAX_MACHINES }, () => []),
                machineCount: 1, // Renamed from sequenceCount
                nextSequenceIndex: 0,
                currentRound: 1,
                maxRound: settings.sequenceLength
            };
        }

        // --- 3. UI ---

        /**
         * Renders the sequence boxes based on the current input and state.
         */
        function renderSequences() {
            const state = getCurrentState();
            if (!state || !sequenceContainer) return; 
            
            const { sequences, machineCount } = state; // Renamed
            const activeSequences = (settings.currentMode === MODES.UNIQUE_ROUNDS) 
                ? [state.sequences[0]] // Unique Rounds mode only ever shows one sequence
                : sequences.slice(0, machineCount);
            
            sequenceContainer.innerHTML = '';
            
            const currentTurnIndex = state.nextSequenceIndex % machineCount;

            let layoutClasses = 'gap-4 flex-grow mb-6 transition-all duration-300 pt-1 ';
            let numColumns = 5; // Default for 1 machine or piano/12-key

            if (settings.currentMode === MODES.SIMON) {
                if (machineCount === 1) {
                    layoutClasses += ' flex flex-col max-w-xl mx-auto';
                    numColumns = 5;
                } else if (machineCount === 2) {
                    layoutClasses += ' grid grid-cols-2 max-w-3xl mx-auto';
                    numColumns = 4;
                } else if (machineCount === 3) {
                    layoutClasses += ' grid grid-cols-3 max-w-4xl mx-auto';
                    numColumns = 4;
                } else if (machineCount === 4) {
                    layoutClasses += ' grid grid-cols-4 max-w-5xl mx-auto';
                    numColumns = 3;
                }
            } else {
                // Unique Rounds mode is always single-column
                 layoutClasses += ' flex flex-col max-w-2xl mx-auto';
                 numColumns = 5;
            }
            sequenceContainer.className = layoutClasses;

            // Show Round Display for 'Unique Rounds' mode
            if (settings.currentMode === MODES.UNIQUE_ROUNDS) {
                const roundDisplay = document.createElement('div');
                roundDisplay.className = 'text-center text-2xl font-bold mb-4 text-gray-900 dark:text-gray-100';
                roundDisplay.id = 'unique-rounds-round-display';
                roundDisplay.textContent = `Round: ${state.currentRound} / ${settings.sequenceLength}`;
                sequenceContainer.appendChild(roundDisplay);
            }
            
            let gridClass = numColumns > 0 ? `grid grid-cols-${numColumns}` : 'flex flex-wrap';
            
            const baseSize = 40;
            const baseFont = 1.1;
            const newSize = baseSize * settings.uiScaleMultiplier;
            const newFont = baseFont * settings.uiScaleMultiplier;
            const sizeStyle = `height: ${newSize}px; line-height: ${newSize}px; font-size: ${newFont}rem;`;

            activeSequences.forEach((set, index) => {
                const isCurrent = (currentTurnIndex === index && machineCount > 1 && settings.currentMode === MODES.SIMON);
                const sequenceDiv = document.createElement('div');
                
                const originalClasses = `p-4 rounded-xl shadow-md transition-all duration-200 ${isCurrent ? 'bg-accent-app scale-[1.02] shadow-lg text-gray-900' : 'bg-white dark:bg-gray-700 shadow-sm text-gray-900 dark:text-gray-100'}`;
                sequenceDiv.className = originalClasses;
                sequenceDiv.dataset.originalClasses = originalClasses;
                
                sequenceDiv.innerHTML = `
                    <div class="${gridClass} gap-2 min-h-[50px]"> 
                        ${set.map(val => `
                            <span class="number-box bg-secondary-app text-white rounded-xl text-center shadow-sm"
                                  style="${sizeStyle}">
                                ${val}
                            </span>
                        `).join('')}
                    </div>
                `;
                sequenceContainer.appendChild(sequenceDiv);
            });
        }

        // --- Game Setup Modal ---
        function openGameSetupModal() {
            if (!gameSetupModal) return;

            // 1. Populate controls with current settings
            const state = getCurrentState();
            
            inputSelect.value = settings.currentInput;
            modeToggle.checked = (settings.currentMode === MODES.UNIQUE_ROUNDS);
            
            machinesSlider.value = state.machineCount;
            updateMachinesDisplay(state.machineCount, machinesDisplay);
            
            sequenceLengthSlider.value = settings.sequenceLength;
            updateSequenceLengthDisplay(settings.sequenceLength, sequenceLengthDisplay);
            
            chunkSlider.value = settings.simonChunkSize;
            updateChunkDisplay(settings.simonChunkSize, chunkDisplay);
            
            delaySlider.value = settings.simonInterSequenceDelay;
            updateDelayDisplay(settings.simonInterSequenceDelay, delayDisplay);

            autoclearToggle.checked = settings.isUniqueRoundsAutoClearEnabled;
            
            dontShowWelcomeToggle.checked = !settings.showWelcomeScreen;

            // 2. Update visibility based on populated values
            updateGameSetupVisibility();
            
            // 3. Show modal
            gameSetupModal.classList.remove('opacity-0', 'pointer-events-none');
            gameSetupModal.querySelector('div').classList.remove('scale-90');
        }

        function closeGameSetupModal() {
            if (!gameSetupModal) return;

            // 1. Read values from controls and apply them
            const newMachineCount = parseInt(machinesSlider.value);
            const newMode = modeToggle.checked ? MODES.UNIQUE_ROUNDS : MODES.SIMON;

            // Check if core game settings changed
            const state = getCurrentState();
            const didModeChange = settings.currentMode !== newMode;
            const didMachineChange = state.machineCount !== newMachineCount;
            const didInputChange = settings.currentInput !== inputSelect.value;
            
            // Apply all settings
            settings.currentInput = inputSelect.value;
            settings.currentMode = newMode;
            settings.sequenceLength = parseInt(sequenceLengthSlider.value);
            settings.simonChunkSize = parseInt(chunkSlider.value);
            settings.simonInterSequenceDelay = parseInt(delaySlider.value);
            settings.isUniqueRoundsAutoClearEnabled = autoclearToggle.checked;
            settings.showWelcomeScreen = !dontShowWelcomeToggle.checked;
            
            // Update the "Show on Start" toggle in the main settings
            if (showWelcomeToggle) showWelcomeToggle.checked = settings.showWelcomeScreen;
            
            // Get new state (for new input)
            const newState = getCurrentState();
            newState.machineCount = (newMode === MODES.UNIQUE_ROUNDS) ? 1 : newMachineCount;
            newState.maxRound = settings.sequenceLength;

            // Sync all states maxRound
            Object.values(appState).forEach(s => {
                s.maxRound = settings.sequenceLength;
            });

            // If game structure changed, reset sequences for the *new* state
            if(didModeChange || didMachineChange || didInputChange) {
                newState.sequences = Array.from({ length: MAX_MACHINES }, () => []);
                newState.nextSequenceIndex = 0;
                newState.currentRound = 1;
            }
            
            // 2. Update main UI
            updateInput(settings.currentInput); // This calls renderSequences
            updateMainUIControlsVisibility(); // This shows/hides reset buttons

            // 3. Save and close
            saveState(); 
            gameSetupModal.querySelector('div').classList.add('scale-90');
            gameSetupModal.classList.add('opacity-0');
            setTimeout(() => gameSetupModal.classList.add('pointer-events-none'), 300);
        }

        /**
         * Updates the visibility of settings *within the Game Setup modal*.
         */
        function updateGameSetupVisibility() {
            if (!gameSetupModal) return;

            const mode = modeToggle.checked ? MODES.UNIQUE_ROUNDS : MODES.SIMON;
            const machineCount = parseInt(machinesSlider.value);

            // Update labels
            if (mode === MODES.SIMON) {
                sequenceLengthLabel.textContent = '4. Sequence Length';
                modeToggleLabel.textContent = 'Off: Simon Says';
            } else {
                sequenceLengthLabel.textContent = '4. Unique Rounds';
                modeToggleLabel.textContent = 'On: Unique Rounds';
            }
            
            // Machine count is only for Simon Says mode
            machinesSlider.disabled = (mode === MODES.UNIQUE_ROUNDS);
            if (mode === MODES.UNIQUE_ROUNDS) {
                 machinesSlider.value = 1; // Force 1 machine
                 updateMachinesDisplay(1, machinesDisplay);
            }

            // Autoclear is only for Unique Rounds mode
            settingAutoclear.style.display = (mode === MODES.UNIQUE_ROUNDS) ? 'flex' : 'none';

            // Simon-specific settings
            const showSimonSettings = (mode === MODES.SIMON && machineCount > 1);
            settingMultiSequenceGroup.style.display = showSimonSettings ? 'block' : 'none';
        }

        /**
         * Updates visibility of controls on the *main UI* (pads, reset buttons).
         */
        function updateMainUIControlsVisibility() {
            // Show/hide reset buttons on pads
            allResetButtons.forEach(btn => {
                btn.style.display = (settings.currentMode === MODES.UNIQUE_ROUNDS) ? 'block' : 'none';
            });
        }


        // --- App Preferences Modal ---
        function openSettingsModal() {
            // Load current state into settings controls
            playbackSpeedSlider.value = settings.playbackSpeed * 100;
            updatePlaybackSpeedDisplay(settings.playbackSpeed * 100, playbackSpeedDisplay);
            
            showWelcomeToggle.checked = settings.showWelcomeScreen;
            darkModeToggle.checked = settings.isDarkMode;
            speedDeleteToggle.checked = settings.isSpeedDeletingEnabled; 
            autoplayToggle.checked = settings.isAutoplayEnabled;
            audioPlaybackToggle.checked = settings.isAudioPlaybackEnabled; 
            voiceInputToggle.checked = settings.isVoiceInputEnabled;
            hapticsToggle.checked = settings.isHapticsEnabled;

            uiScaleSlider.value = settings.uiScaleMultiplier * 100;
            updateScaleDisplay(settings.uiScaleMultiplier, uiScaleDisplay);
            
            settingsModal.classList.remove('opacity-0', 'pointer-events-none');
            settingsModal.querySelector('div').classList.remove('scale-90');
        }

        function closeSettingsModal() {
            settingsModal.querySelector('div').classList.add('scale-90');
            settingsModal.classList.add('opacity-0');
            setTimeout(() => settingsModal.classList.add('pointer-events-none'), 300);
        }

        // --- Help Modal Logic ---
        function openHelpModal() {
            generateGeneralHelp();
            generateModesHelp();
            generateSettingsHelp();
            generatePromptsHelp(); // Dynamically builds prompts
            if (helpTabNav) {
                helpTabNav.addEventListener('click', handleHelpTabClick);
            }
            switchHelpTab('general');
            helpModal.classList.remove('opacity-0', 'pointer-events-none');
            helpModal.querySelector('div').classList.remove('scale-90');
        }

        function closeHelpModal() {
            if (helpTabNav) {
                helpTabNav.removeEventListener('click', handleHelpTabClick);
            }
            helpModal.querySelector('div').classList.add('scale-90');
            helpModal.classList.add('opacity-0');
            setTimeout(() => helpModal.classList.add('pointer-events-none'), 300);
        }

        function handleHelpTabClick(event) {
            const button = event.target.closest('button[data-tab]');
            if (button) {
                switchHelpTab(button.dataset.tab);
            }
        }

        function switchHelpTab(tabId) {
            if (helpContentContainer) {
                helpContentContainer.querySelectorAll('.help-tab-content').forEach(tab => tab.classList.add('hidden'));
            }
            if (helpTabNav) {
                helpTabNav.querySelectorAll('.help-tab-button').forEach(btn => btn.classList.remove('active-tab'));
            }
            const content = document.getElementById(`help-tab-${tabId}`);
            if (content) content.classList.remove('hidden');
            if (helpTabNav) {
                const button = helpTabNav.querySelector(`button[data-tab="${tabId}"]`);
                if (button) button.classList.add('active-tab');
            }
        }

        function generateGeneralHelp() {
            const container = document.getElementById('help-tab-general');
            if (!container) return;
            container.innerHTML = `
                <h4 class="text-primary-app">App Overview</h4>
                <p>This is a multi-mode sequence tracker. Use the Setup screen (on launch or in Settings) to configure your game.</p>
                <h4 class="text-primary-app">Basic Controls</h4>
                <ul>
                    <li><span class="font-bold">Keypad:</span> Tap the numbers or keys to add to the sequence.</li>
                    <li><span class="font-bold">Play (‚ñ∂):</span> Plays back the current sequence(s).</li>
                    <li><span class="font-bold">Backspace (‚Üê):</span> Removes the last value.</li>
                    <li><span class="font-bold">Settings (‚öôÔ∏è):</span> Opens app preferences (dark mode, speed, etc.).</li>
                    <li><span class="font-bold">RESET:</span> (Unique Rounds Mode Only) Resets the game to Round 1.</li>
                </ul>
            `;
        }

        function generateModesHelp() {
            const container = document.getElementById('help-tab-modes');
            if (!container) return;
            container.innerHTML = `
                <h4 class="text-primary-app">Inputs (The Keypads)</h4>
                <ul>
                    <li><span class="font-bold">9-Key:</span> A 3x3 grid (1-9).</li>
                    <li><span class="font-bold">12-Key:</span> A 4x3 grid (1-12).</li>
                    <li><span class="font-bold">Piano:</span> A 7-key piano with 5 sharps.</li>
                </ul>
                <h4 class="text-primary-app">Modes (The Logic)</h4>
                <ul>
                    <li><span class="font-bold">Simon Says (Default):</span> Standard mode. Enter values up to the Sequence Length. Supports 1-4 machines.</li>
                    <li><span class="font-bold">Unique Rounds:</span> A round-based game. The sequence length increases by one each round, up to the Sequence Length (15, 20, or 25). This mode is always single-machine.</li>
                </ul>
            `;
        }

        function generateSettingsHelp() {
            const container = document.getElementById('help-tab-settings');
            if (!container) return;
            container.innerHTML = `
                <h4 class="text-primary-app">Game Setup</h4>
                <p>Accessed on launch or via the "Change Game Setup" button in Preferences.</p>
                <ul>
                    <li><span class="font-bold">Input:</span> Choose your keypad (9-Key, 12-Key, Piano).</li>
                    <li><span class="font-bold">Game Mode:</span> Toggle between 'Simon Says' (off) and 'Unique Rounds' (on).</li>
                    <li><span class="font-bold">Machines:</span> (Simon Says only) Choose 1-4 machines.</li>
                    <li><span class="font-bold">Sequence Length:</span> Sets the limit (15, 20, 25) for the current mode.</li>
                    <li><span class="font-bold">Multi-Sequence Options:</span> (Simon Says, 2+ machines) Sets chunk size and delay.</li>
                    <li><span class="font-bold">Global Resize:</span> (Top-left of Setup) Changes the entire app's size.</li>
                </ul>
                <h4 class="text-primary-app">App Preferences (‚öôÔ∏è)</h4>
                <ul>
                    <li><span class="font-bold">Playback Speed:</span> A global speed control (50% - 150%).</li>
                    <li><span class="font-bold">Autoplay:</span> Plays the demo automatically after an input.</li>
                    <li><span class="font-bold">Auto Clear/Advance:</span> (Unique Rounds mode only) Automatically clears and advances.</li>
                    <li><span class="font-bold">Sequence Size:</span> Adjusts the visual size of the number boxes.</li>
                    <li><span class="font-bold">Toggles:</span> Dark Mode, Speed Deleting, Audio, Voice Input, Haptics.</li>
                </ul>
            `;
        }

        /**
         * Dynamically generates Virtual Assistant prompts based on current settings.
         */
        function generatePromptsHelp() {
            const container = document.getElementById('help-tab-prompts');
            if (!container) return;
            
            // Get current state
            const state = getCurrentState();
            const mode = settings.currentMode;
            const machineCount = (mode === MODES.SIMON) ? state.machineCount : 1;
            const sequenceLength = settings.sequenceLength;
            const autoClear = settings.isUniqueRoundsAutoClearEnabled;
            const isAutoplay = settings.isAutoplayEnabled;

            let simonPrompt = "";
            let roundsPrompt = "";

            // --- Generate Simon Says Prompt ---
            if (machineCount === 1) {
                simonPrompt = `Let's play 'Simon Says' (1 Machine).
1. I will give you values one at a time.
2. ${isAutoplay ? "The game is **automatic**. After I give you a value, you will **immediately** read the **entire** sequence back to me." : "After I give you values, I will say 'read back'. You will then read the entire sequence back to me."}
3. 'Clear': Delete the last value I gave you.
4. 'Clear all': Delete the entire sequence.
Let's start.`;
            } else {
                simonPrompt = `Let's play 'Simon Says' (${machineCount} Machines).
1. I will give you one value at a time. Assign each value to a machine in a cycle (Machine 1, Machine 2,${machineCount > 2 ? ' Machine 3,' : ''}${machineCount > 3 ? ' Machine 4,' : ''} then back to Machine 1).
2. ${isAutoplay ? `The game is **automatic**. After I give you the value for the *last* machine (Machine ${machineCount}), you will **immediately** read all sequences back to me, in order.` : "After I give you the value for the *last* machine, I will say 'read back'. You will then read all sequences back to me, in order."}
3. After you finish reading, I will give you the next value for Machine 1.
4. 'Clear': Delete the last value I gave you.
5. 'Clear all': Delete all sequences.
Let's start with Machine 1.`;
            }

            // --- Generate Unique Rounds Prompt ---
            roundsPrompt = `Let's play 'Unique Rounds Mode'.
1. We will play from Round 1 up to Round ${sequenceLength}.
2. The sequence length matches the round number (e.g., Round 3 has 3 values).
3. I will give you the values for the current round, one at a time.
4. ${isAutoplay ? `The game is **automatic**. As soon as I give you the **last value for the current round**, you will **immediately** read the full sequence for that round back to me.` : "After I give you the last value for the current round, I will say 'read back'. You will then read the full sequence for that round back to me."}
5. ${isAutoplay && autoClear ? "After you finish reading, you will **automatically** clear the sequence, advance to the next round, and say 'Next Round'." : (isAutoplay && !autoClear ? "After you finish reading, wait for me to say 'next' to clear and advance." : "After you finish reading, wait for me to say 'next' to clear and advance.")}
6. 'Repeat': Read the current round's sequence again.
7. 'Reset': Go back to Round 1.
Let's start with Round 1.`;

            // --- Update the HTML ---
            const simonTextarea = document.getElementById('prompt-simon');
            const roundsTextarea = document.getElementById('prompt-unique-rounds');
            
            if (simonTextarea) simonTextarea.value = simonPrompt.trim();
            if (roundsTextarea) roundsTextarea.value = roundsPrompt.trim();
            
            // Show/hide based on current mode
            const simonGroup = document.getElementById('prompt-simon-group');
            const roundsGroup = document.getElementById('prompt-unique-rounds-group');

            if (simonGroup) simonGroup.style.display = (mode === MODES.SIMON) ? 'block' : 'none';
            if (roundsGroup) roundsGroup.style.display = (mode === MODES.UNIQUE_ROUNDS) ? 'block' : 'none';
            
            // Move the prompt section into the container
            const promptSection = document.getElementById('virtual-assistant-prompts');
            if (promptSection) {
                promptSection.classList.remove('hidden');
                container.appendChild(promptSection);
            }
        }
    
        // --- Share Modal Functions ---
        function openShareModal() {
            closeSettingsModal();
            if (navigator.share) {
                if (nativeShareButton) nativeShareButton.classList.remove('hidden');
            } else {
                if (nativeShareButton) nativeShareButton.classList.add('hidden');
            }
            if (copyLinkButton) {
                copyLinkButton.disabled = false;
                copyLinkButton.classList.remove('!bg-btn-control-green');
                copyLinkButton.innerHTML = `<svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 011-1z"></path><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"></path></svg> Copy Link`;
            }
            shareModal.classList.remove('opacity-0', 'pointer-events-none');
            shareModal.querySelector('div').classList.remove('scale-90');
        }

        function closeShareModal() {
            shareModal.querySelector('div').classList.add('scale-90');
            shareModal.classList.add('opacity-0');
            setTimeout(() => shareModal.classList.add('pointer-events-none'), 300);
        }
    
        // --- UI Update Helpers ---
        function updateTheme(isDark) {
            settings.isDarkMode = isDark;
            document.body.classList.toggle('dark', isDark);
            document.body.classList.toggle('light', !isDark);
            renderSequences();
            saveState();
        }

        /**
         * Applies the global UI scale by setting the root font size.
         */
        function applyGlobalUiScale(scalePercent) {
            if (scalePercent < 50) scalePercent = 50;
            if (scalePercent > 150) scalePercent = 150;
            settings.globalUiScale = scalePercent;
            document.documentElement.style.fontSize = `${scalePercent}%`;
        }

        function updateScaleDisplay(multiplier, displayElement) {
            const percent = Math.round(multiplier * 100);
            if (displayElement) displayElement.textContent = `${percent}%`;
        }

        function updateMachinesDisplay(count, el) {
            if(el) el.textContent = count + (count > 1 ? ' Machines' : ' Machine');
        }
        function updateSequenceLengthDisplay(val, el) {
            if(el) el.textContent = val;
        }
        function updatePlaybackSpeedDisplay(val, el) {
            if(el) el.textContent = val + '%';
        }
        function updateChunkDisplay(val, el) {
            if(el) el.textContent = val;
        }
        function updateDelayDisplay(val, el) {
            if(el) el.textContent = (val / 1000).toFixed(1) + 's';
        }

        /**
         * Switches the active input pad and updates the UI.
         */
        function updateInput(newInput) {
            settings.currentInput = newInput; 
            
            padKey9.style.display = (newInput === INPUTS.KEY9) ? 'block' : 'none';
            padKey12.style.display = (newInput === INPUTS.KEY12) ? 'block' : 'none';
            padPiano.style.display = (newInput === INPUTS.PIANO) ? 'block' : 'none';
            
            // Update settings UI based on new input's state
            if (gameSetupModal && !gameSetupModal.classList.contains('pointer-events-none')) {
                machinesSlider.value = getCurrentState().machineCount;
                updateMachinesDisplay(getCurrentState().machineCount, machinesDisplay);
                updateGameSetupVisibility();
            }

            renderSequences();
            saveState(); 
        }

        function updateVoiceInputVisibility() {
            const isEnabled = settings.isVoiceInputEnabled;
            if (allVoiceInputs) {
                allVoiceInputs.forEach(input => input.classList.toggle('hidden', !isEnabled));
            }
        }

        // --- Generic Modal/Message Box Implementation ---
        function showModal(title, message, onConfirm, confirmText = 'OK', cancelText = 'Cancel') {
            if (!customModal) return;
            
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            
            const newConfirmBtn = modalConfirm.cloneNode(true); 
            newConfirmBtn.textContent = confirmText;
            modalConfirm.parentNode.replaceChild(newConfirmBtn, modalConfirm); 
            modalConfirm = newConfirmBtn; 
            
            const newCancelBtn = modalCancel.cloneNode(true);
            newCancelBtn.textContent = cancelText;
            modalCancel.parentNode.replaceChild(newCancelBtn, modalCancel);
            modalCancel = newCancelBtn; 

            modalConfirm.addEventListener('click', () => { onConfirm(); closeModal(); }); 
            modalCancel.addEventListener('click', closeModal); 
            
            modalCancel.style.display = cancelText ? 'inline-block' : 'none';
            
            modalConfirm.className = 'px-4 py-2 text-white rounded-lg transition-colors font-semibold bg-primary-app hover:bg-secondary-app';
            if (confirmText === 'Restore' || confirmText === 'Reset') {
                 modalConfirm.className = 'px-4 py-2 text-white rounded-lg transition-colors font-semibold bg-btn-control-red hover:bg-btn-control-red-active';
            }
            
            customModal.classList.remove('opacity-0', 'pointer-events-none');
            customModal.querySelector('div').classList.remove('scale-90');
        }

        function closeModal() {
            if (customModal) {
                customModal.querySelector('div').classList.add('scale-90');
                customModal.classList.add('opacity-0');
                setTimeout(() => customModal.classList.add('pointer-events-none'), 300);
            }
        }

        // --- 4. CORE ---

        function vibrate(duration = 10) {
            if (settings.isHapticsEnabled && 'vibrate' in navigator) {
                try {
                    navigator.vibrate(duration);
                } catch (e) {
                    console.warn("Haptic feedback failed.", e);
                }
            }
        }

        /**
         * Adds a value to the current sequence.
         */
        function addValue(value) {
            vibrate();
            
            const state = getCurrentState();
            const mode = settings.currentMode;
            let targetIndex;

            if (mode === MODES.UNIQUE_ROUNDS) {
                if (state.sequences[0].length >= state.currentRound) return; 
                targetIndex = 0;
            } else { // Simon mode
                targetIndex = state.nextSequenceIndex % state.machineCount;
                if (state.sequences[targetIndex] && state.sequences[targetIndex].length >= settings.sequenceLength) return;
            }

            state.sequences[targetIndex].push(value);
            state.nextSequenceIndex++;
            
            renderSequences();
            
            // --- Handle Autoplay Logic ---
            if (settings.isAutoplayEnabled) {
                if (mode === MODES.UNIQUE_ROUNDS) {
                    const sequence = state.sequences[0];
                    if (sequence.length === state.currentRound) {
                        const allKeys = document.querySelectorAll(`#pad-${settings.currentInput} button[data-value]`);
                        allKeys.forEach(key => key.disabled = true);
                        setTimeout(handleUniqueRoundsDemo, 100); 
                    }
                }
                else if (mode === MODES.SIMON) {
                    const justFilledIndex = (state.nextSequenceIndex - 1) % state.machineCount;
                     if (justFilledIndex === state.machineCount - 1) { // Only play after last machine
                         setTimeout(handleSimonDemo, 100);
                    }
                }
            }
            
            saveState();
        }

        /**
         * Removes the last added value.
         */
        function handleBackspace() {
            vibrate(20);
            
            const state = getCurrentState();
            const mode = settings.currentMode;

            // Prevent backspace during demo
            const demoButton = document.querySelector(`#pad-${settings.currentInput} button[data-action="play-demo"]`);
            if (demoButton && demoButton.disabled) return;

            if (state.nextSequenceIndex === 0) return; 
            
            let lastClickTargetIndex;
            if (mode === MODES.UNIQUE_ROUNDS) {
                lastClickTargetIndex = 0;
            } else {
                lastClickTargetIndex = (state.nextSequenceIndex - 1) % state.machineCount;
            }
            
            const targetSet = state.sequences[lastClickTargetIndex];
            
            if (targetSet.length > 0) {
                targetSet.pop();
                state.nextSequenceIndex--; 

                if (mode === MODES.UNIQUE_ROUNDS) {
                     const allKeys = document.querySelectorAll(`#pad-${settings.currentInput} button[data-value]`);
                     allKeys.forEach(key => key.disabled = false);
                }

                renderSequences();
                saveState();
            }
        }

        // --- Backspace Speed Deleting Logic ---
        function stopSpeedDeleting() {
            if (initialDelayTimer) clearTimeout(initialDelayTimer);
            if (speedDeleteInterval) clearInterval(speedDeleteInterval);
            initialDelayTimer = null;
            speedDeleteInterval = null;
            isHoldingBackspace = false; // Reset flag
        }

        function handleBackspaceStart(event) {
            event.preventDefault(); 
            stopSpeedDeleting(); 
            isHoldingBackspace = false; // Not holding *yet*

            const demoButton = document.querySelector(`#pad-${settings.currentInput} button[data-action="play-demo"]`);
            if (demoButton && demoButton.disabled) return;

            initialDelayTimer = setTimeout(() => {
                isHoldingBackspace = true; // Now we are officially holding
                if (settings.isSpeedDeletingEnabled && settings.currentMode !== MODES.UNIQUE_ROUNDS) {
                    handleBackspace();
                    speedDeleteInterval = setInterval(handleBackspace, SPEED_DELETE_INTERVAL_MS);
                }
                initialDelayTimer = null; 
            }, SPEED_DELETE_INITIAL_DELAY);
        }

        function handleBackspaceEnd() {
            const wasHolding = isHoldingBackspace; // Check if we were holding
            
            if (initialDelayTimer !== null) {
                // This means it was a short tap
                stopSpeedDeleting();
                handleBackspace(); 
                return;
            }
            
            stopSpeedDeleting(); // Clears intervals and sets isHoldingBackspace = false

            if (wasHolding && settings.currentMode === MODES.UNIQUE_ROUNDS) {
                // If we *were* holding and are in Unique Rounds mode, reset.
                showModal('Reset Rounds?', 'Are you sure you want to reset to Round 1?', resetUniqueRoundsMode, 'Reset', 'Cancel');
            }
        }

        /**
         * Resets the 'Unique Rounds' mode game to Round 1 for the current input.
         */
        function resetUniqueRoundsMode() {
            const state = getCurrentState();
            state.currentRound = 1;
            state.sequences = Array.from({ length: MAX_MACHINES }, () => []); // Clear all sequences
            state.nextSequenceIndex = 0;
            const allKeys = document.querySelectorAll(`#pad-${settings.currentInput} button[data-value]`);
            if (allKeys) allKeys.forEach(key => key.disabled = false);
            renderSequences();
            saveState();
        }

        function processVoiceTranscript(transcript) {
            if (!transcript) return;
            
            const cleanTranscript = transcript.toLowerCase().replace(/[\.,]/g, '').trim();
            const words = cleanTranscript.split(' ');
            let valuesAdded = 0;
            const currentInput = settings.currentInput;

            for (const word of words) {
                let value = VOICE_VALUE_MAP[word];
                
                if (!value) {
                     const upperWord = word.toUpperCase();
                     if (/^[1-9]$/.test(word) || /^(1[0-2])$/.test(word)) { value = word; } 
                     else if (/^[A-G]$/.test(upperWord) || /^[1-5]$/.test(word)) { value = upperWord; }
                }

                if (value) {
                    if (currentInput === INPUTS.KEY9 && /^[1-9]$/.test(value)) {
                        addValue(value);
                        valuesAdded++;
                    } else if (currentInput === INPUTS.KEY12 && /^(?:[1-9]|1[0-2])$/.test(value)) {
                        addValue(value);
                        valuesAdded++;
                    } else if (currentInput === INPUTS.PIANO && (/^[1-5]$/.test(value) || /^[A-G]$/.test(value))) {
                        addValue(value);
                        valuesAdded++;
                    }
                }
            }
        }

        function handleRestoreDefaults() {
            settings = { ...DEFAULT_SETTINGS };
            appState = {
                [INPUTS.KEY9]: getInitialState(),
                [INPUTS.KEY12]: getInitialState(),
                [INPUTS.PIANO]: getInitialState(),
            };
            
            saveState();
            
            applyGlobalUiScale(settings.globalUiScale); // Apply default scale
            updateTheme(settings.isDarkMode);
            updateVoiceInputVisibility();
            
            // Re-open setup modal to show new defaults
            closeSettingsModal(); 
            setTimeout(openGameSetupModal, 10);
        }

        // --- 5. DEMO ---

        function speak(text) {
            if (!settings.isAudioPlaybackEnabled || !('speechSynthesis'in window)) return;
            try {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US'; 
                utterance.rate = 1.2; 
                utterance.pitch = 1.0;
                window.speechSynthesis.speak(utterance);
            } catch (error) {
                console.error("Speech synthesis failed:", error);
            }
        }

        const getSpeedMultiplier = () => settings.playbackSpeed;

        /**
         * Demo logic for Simon Says mode (handles 1-4 machines).
         */
        function handleSimonDemo() {
            const state = getCurrentState();
            const input = settings.currentInput;
            const padSelector = `#pad-${input}`;
            const flashClass = input === 'piano' ? 'flash' : (input === 'key9' ? 'key9-flash' : 'key12-flash');

            const demoButton = document.querySelector(`${padSelector} button[data-action="play-demo"]`);
            const inputKeys = document.querySelectorAll(`${padSelector} button[data-value]`);
            const speedMultiplier = getSpeedMultiplier();
            const currentDelayMs = DEMO_DELAY_BASE_MS / speedMultiplier;
            const numMachines = state.machineCount;
            const activeSequences = state.sequences.slice(0, numMachines);
            const maxLength = Math.max(...activeSequences.map(s => s.length));
            
            if (maxLength === 0 || (demoButton && demoButton.disabled)) {
                 if (demoButton && demoButton.disabled) return;
                if (!settings.isAutoplayEnabled) {
                    showModal('No Sequence', 'The sequences are empty. Enter some values first!', () => closeModal(), 'OK', '');
                }
                return;
            }
            
            const playlist = [];
            const chunkSize = (numMachines > 1) ? settings.simonChunkSize : maxLength;
            const numChunks = Math.ceil(maxLength / chunkSize);

            for (let chunkNum = 0; chunkNum < numChunks; chunkNum++) {
                for (let seqIndex = 0; seqIndex < numMachines; seqIndex++) {
                    for (let k = 0; k < chunkSize; k++) {
                        const valueIndex = (chunkNum * chunkSize) + k;
                        if (valueIndex < activeSequences[seqIndex].length) {
                            const value = activeSequences[seqIndex][valueIndex];
                            playlist.push({ seqIndex: seqIndex, value: value });
                        }
                    }
                }
            }
            
            if (playlist.length === 0) return;

            if (demoButton) demoButton.disabled = true;
            if (inputKeys) inputKeys.forEach(key => key.disabled = true);
            
            let i = 0;
            const flashDuration = 250 * (speedMultiplier > 1 ? (1/speedMultiplier) : 1); 
            const pauseDuration = currentDelayMs;

            function playNextItem() {
                if (i < playlist.length) {
                    const item = playlist[i];
                    const { seqIndex, value } = item;
                    
                    let key;
                    if (input === 'piano') {
                        key = document.querySelector(`${padSelector} button[data-value="${value}"]`);
                    } else {
                        key = document.querySelector(`${padSelector} button[data-value="${value}"]`);
                    }

                    const seqBox = sequenceContainer.children[seqIndex];
                    const originalClasses = seqBox ? seqBox.dataset.originalClasses : '';
                    
                    if (demoButton) demoButton.innerHTML = String(i + 1);
                    speak(input === 'piano' ? PIANO_SPEAK_MAP[value] || value : value);

                    if (key) {
                        if(input === 'piano') key.classList.add('flash');
                        else key.classList.add(flashClass);
                    }
                    if (seqBox && numMachines > 1) seqBox.className = 'p-4 rounded-xl shadow-md transition-all duration-200 bg-accent-app scale-[1.02] shadow-lg text-gray-900';
                    
                    const nextSeqIndex = (i + 1 < playlist.length) ? playlist[i + 1].seqIndex : -1;
                    let timeBetweenItems = pauseDuration - flashDuration;
                    
                    if (numMachines > 1 && nextSeqIndex !== -1 && seqIndex !== nextSeqIndex) {
                        timeBetweenItems += settings.simonInterSequenceDelay;
                    }
                    
                    setTimeout(() => {
                        if (key) {
                            if(input === 'piano') key.classList.remove('flash');
                            else key.classList.remove(flashClass);
                        }
                        if (seqBox && numMachines > 1) seqBox.className = originalClasses;
                        setTimeout(playNextItem, timeBetweenItems); 
                    }, flashDuration);
                            
                    i++;
                } else {
                    if (demoButton) {
                        demoButton.disabled = false;
                        demoButton.innerHTML = '‚ñ∂'; 
                    }
                    if (inputKeys) inputKeys.forEach(key => key.disabled = false);
                    renderSequences();
                }
            }
            playNextItem();
        }

        // --- 'Unique Rounds' Mode Demo Logic ---

        function advanceToUniqueRound() {
            const state = getCurrentState();
            state.currentRound++;
            if (state.currentRound > settings.sequenceLength) {
                state.currentRound = 1;
                showModal('Complete!', `You finished all ${settings.sequenceLength} rounds. Resetting to Round 1.`, () => closeModal(), 'OK', '');
            }
            renderSequences();
            saveState();
            const allKeys = document.querySelectorAll(`#pad-${settings.currentInput} button[data-value]`);
            if (allKeys) allKeys.forEach(key => key.disabled = false);
        }

        function clearUniqueRoundsSequence() {
            const state = getCurrentState();
            const sequence = state.sequences[0];
            
            if (sequence.length === 0) {
                advanceToUniqueRound();
                return;
            }
            
            if (speedDeleteInterval) clearInterval(speedDeleteInterval);
            speedDeleteInterval = null;

            function rapidDelete() {
                if (sequence.length > 0) {
                    sequence.pop();
                    state.nextSequenceIndex--;
                    renderSequences();
                } else {
                    clearInterval(speedDeleteInterval);
                    speedDeleteInterval = null;
                    saveState(); 
                    advanceToUniqueRound(); 
                }
            }
            setTimeout(() => {
                speedDeleteInterval = setInterval(rapidDelete, SPEED_DELETE_INTERVAL_MS);
            }, 10);
        }

        /**
         * Demo logic for Unique Rounds mode (all inputs)
         */
        function handleUniqueRoundsDemo() {
            const state = getCurrentState();
            const input = settings.currentInput;
            const padSelector = `#pad-${input}`;
            const flashClass = input === 'piano' ? 'flash' : (input === 'key9' ? 'key9-flash' : 'key12-flash');

            const sequenceToPlay = state.sequences[0]; 
            const demoButton = document.querySelector(`${padSelector} button[data-action="play-demo"]`);
            const allKeys = document.querySelectorAll(`${padSelector} button[data-value]`);
            const speedMultiplier = getSpeedMultiplier();
            const currentDelayMs = DEMO_DELAY_BASE_MS / speedMultiplier;

            if (!demoButton) return;

            if (sequenceToPlay.length === 0 || (demoButton.disabled && !settings.isUniqueRoundsAutoClearEnabled) ) {
                if (demoButton.disabled && !settings.isUniqueRoundsAutoClearEnabled) return;
                showModal('No Sequence', 'The sequence is empty. Enter some values first!', () => closeModal(), 'OK', '');
                if (allKeys) allKeys.forEach(key => key.disabled = false);
                return;
            }

            demoButton.disabled = true;
            if (allKeys) allKeys.forEach(key => key.disabled = true);
            
            let i = 0;
            const flashDuration = 250 * (speedMultiplier > 1 ? (1/speedMultiplier) : 1);
            const pauseDuration = currentDelayMs; 

            function playNextNumber() {
                if (i < sequenceToPlay.length) {
                    const value = sequenceToPlay[i]; 
                    
                    let key;
                    if (input === 'piano') {
                        key = document.querySelector(`${padSelector} button[data-value="${value}"]`);
                    } else {
                        key = document.querySelector(`${padSelector} button[data-value="${value}"]`);
                    }

                    demoButton.innerHTML = String(i + 1); 
                    speak(input === 'piano' ? PIANO_SPEAK_MAP[value] || value : value); 
                    
                    if (key) {
                        if(input === 'piano') key.classList.add('flash');
                        else key.classList.add(flashClass);

                        setTimeout(() => {
                            if(input === 'piano') key.classList.remove('flash');
                            else key.classList.remove(flashClass);
                            
                            setTimeout(playNextNumber, pauseDuration - flashDuration);
                        }, flashDuration); 
                    } else {
                        setTimeout(playNextNumber, pauseDuration);
                    }
                    i++;
                } else {
                    demoButton.disabled = false;
                    demoButton.innerHTML = '‚ñ∂'; 
                    
                    if (settings.currentMode === MODES.UNIQUE_ROUNDS && settings.isUniqueRoundsAutoClearEnabled) {
                        setTimeout(clearUniqueRoundsSequence, 300); 
                    } else {
                        if (allKeys) allKeys.forEach(key => key.disabled = false);
                    }
                }
            }
            playNextNumber();
        }

        /**
         * Routes to the correct demo based on current mode.
         */
        function handleCurrentDemo() {
            if (settings.currentMode === MODES.SIMON) {
                handleSimonDemo();
            } else {
                handleUniqueRoundsDemo();
            }
        }

        // --- 6. MAIN ---

        function assignDomElements() {
            // Main UI
            sequenceContainer = document.getElementById('sequence-container');
            
            // Modals
            customModal = document.getElementById('custom-modal');
            modalTitle = document.getElementById('modal-title');
            modalMessage = document.getElementById('modal-message');
            modalConfirm = document.getElementById('modal-confirm');
            modalCancel = document.getElementById('modal-cancel');
            
            shareModal = document.getElementById('share-modal');
            closeShare = document.getElementById('close-share');
            copyLinkButton = document.getElementById('copy-link-button'); 
            nativeShareButton = document.getElementById('native-share-button'); 
            
            gameSetupModal = document.getElementById('game-setup-modal');
            closeGameSetupModalBtn = document.getElementById('close-game-setup-modal');
            dontShowWelcomeToggle = document.getElementById('dont-show-welcome-toggle');
            globalResizeUpBtn = document.getElementById('global-resize-up');
            globalResizeDownBtn = document.getElementById('global-resize-down');

            settingsModal = document.getElementById('settings-modal');
            openGameSetupFromSettings = document.getElementById('open-game-setup-from-settings');
            openShareButton = document.getElementById('open-share-button');
            openHelpButton = document.getElementById('open-help-button');
            closeSettings = document.getElementById('close-settings');
            
            helpModal = document.getElementById('help-modal');
            helpContentContainer = document.getElementById('help-content-container');
            helpTabNav = document.getElementById('help-tab-nav');
            closeHelp = document.getElementById('close-help');

            // --- CONTROLS: Game Setup (in game-setup-modal) ---
            inputSelect = document.getElementById('input-select');
            modeToggle = document.getElementById('mode-toggle');
            modeToggleLabel = document.getElementById('mode-toggle-label');
            
            machinesSlider = document.getElementById('machines-slider');
            machinesDisplay = document.getElementById('machines-display');
            
            sequenceLengthSlider = document.getElementById('sequence-length-slider');
            sequenceLengthDisplay = document.getElementById('sequence-length-display');
            sequenceLengthLabel = document.getElementById('sequence-length-label');
            
            chunkSlider = document.getElementById('chunk-slider');
            chunkDisplay = document.getElementById('chunk-display');
            delaySlider = document.getElementById('delay-slider');
            delayDisplay = document.getElementById('delay-display');
            settingMultiSequenceGroup = document.getElementById('setting-multi-sequence-group');
            
            autoclearToggle = document.getElementById('autoclear-toggle');
            settingAutoclear = document.getElementById('setting-autoclear');

            // --- CONTROLS: App Preferences (in settings-modal) ---
            playbackSpeedSlider = document.getElementById('playback-speed-slider');
            playbackSpeedDisplay = document.getElementById('playback-speed-display');
            autoplayToggle = document.getElementById('autoplay-toggle');
            showWelcomeToggle = document.getElementById('show-welcome-toggle');
            darkModeToggle = document.getElementById('dark-mode-toggle');
            speedDeleteToggle = document.getElementById('speed-delete-toggle');
            audioPlaybackToggle = document.getElementById('audio-playback-toggle');
            voiceInputToggle = document.getElementById('voice-input-toggle');
            hapticsToggle = document.getElementById('haptics-toggle');
            uiScaleSlider = document.getElementById('ui-scale-slider');
            uiScaleDisplay = document.getElementById('ui-scale-display');

            // Pads
            padKey9 = document.getElementById('pad-key9');
            padKey12 = document.getElementById('pad-key12');
            padPiano = document.getElementById('pad-piano');
            allResetButtons = document.querySelectorAll('.reset-button');
            
            allVoiceInputs = document.querySelectorAll('.voice-text-input');
        }

        function initializeListeners() {
            
            document.addEventListener('click', (event) => {
                const button = event.target.closest('button');
                if (!button) return;

                const { value, action, input, copyTarget } = button.dataset;

                if (copyTarget) {
                    const targetElement = document.getElementById(copyTarget);
                    if (targetElement) {
                        targetElement.select();
                        // Use clipboard API for modern browsers
                        if (navigator.clipboard && navigator.clipboard.writeText) {
                            navigator.clipboard.writeText(targetElement.value).then(() => {
                                const originalText = button.innerHTML;
                                button.innerHTML = "Copied!";
                                button.classList.add('!bg-btn-control-green');
                                setTimeout(() => {
                                    button.innerHTML = originalText;
                                    button.classList.remove('!bg-btn-control-green');
                                }, 2000);
                            }).catch(err => console.error('Clipboard API failed: ', err));
                        } else {
                            // Fallback for older browsers
                            try {
                                document.execCommand('copy');
                                const originalText = button.innerHTML;
                                button.innerHTML = "Copied!";
                                button.classList.add('!bg-btn-control-green');
                                setTimeout(() => {
                                    button.innerHTML = originalText;
                                    button.classList.remove('!bg-btn-control-green');
                                }, 2000);
                            } catch (err) {
                                console.error('Fallback copy failed: ', err);
                            }
                        }
                    }
                    return;
                }
                
                if (action === 'open-settings') { openSettingsModal(); return; }
                if (action === 'open-help') { closeSettingsModal(); openHelpModal(); return; }
                if (action === 'open-share') { openShareModal(); return; }

                if (action === 'copy-link') {
                    navigator.clipboard.writeText(window.location.href).then(() => {
                        button.disabled = true;
                        button.classList.add('!bg-btn-control-green');
                        button.innerHTML = `Copied!`;
                    }).catch(err => {
                        console.error('Failed to copy link: ', err);
                        button.innerHTML = 'Error';
                    });
                    return;
                }
                
                if (action === 'native-share') {
                    if (navigator.share) {
                        navigator.share({
                            title: 'Follow Me App',
                            text: 'Check out this sequence app!',
                            url: window.location.href,
                        }).catch((error) => console.log('Error sharing:', error));
                    }
                    return;
                }
                
                if (action === 'restore-defaults') {
                    showModal('Restore Defaults?', 
                              'This will reset all settings and clear all saved sequences. Are you sure?', 
                              handleRestoreDefaults, 
                              'Restore', 
                              'Cancel');
                    return;
                }

                if (action === 'reset-unique-rounds') {
                    showModal('Reset Rounds?', 'Are you sure you want to reset to Round 1?', resetUniqueRoundsMode, 'Reset', 'Cancel');
                    return;
                }
                if (action === 'play-demo' && input === settings.currentInput) {
                    handleCurrentDemo();
                    return;
                }
                
                // Handle Value Clicks
                if (value && input === settings.currentInput) {
                    if (input === INPUTS.KEY9 && /^[1-9]$/.test(value)) {
                        addValue(value);
                    }
                    else if (input === INPUTS.KEY12 && /^(?:[1-9]|1[0-2])$/.test(value)) {
                        addValue(value);
                    }
                    else if (input === INPUTS.PIANO && (/^[1-5]$/.test(value) || /^[A-G]$/.test(value))) {
                        addValue(value);
                    }
                }
            });
            
            // Voice (Text) Input Listeners
            allVoiceInputs.forEach(input => {
                input.addEventListener('input', (event) => {
                    const transcript = event.target.value;
                    if (transcript && transcript.length > 0) {
                        if (event.target.dataset.input === settings.currentInput) {
                            processVoiceTranscript(transcript);
                        }
                        event.target.value = ''; // Clear after processing
                    }
                });
            });
            
            // Backspace Listeners
            document.querySelectorAll('button[data-action="backspace"]').forEach(btn => {
                btn.addEventListener('mousedown', handleBackspaceStart);
                btn.addEventListener('mouseup', handleBackspaceEnd);
                btn.addEventListener('mouseleave', stopSpeedDeleting);
                btn.addEventListener('touchstart', handleBackspaceStart, { passive: false });
                btn.addEventListener('touchend', handleBackspaceEnd);
            });
            
            // --- Modal: Game Setup Listeners ---
            if (closeGameSetupModalBtn) closeGameSetupModalBtn.addEventListener('click', closeGameSetupModal);
            if (dontShowWelcomeToggle) dontShowWelcomeToggle.addEventListener('change', (e) => {
                settings.showWelcomeScreen = !e.target.checked;
                if(showWelcomeToggle) showWelcomeToggle.checked = settings.showWelcomeScreen;
                saveState();
            });

            // Global Resize Listeners
            if (globalResizeUpBtn) globalResizeUpBtn.addEventListener('click', () => {
                applyGlobalUiScale(settings.globalUiScale + 10);
                saveState();
            });
            if (globalResizeDownBtn) globalResizeDownBtn.addEventListener('click', () => {
                applyGlobalUiScale(settings.globalUiScale - 10);
                saveState();
            });

            // Listeners for controls *inside* the setup modal
            if (inputSelect) inputSelect.addEventListener('change', updateGameSetupVisibility);
            if (modeToggle) modeToggle.addEventListener('change', updateGameSetupVisibility);
            if (machinesSlider) {
                machinesSlider.addEventListener('input', (e) => {
                    updateMachinesDisplay(parseInt(e.target.value), machinesDisplay);
                    updateGameSetupVisibility();
                });
            }
            if (sequenceLengthSlider) sequenceLengthSlider.addEventListener('input', (e) => updateSequenceLengthDisplay(parseInt(e.target.value), sequenceLengthDisplay));
            if (chunkSlider) chunkSlider.addEventListener('input', (e) => updateChunkDisplay(parseInt(e.target.value), chunkDisplay));
            if (delaySlider) delaySlider.addEventListener('input', (e) => updateDelayDisplay(parseInt(e.target.value), delayDisplay));


            // --- Modal: App Preferences Listeners ---
            if (closeSettings) closeSettings.addEventListener('click', closeSettingsModal);
            if (openGameSetupFromSettings) openGameSetupFromSettings.addEventListener('click', () => {
                closeSettingsModal();
                openGameSetupModal();
            });

            if (playbackSpeedSlider) playbackSpeedSlider.addEventListener('input', (e) => {
                const val = parseInt(e.target.value);
                settings.playbackSpeed = val / 100.0;
                updatePlaybackSpeedDisplay(val, playbackSpeedDisplay);
                saveState();
            });

            if (autoplayToggle) autoplayToggle.addEventListener('change', (e) => {
                settings.isAutoplayEnabled = e.target.checked;
                saveState();
            });

            if (showWelcomeToggle) showWelcomeToggle.addEventListener('change', (e) => {
                settings.showWelcomeScreen = e.target.checked;
                if(dontShowWelcomeToggle) dontShowWelcomeToggle.checked = !settings.showWelcomeScreen;
                saveState();
            });
            if (darkModeToggle) darkModeToggle.addEventListener('change', (e) => updateTheme(e.target.checked));
            if (speedDeleteToggle) speedDeleteToggle.addEventListener('change', (e) => {
                settings.isSpeedDeletingEnabled = e.target.checked;
                saveState();
            });
            if (audioPlaybackToggle) audioPlaybackToggle.addEventListener('change', (e) => {
                settings.isAudioPlaybackEnabled = e.target.checked;
                if (settings.isAudioPlaybackEnabled) speak("Audio");
                saveState();
            });
            if (voiceInputToggle) voiceInputToggle.addEventListener('change', (e) => {
                settings.isVoiceInputEnabled = e.target.checked;
                updateVoiceInputVisibility();
                saveState();
            });
            if (hapticsToggle) hapticsToggle.addEventListener('change', (e) => {
                settings.isHapticsEnabled = e.target.checked;
                if (settings.isHapticsEnabled) vibrate(50);
                saveState();
            });

            if (uiScaleSlider) {
                uiScaleSlider.addEventListener('input', (event) => {
                    const multiplier = parseInt(event.target.value) / 100;
                    settings.uiScaleMultiplier = multiplier;
                    updateScaleDisplay(multiplier, uiScaleDisplay);
                    renderSequences();
                    saveState();
                });
            }
            
            // --- Other Modals ---
            if (closeHelp) closeHelp.addEventListener('click', closeHelpModal);
            if (closeShare) closeShare.addEventListener('click', closeShareModal); 
        }

        // --- Initialization ---
        window.onload = function() {
            loadState(); 
            assignDomElements();
        
            // Update UI based on loaded state
            applyGlobalUiScale(settings.globalUiScale); // Apply global scale
            updateTheme(settings.isDarkMode);
            updateScaleDisplay(settings.uiScaleMultiplier, uiScaleDisplay);
            updateVoiceInputVisibility();
            
            initializeListeners();
            
            // Load the last used input
            updateInput(settings.currentInput);
            updateMainUIControlsVisibility(); // Call this on load as well
            
            // Show Game Setup Modal if enabled
            if (settings.showWelcomeScreen) {
                setTimeout(openGameSetupModal, 500); 
            }
            
            // Pre-load audio
            if (settings.isAudioPlaybackEnabled) speak(" "); 
        };

    })(); // IIFE wrapper
    </script>

</body>
</html>
